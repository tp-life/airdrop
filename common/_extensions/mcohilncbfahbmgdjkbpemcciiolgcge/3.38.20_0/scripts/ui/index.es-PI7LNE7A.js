import{a as re,b as pe,c as Rs,d as Os,e as gt,f as Be,g as D,h as N,i as Ps,j as at,k as me,l as we,m as He,n as ft,o as Je,p as Ye,q as ce,r as se,s as $i,t as Ds,u as Ls,v as ra}from"./chunk-TNTE7RJI.js";import{a as Vt,b as dt,c as Ts,d as Yn,e as Ns,f as Te,g as yt,h as xs,i as As,j as Cs,k as Wn,l as ea,m as ta,n as sa,o as ia,p as Ge,q as k,r as x,s as Fs}from"./chunk-A7GCUMHR.js";import{b as gl}from"./chunk-2KGWCKRX.js";import{a as Xn,b as Qn,c as Zn}from"./chunk-ZZ2UZY4M.js";import{h as dl}from"./chunk-7EEPBGCR.js";import"./chunk-CY6DCOJP.js";import{a as Jn}from"./chunk-6SIBAM5N.js";import{h as Mt}from"./chunk-MTFM4GGW.js";import{c as Ss,f as O,l as process,m as j,n as q,o as M}from"./chunk-UGZFXKPB.js";var la=Ss((qm,ha)=>{"use strict";j();M();var ca="%[a-f0-9]{2}",aa=new RegExp("("+ca+")|([^%]+?)","gi"),oa=new RegExp("("+ca+")+","gi");function ki(i,e){try{return[decodeURIComponent(i.join(""))]}catch{}if(i.length===1)return i;e=e||1;var t=i.slice(0,e),s=i.slice(e);return Array.prototype.concat.call([],ki(t),ki(s))}function yl(i){try{return decodeURIComponent(i)}catch{for(var e=i.match(aa)||[],t=1;t<e.length;t++)i=ki(e,t).join(""),e=i.match(aa)||[];return i}}function fl(i){for(var e={"%FE%FF":"\uFFFD\uFFFD","%FF%FE":"\uFFFD\uFFFD"},t=oa.exec(i);t;){try{e[t[0]]=decodeURIComponent(t[0])}catch{var s=yl(t[0]);s!==t[0]&&(e[t[0]]=s)}t=oa.exec(i)}e["%C2"]="\uFFFD";for(var r=Object.keys(e),n=0;n<r.length;n++){var a=r[n];i=i.replace(new RegExp(a,"g"),e[a])}return i}ha.exports=function(i){if(typeof i!="string")throw new TypeError("Expected `encodedURI` to be of type `string`, got `"+typeof i+"`");try{return i=i.replace(/\+/g," "),decodeURIComponent(i)}catch{return fl(i)}}});var wa=Ss(ne=>{"use strict";j();M();var ml=Xn(),wl=la(),pa=Qn(),bl=Zn(),El=i=>i==null,ji=Symbol("encodeFragmentIdentifier");function vl(i){switch(i.arrayFormat){case"index":return e=>(t,s)=>{let r=t.length;return s===void 0||i.skipNull&&s===null||i.skipEmptyString&&s===""?t:s===null?[...t,[z(e,i),"[",r,"]"].join("")]:[...t,[z(e,i),"[",z(r,i),"]=",z(s,i)].join("")]};case"bracket":return e=>(t,s)=>s===void 0||i.skipNull&&s===null||i.skipEmptyString&&s===""?t:s===null?[...t,[z(e,i),"[]"].join("")]:[...t,[z(e,i),"[]=",z(s,i)].join("")];case"colon-list-separator":return e=>(t,s)=>s===void 0||i.skipNull&&s===null||i.skipEmptyString&&s===""?t:s===null?[...t,[z(e,i),":list="].join("")]:[...t,[z(e,i),":list=",z(s,i)].join("")];case"comma":case"separator":case"bracket-separator":{let e=i.arrayFormat==="bracket-separator"?"[]=":"=";return t=>(s,r)=>r===void 0||i.skipNull&&r===null||i.skipEmptyString&&r===""?s:(r=r===null?"":r,s.length===0?[[z(t,i),e,z(r,i)].join("")]:[[s,z(r,i)].join(i.arrayFormatSeparator)])}default:return e=>(t,s)=>s===void 0||i.skipNull&&s===null||i.skipEmptyString&&s===""?t:s===null?[...t,z(e,i)]:[...t,[z(e,i),"=",z(s,i)].join("")]}}function _l(i){let e;switch(i.arrayFormat){case"index":return(t,s,r)=>{if(e=/\[(\d*)\]$/.exec(t),t=t.replace(/\[\d*\]$/,""),!e){r[t]=s;return}r[t]===void 0&&(r[t]={}),r[t][e[1]]=s};case"bracket":return(t,s,r)=>{if(e=/(\[\])$/.exec(t),t=t.replace(/\[\]$/,""),!e){r[t]=s;return}if(r[t]===void 0){r[t]=[s];return}r[t]=[].concat(r[t],s)};case"colon-list-separator":return(t,s,r)=>{if(e=/(:list)$/.exec(t),t=t.replace(/:list$/,""),!e){r[t]=s;return}if(r[t]===void 0){r[t]=[s];return}r[t]=[].concat(r[t],s)};case"comma":case"separator":return(t,s,r)=>{let n=typeof s=="string"&&s.includes(i.arrayFormatSeparator),a=typeof s=="string"&&!n&&Ue(s,i).includes(i.arrayFormatSeparator);s=a?Ue(s,i):s;let o=n||a?s.split(i.arrayFormatSeparator).map(c=>Ue(c,i)):s===null?s:Ue(s,i);r[t]=o};case"bracket-separator":return(t,s,r)=>{let n=/(\[\])$/.test(t);if(t=t.replace(/\[\]$/,""),!n){r[t]=s&&Ue(s,i);return}let a=s===null?[]:s.split(i.arrayFormatSeparator).map(o=>Ue(o,i));if(r[t]===void 0){r[t]=a;return}r[t]=[].concat(r[t],a)};default:return(t,s,r)=>{if(r[t]===void 0){r[t]=s;return}r[t]=[].concat(r[t],s)}}}function da(i){if(typeof i!="string"||i.length!==1)throw new TypeError("arrayFormatSeparator must be single character string")}function z(i,e){return e.encode?e.strict?ml(i):encodeURIComponent(i):i}function Ue(i,e){return e.decode?wl(i):i}function ga(i){return Array.isArray(i)?i.sort():typeof i=="object"?ga(Object.keys(i)).sort((e,t)=>Number(e)-Number(t)).map(e=>i[e]):i}function ya(i){let e=i.indexOf("#");return e!==-1&&(i=i.slice(0,e)),i}function Il(i){let e="",t=i.indexOf("#");return t!==-1&&(e=i.slice(t)),e}function fa(i){i=ya(i);let e=i.indexOf("?");return e===-1?"":i.slice(e+1)}function ua(i,e){return e.parseNumbers&&!Number.isNaN(Number(i))&&typeof i=="string"&&i.trim()!==""?i=Number(i):e.parseBooleans&&i!==null&&(i.toLowerCase()==="true"||i.toLowerCase()==="false")&&(i=i.toLowerCase()==="true"),i}function ma(i,e){e=Object.assign({decode:!0,sort:!0,arrayFormat:"none",arrayFormatSeparator:",",parseNumbers:!1,parseBooleans:!1},e),da(e.arrayFormatSeparator);let t=_l(e),s=Object.create(null);if(typeof i!="string"||(i=i.trim().replace(/^[?#&]/,""),!i))return s;for(let r of i.split("&")){if(r==="")continue;let[n,a]=pa(e.decode?r.replace(/\+/g," "):r,"=");a=a===void 0?null:["comma","separator","bracket-separator"].includes(e.arrayFormat)?a:Ue(a,e),t(Ue(n,e),a,s)}for(let r of Object.keys(s)){let n=s[r];if(typeof n=="object"&&n!==null)for(let a of Object.keys(n))n[a]=ua(n[a],e);else s[r]=ua(n,e)}return e.sort===!1?s:(e.sort===!0?Object.keys(s).sort():Object.keys(s).sort(e.sort)).reduce((r,n)=>{let a=s[n];return Boolean(a)&&typeof a=="object"&&!Array.isArray(a)?r[n]=ga(a):r[n]=a,r},Object.create(null))}ne.extract=fa;ne.parse=ma;ne.stringify=(i,e)=>{if(!i)return"";e=Object.assign({encode:!0,strict:!0,arrayFormat:"none",arrayFormatSeparator:","},e),da(e.arrayFormatSeparator);let t=a=>e.skipNull&&El(i[a])||e.skipEmptyString&&i[a]==="",s=vl(e),r={};for(let a of Object.keys(i))t(a)||(r[a]=i[a]);let n=Object.keys(r);return e.sort!==!1&&n.sort(e.sort),n.map(a=>{let o=i[a];return o===void 0?"":o===null?z(a,e):Array.isArray(o)?o.length===0&&e.arrayFormat==="bracket-separator"?z(a,e)+"[]":o.reduce(s(a),[]).join("&"):z(a,e)+"="+z(o,e)}).filter(a=>a.length>0).join("&")};ne.parseUrl=(i,e)=>{e=Object.assign({decode:!0},e);let[t,s]=pa(i,"#");return Object.assign({url:t.split("?")[0]||"",query:ma(fa(i),e)},e&&e.parseFragmentIdentifier&&s?{fragmentIdentifier:Ue(s,e)}:{})};ne.stringifyUrl=(i,e)=>{e=Object.assign({encode:!0,strict:!0,[ji]:!0},e);let t=ya(i.url).split("?")[0]||"",s=ne.extract(i.url),r=ne.parse(s,{sort:!1}),n=Object.assign(r,i.query),a=ne.stringify(n,e);a&&(a=`?${a}`);let o=Il(i.url);return i.fragmentIdentifier&&(o=`#${e[ji]?z(i.fragmentIdentifier,e):i.fragmentIdentifier}`),`${t}${a}${o}`};ne.pick=(i,e,t)=>{t=Object.assign({parseFragmentIdentifier:!0,[ji]:!1},t);let{url:s,query:r,fragmentIdentifier:n}=ne.parseUrl(i,t);return ne.stringifyUrl({url:s,query:bl(r,e),fragmentIdentifier:n},t)};ne.exclude=(i,e,t)=>{let s=Array.isArray(e)?r=>!e.includes(r):(r,n)=>!e(r,n);return ne.pick(i,s,t)}});var bc=Ss((_w,wc)=>{"use strict";j();M();var mc="%[a-f0-9]{2}",yc=new RegExp("("+mc+")|([^%]+?)","gi"),fc=new RegExp("("+mc+")+","gi");function Jr(i,e){try{return[decodeURIComponent(i.join(""))]}catch{}if(i.length===1)return i;e=e||1;var t=i.slice(0,e),s=i.slice(e);return Array.prototype.concat.call([],Jr(t),Jr(s))}function fg(i){try{return decodeURIComponent(i)}catch{for(var e=i.match(yc)||[],t=1;t<e.length;t++)i=Jr(e,t).join(""),e=i.match(yc)||[];return i}}function mg(i){for(var e={"%FE%FF":"\uFFFD\uFFFD","%FF%FE":"\uFFFD\uFFFD"},t=fc.exec(i);t;){try{e[t[0]]=decodeURIComponent(t[0])}catch{var s=fg(t[0]);s!==t[0]&&(e[t[0]]=s)}t=fc.exec(i)}e["%C2"]="\uFFFD";for(var r=Object.keys(e),n=0;n<r.length;n++){var a=r[n];i=i.replace(new RegExp(a,"g"),e[a])}return i}wc.exports=function(i){if(typeof i!="string")throw new TypeError("Expected `encodedURI` to be of type `string`, got `"+typeof i+"`");try{return i=i.replace(/\+/g," "),decodeURIComponent(i)}catch{return mg(i)}}});var Oc=Ss(oe=>{"use strict";j();M();var wg=Xn(),bg=bc(),vc=Qn(),Eg=Zn(),vg=i=>i==null,Yr=Symbol("encodeFragmentIdentifier");function _g(i){switch(i.arrayFormat){case"index":return e=>(t,s)=>{let r=t.length;return s===void 0||i.skipNull&&s===null||i.skipEmptyString&&s===""?t:s===null?[...t,[G(e,i),"[",r,"]"].join("")]:[...t,[G(e,i),"[",G(r,i),"]=",G(s,i)].join("")]};case"bracket":return e=>(t,s)=>s===void 0||i.skipNull&&s===null||i.skipEmptyString&&s===""?t:s===null?[...t,[G(e,i),"[]"].join("")]:[...t,[G(e,i),"[]=",G(s,i)].join("")];case"colon-list-separator":return e=>(t,s)=>s===void 0||i.skipNull&&s===null||i.skipEmptyString&&s===""?t:s===null?[...t,[G(e,i),":list="].join("")]:[...t,[G(e,i),":list=",G(s,i)].join("")];case"comma":case"separator":case"bracket-separator":{let e=i.arrayFormat==="bracket-separator"?"[]=":"=";return t=>(s,r)=>r===void 0||i.skipNull&&r===null||i.skipEmptyString&&r===""?s:(r=r===null?"":r,s.length===0?[[G(t,i),e,G(r,i)].join("")]:[[s,G(r,i)].join(i.arrayFormatSeparator)])}default:return e=>(t,s)=>s===void 0||i.skipNull&&s===null||i.skipEmptyString&&s===""?t:s===null?[...t,G(e,i)]:[...t,[G(e,i),"=",G(s,i)].join("")]}}function Ig(i){let e;switch(i.arrayFormat){case"index":return(t,s,r)=>{if(e=/\[(\d*)\]$/.exec(t),t=t.replace(/\[\d*\]$/,""),!e){r[t]=s;return}r[t]===void 0&&(r[t]={}),r[t][e[1]]=s};case"bracket":return(t,s,r)=>{if(e=/(\[\])$/.exec(t),t=t.replace(/\[\]$/,""),!e){r[t]=s;return}if(r[t]===void 0){r[t]=[s];return}r[t]=[].concat(r[t],s)};case"colon-list-separator":return(t,s,r)=>{if(e=/(:list)$/.exec(t),t=t.replace(/:list$/,""),!e){r[t]=s;return}if(r[t]===void 0){r[t]=[s];return}r[t]=[].concat(r[t],s)};case"comma":case"separator":return(t,s,r)=>{let n=typeof s=="string"&&s.includes(i.arrayFormatSeparator),a=typeof s=="string"&&!n&&Me(s,i).includes(i.arrayFormatSeparator);s=a?Me(s,i):s;let o=n||a?s.split(i.arrayFormatSeparator).map(c=>Me(c,i)):s===null?s:Me(s,i);r[t]=o};case"bracket-separator":return(t,s,r)=>{let n=/(\[\])$/.test(t);if(t=t.replace(/\[\]$/,""),!n){r[t]=s&&Me(s,i);return}let a=s===null?[]:s.split(i.arrayFormatSeparator).map(o=>Me(o,i));if(r[t]===void 0){r[t]=a;return}r[t]=[].concat(r[t],a)};default:return(t,s,r)=>{if(r[t]===void 0){r[t]=s;return}r[t]=[].concat(r[t],s)}}}function _c(i){if(typeof i!="string"||i.length!==1)throw new TypeError("arrayFormatSeparator must be single character string")}function G(i,e){return e.encode?e.strict?wg(i):encodeURIComponent(i):i}function Me(i,e){return e.decode?bg(i):i}function Ic(i){return Array.isArray(i)?i.sort():typeof i=="object"?Ic(Object.keys(i)).sort((e,t)=>Number(e)-Number(t)).map(e=>i[e]):i}function Sc(i){let e=i.indexOf("#");return e!==-1&&(i=i.slice(0,e)),i}function Sg(i){let e="",t=i.indexOf("#");return t!==-1&&(e=i.slice(t)),e}function Rc(i){i=Sc(i);let e=i.indexOf("?");return e===-1?"":i.slice(e+1)}function Ec(i,e){return e.parseNumbers&&!Number.isNaN(Number(i))&&typeof i=="string"&&i.trim()!==""?i=Number(i):e.parseBooleans&&i!==null&&(i.toLowerCase()==="true"||i.toLowerCase()==="false")&&(i=i.toLowerCase()==="true"),i}function Tc(i,e){e=Object.assign({decode:!0,sort:!0,arrayFormat:"none",arrayFormatSeparator:",",parseNumbers:!1,parseBooleans:!1},e),_c(e.arrayFormatSeparator);let t=Ig(e),s=Object.create(null);if(typeof i!="string"||(i=i.trim().replace(/^[?#&]/,""),!i))return s;for(let r of i.split("&")){if(r==="")continue;let[n,a]=vc(e.decode?r.replace(/\+/g," "):r,"=");a=a===void 0?null:["comma","separator","bracket-separator"].includes(e.arrayFormat)?a:Me(a,e),t(Me(n,e),a,s)}for(let r of Object.keys(s)){let n=s[r];if(typeof n=="object"&&n!==null)for(let a of Object.keys(n))n[a]=Ec(n[a],e);else s[r]=Ec(n,e)}return e.sort===!1?s:(e.sort===!0?Object.keys(s).sort():Object.keys(s).sort(e.sort)).reduce((r,n)=>{let a=s[n];return Boolean(a)&&typeof a=="object"&&!Array.isArray(a)?r[n]=Ic(a):r[n]=a,r},Object.create(null))}oe.extract=Rc;oe.parse=Tc;oe.stringify=(i,e)=>{if(!i)return"";e=Object.assign({encode:!0,strict:!0,arrayFormat:"none",arrayFormatSeparator:","},e),_c(e.arrayFormatSeparator);let t=a=>e.skipNull&&vg(i[a])||e.skipEmptyString&&i[a]==="",s=_g(e),r={};for(let a of Object.keys(i))t(a)||(r[a]=i[a]);let n=Object.keys(r);return e.sort!==!1&&n.sort(e.sort),n.map(a=>{let o=i[a];return o===void 0?"":o===null?G(a,e):Array.isArray(o)?o.length===0&&e.arrayFormat==="bracket-separator"?G(a,e)+"[]":o.reduce(s(a),[]).join("&"):G(a,e)+"="+G(o,e)}).filter(a=>a.length>0).join("&")};oe.parseUrl=(i,e)=>{e=Object.assign({decode:!0},e);let[t,s]=vc(i,"#");return Object.assign({url:t.split("?")[0]||"",query:Tc(Rc(i),e)},e&&e.parseFragmentIdentifier&&s?{fragmentIdentifier:Me(s,e)}:{})};oe.stringifyUrl=(i,e)=>{e=Object.assign({encode:!0,strict:!0,[Yr]:!0},e);let t=Sc(i.url).split("?")[0]||"",s=oe.extract(i.url),r=oe.parse(s,{sort:!1}),n=Object.assign(r,i.query),a=oe.stringify(n,e);a&&(a=`?${a}`);let o=Sg(i.url);return i.fragmentIdentifier&&(o=`#${e[Yr]?G(i.fragmentIdentifier,e):i.fragmentIdentifier}`),`${t}${a}${o}`};oe.pick=(i,e,t)=>{t=Object.assign({parseFragmentIdentifier:!0,[Yr]:!1},t);let{url:s,query:r,fragmentIdentifier:n}=oe.parseUrl(i,t);return oe.stringifyUrl({url:s,query:Eg(r,e),fragmentIdentifier:n},t)};oe.exclude=(i,e,t)=>{let s=Array.isArray(e)?r=>!e.includes(r):(r,n)=>!e(r,n);return oe.pick(i,s,t)}});j();M();j();M();j();M();var je=O(Mt());j();M();var na=O(Mt()),Us=class extends re{constructor(e){super(),this.opts=e,this.protocol="wc",this.version=2}};var qs=class extends re{constructor(e,t){super(),this.core=e,this.logger=t,this.records=new Map}},$s=class{constructor(e,t){this.logger=e,this.core=t}},ks=class extends re{constructor(e,t){super(),this.relayer=e,this.logger=t}},js=class extends re{constructor(e){super()}},Ms=class{constructor(e,t,s,r){this.core=e,this.logger=t,this.name=s}};var Vs=class extends re{constructor(e,t){super(),this.relayer=e,this.logger=t}};var Ks=class extends re{constructor(e,t){super(),this.core=e,this.logger=t}};var zs=class{constructor(e,t,s){this.core=e,this.logger=t,this.store=s}},Bs=class{constructor(e,t){this.projectId=e,this.logger=t}},Gs=class{constructor(e,t,s){this.core=e,this.logger=t,this.telemetryEnabled=s}};var Hs=class{constructor(e){this.opts=e,this.protocol="wc",this.version=2}};var Js=class{constructor(e){this.client=e}};var v=O(Vt());j();M();var qe=O(Vt()),$e=O(Cs()),xa=O(Wn()),mt=O(wa()),Vi=O(dl()),Aa=O(gl()),Ki=O(ea()),Ca=O(ta()),Bt=O(Yn()),wt=O(sa()),Ws=O(ia());var Fa=O(Jn());var Sl=":";function Gt(i){let[e,t]=i.split(Sl);return{namespace:e,reference:t}}function Da(i,e){return i.includes(":")?[i]:e.chains||[]}var Rl=Object.defineProperty,ba=Object.getOwnPropertySymbols,Tl=Object.prototype.hasOwnProperty,Ol=Object.prototype.propertyIsEnumerable,Ea=(i,e,t)=>e in i?Rl(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,va=(i,e)=>{for(var t in e||(e={}))Tl.call(e,t)&&Ea(i,t,e[t]);if(ba)for(var t of ba(e))Ol.call(e,t)&&Ea(i,t,e[t]);return i},Pl="ReactNative",ae={reactNative:"react-native",node:"node",browser:"browser",unknown:"unknown"};var Nl="js";function Ht(){return typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"}function ht(){return!(0,$e.getDocument)()&&!!(0,$e.getNavigator)()&&navigator.product===Pl}function bt(){return!Ht()&&!!(0,$e.getNavigator)()&&!!(0,$e.getDocument)()}function Jt(){return ht()?ae.reactNative:Ht()?ae.node:bt()?ae.browser:ae.unknown}function La(){var i;try{return ht()&&typeof globalThis<"u"&&typeof globalThis?.Application<"u"?(i=globalThis.Application)==null?void 0:i.applicationId:void 0}catch{return}}function xl(i,e){let t=mt.parse(i);return t=va(va({},t),e),i=mt.stringify(t),i}function Xs(){return(0,xa.getWindowMetadata)()||{name:"",description:"",url:"",icons:[""]}}function Al(){if(Jt()===ae.reactNative&&typeof globalThis<"u"&&typeof globalThis?.Platform<"u"){let{OS:t,Version:s}=globalThis.Platform;return[t,s].join("-")}let i=As();if(i===null)return"unknown";let e=i.os?i.os.replace(" ","").toLowerCase():"unknown";return i.type==="browser"?[e,i.name,i.version].join("-"):[e,i.version].join("-")}function Cl(){var i;let e=Jt();return e===ae.browser?[e,((i=(0,$e.getLocation)())==null?void 0:i.host)||"unknown"].join(":"):e}function zi(i,e,t){let s=Al(),r=Cl();return[[i,e].join("-"),[Nl,t].join("-"),s,r].join("/")}function Ua({protocol:i,version:e,relayUrl:t,sdkVersion:s,auth:r,projectId:n,useOnCloseEvent:a,bundleId:o}){let c=t.split("?"),h=zi(i,e,s),u={auth:r,ua:h,projectId:n,useOnCloseEvent:a||void 0,origin:o||void 0},l=xl(c[1]||"",u);return c[0]+"?"+l}function ot(i,e){return i.filter(t=>e.includes(t)).length===i.length}function Bi(i){return Object.fromEntries(i.entries())}function Gi(i){return new Map(Object.entries(i))}function ke(i=qe.FIVE_MINUTES,e){let t=(0,qe.toMiliseconds)(i||qe.FIVE_MINUTES),s,r,n;return{resolve:a=>{n&&s&&(clearTimeout(n),s(a))},reject:a=>{n&&r&&(clearTimeout(n),r(a))},done:()=>new Promise((a,o)=>{n=setTimeout(()=>{o(new Error(e))},t),s=a,r=o})}}function lt(i,e,t){return new Promise(async(s,r)=>{let n=setTimeout(()=>r(new Error(t)),e);try{let a=await i;s(a)}catch(a){r(a)}clearTimeout(n)})}function qa(i,e){if(typeof e=="string"&&e.startsWith(`${i}:`))return e;if(i.toLowerCase()==="topic"){if(typeof e!="string")throw new Error('Value must be "string" for expirer target type: topic');return`topic:${e}`}else if(i.toLowerCase()==="id"){if(typeof e!="number")throw new Error('Value must be "number" for expirer target type: id');return`id:${e}`}throw new Error(`Unknown expirer target type: ${i}`)}function $a(i){return qa("topic",i)}function ka(i){return qa("id",i)}function Qs(i){let[e,t]=i.split(":"),s={id:void 0,topic:void 0};if(e==="topic"&&typeof t=="string")s.topic=t;else if(e==="id"&&Number.isInteger(Number(t)))s.id=Number(t);else throw new Error(`Invalid target, expected id:number or topic:string, got ${e}:${t}`);return s}function B(i,e){return(0,qe.fromMiliseconds)((e||Date.now())+(0,qe.toMiliseconds)(i))}function Oe(i){return Date.now()>=(0,qe.toMiliseconds)(i)}function S(i,e){return`${i}${e?`:${e}`:""}`}function Fl(i=[],e=[]){return[...new Set([...i,...e])]}async function ja({id:i,topic:e,wcDeepLink:t}){var s;try{if(!t)return;let r=typeof t=="string"?JSON.parse(t):t,n=r?.href;if(typeof n!="string")return;let a=Dl(n,i,e),o=Jt();if(o===ae.browser){if(!((s=(0,$e.getDocument)())!=null&&s.hasFocus())){console.warn("Document does not have focus, skipping deeplink.");return}a.startsWith("https://")||a.startsWith("http://")?window.open(a,"_blank","noreferrer noopener"):window.open(a,Ll()?"_blank":"_self","noreferrer noopener")}else o===ae.reactNative&&typeof globalThis?.Linking<"u"&&await globalThis.Linking.openURL(a)}catch(r){console.error(r)}}function Dl(i,e,t){let s=`requestId=${e}&sessionTopic=${t}`;i.endsWith("/")&&(i=i.slice(0,-1));let r=`${i}`;if(i.startsWith("https://t.me")){let n=i.includes("?")?"&startapp=":"?startapp=";r=`${r}${n}${Ul(s,!0)}`}else r=`${r}/wc?${s}`;return r}async function Ma(i,e){let t="";try{if(bt()&&(t=localStorage.getItem(e),t))return t;t=await i.getItem(e)}catch(s){console.error(s)}return t}function Hi(i,e){if(!i.includes(e))return null;let t=i.split(/([&,?,=])/),s=t.indexOf(e);return t[s+2]}function Ji(){return typeof crypto<"u"&&crypto!=null&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/gu,i=>{let e=Math.random()*16|0;return(i==="x"?e:e&3|8).toString(16)})}function Yt(){return typeof process<"u"&&process.env.IS_VITEST==="true"}function Ll(){return typeof window<"u"&&(!!window.TelegramWebviewProxy||!!window.Telegram||!!window.TelegramWebviewProxyProto)}function Ul(i,e=!1){let t=q.Buffer.from(i).toString("base64");return e?t.replace(/[=]/g,""):t}function Va(i){return q.Buffer.from(i,"base64").toString("utf-8")}var ql="https://rpc.walletconnect.org/v1";async function $l(i,e,t,s,r,n){switch(t.t){case"eip191":return kl(i,e,t.s);case"eip1271":return await jl(i,e,t.s,s,r,n);default:throw new Error(`verifySignature failed: Attempted to verify CacaoSignature with unknown type: ${t.t}`)}}function kl(i,e,t){return(0,Aa.recoverAddress)((0,Vi.hashMessage)(e),t).toLowerCase()===i.toLowerCase()}async function jl(i,e,t,s,r,n){let a=Gt(s);if(!a.namespace||!a.reference)throw new Error(`isValidEip1271Signature failed: chainId must be in CAIP-2 format, received: ${s}`);try{let o="0x1626ba7e",c="0000000000000000000000000000000000000000000000000000000000000040",h="0000000000000000000000000000000000000000000000000000000000000041",u=t.substring(2),l=(0,Vi.hashMessage)(e).substring(2),g=o+l+c+h+u,d=await fetch(`${n||ql}/?chainId=${s}&projectId=${r}`,{method:"POST",body:JSON.stringify({id:Ml(),jsonrpc:"2.0",method:"eth_call",params:[{to:i,data:g},"latest"]})}),{result:p}=await d.json();return p?p.slice(0,o.length).toLowerCase()===o.toLowerCase():!1}catch(o){return console.error("isValidEip1271Signature: ",o),!1}}function Ml(){return Date.now()+Math.floor(Math.random()*1e3)}var Vl=Object.defineProperty,Kl=Object.defineProperties,zl=Object.getOwnPropertyDescriptors,_a=Object.getOwnPropertySymbols,Bl=Object.prototype.hasOwnProperty,Gl=Object.prototype.propertyIsEnumerable,Ia=(i,e,t)=>e in i?Vl(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,Hl=(i,e)=>{for(var t in e||(e={}))Bl.call(e,t)&&Ia(i,t,e[t]);if(_a)for(var t of _a(e))Gl.call(e,t)&&Ia(i,t,e[t]);return i},Jl=(i,e)=>Kl(i,zl(e)),Yl="did:pkh:",Yi=i=>i?.split(":"),Wl=i=>{let e=i&&Yi(i);if(e)return i.includes(Yl)?e[3]:e[1]},Zs=i=>{let e=i&&Yi(i);if(e)return e[2]+":"+e[3]},Wt=i=>{let e=i&&Yi(i);if(e)return e.pop()};async function Wi(i){let{cacao:e,projectId:t}=i,{s,p:r}=e,n=Xi(r,r.iss),a=Wt(r.iss);return await $l(a,n,s,Zs(r.iss),t)}var Xi=(i,e)=>{let t=`${i.domain} wants you to sign in with your Ethereum account:`,s=Wt(e);if(!i.aud&&!i.uri)throw new Error("Either `aud` or `uri` is required to construct the message");let r=i.statement||void 0,n=`URI: ${i.aud||i.uri}`,a=`Version: ${i.version}`,o=`Chain ID: ${Wl(e)}`,c=`Nonce: ${i.nonce}`,h=`Issued At: ${i.iat}`,u=i.exp?`Expiration Time: ${i.exp}`:void 0,l=i.nbf?`Not Before: ${i.nbf}`:void 0,g=i.requestId?`Request ID: ${i.requestId}`:void 0,d=i.resources?`Resources:${i.resources.map(y=>`
- ${y}`).join("")}`:void 0,p=Xt(i.resources);if(p){let y=zt(p);r=iu(r,y)}return[t,s,"",r,"",n,a,o,c,h,u,l,g,d].filter(y=>y!=null).join(`
`)};function Xl(i){return q.Buffer.from(JSON.stringify(i)).toString("base64")}function Ql(i){return JSON.parse(q.Buffer.from(i,"base64").toString("utf-8"))}function ct(i){if(!i)throw new Error("No recap provided, value is undefined");if(!i.att)throw new Error("No `att` property found");let e=Object.keys(i.att);if(!(e!=null&&e.length))throw new Error("No resources found in `att` property");e.forEach(t=>{let s=i.att[t];if(Array.isArray(s))throw new Error(`Resource must be an object: ${t}`);if(typeof s!="object")throw new Error(`Resource must be an object: ${t}`);if(!Object.keys(s).length)throw new Error(`Resource object is empty: ${t}`);Object.keys(s).forEach(r=>{let n=s[r];if(!Array.isArray(n))throw new Error(`Ability limits ${r} must be an array of objects, found: ${n}`);if(!n.length)throw new Error(`Value of ${r} is empty array, must be an array with objects`);n.forEach(a=>{if(typeof a!="object")throw new Error(`Ability limits (${r}) must be an array of objects, found: ${a}`)})})})}function Zl(i,e,t,s={}){return t?.sort((r,n)=>r.localeCompare(n)),{att:{[i]:eu(e,t,s)}}}function eu(i,e,t={}){e=e?.sort((r,n)=>r.localeCompare(n));let s=e.map(r=>({[`${i}/${r}`]:[t]}));return Object.assign({},...s)}function Ka(i){return ct(i),`urn:recap:${Xl(i).replace(/=/g,"")}`}function zt(i){let e=Ql(i.replace("urn:recap:",""));return ct(e),e}function za(i,e,t){let s=Zl(i,e,t);return Ka(s)}function tu(i){return i&&i.includes("urn:recap:")}function Ba(i,e){let t=zt(i),s=zt(e),r=su(t,s);return Ka(r)}function su(i,e){ct(i),ct(e);let t=Object.keys(i.att).concat(Object.keys(e.att)).sort((r,n)=>r.localeCompare(n)),s={att:{}};return t.forEach(r=>{var n,a;Object.keys(((n=i.att)==null?void 0:n[r])||{}).concat(Object.keys(((a=e.att)==null?void 0:a[r])||{})).sort((o,c)=>o.localeCompare(c)).forEach(o=>{var c,h;s.att[r]=Jl(Hl({},s.att[r]),{[o]:((c=i.att[r])==null?void 0:c[o])||((h=e.att[r])==null?void 0:h[o])})})}),s}function iu(i="",e){ct(e);let t="I further authorize the stated URI to perform the following actions on my behalf: ";if(i.includes(t))return i;let s=[],r=0;Object.keys(e.att).forEach(o=>{let c=Object.keys(e.att[o]).map(l=>({ability:l.split("/")[0],action:l.split("/")[1]}));c.sort((l,g)=>l.action.localeCompare(g.action));let h={};c.forEach(l=>{h[l.ability]||(h[l.ability]=[]),h[l.ability].push(l.action)});let u=Object.keys(h).map(l=>(r++,`(${r}) '${l}': '${h[l].join("', '")}' for '${o}'.`));s.push(u.join(", ").replace(".,","."))});let n=s.join(" "),a=`${t}${n}`;return`${i?i+" ":""}${a}`}function Qi(i){var e;let t=zt(i);ct(t);let s=(e=t.att)==null?void 0:e.eip155;return s?Object.keys(s).map(r=>r.split("/")[1]):[]}function Zi(i){let e=zt(i);ct(e);let t=[];return Object.values(e.att).forEach(s=>{Object.values(s).forEach(r=>{var n;(n=r?.[0])!=null&&n.chains&&t.push(r[0].chains)})}),[...new Set(t.flat())]}function Xt(i){if(!i)return;let e=i?.[i.length-1];return tu(e)?e:void 0}var Ga="base10",Q="base16",Pe="base64pad",Et="base64url",Qt="utf8",Ha=0,be=1,vt=2,ru=0,Sa=1,Kt=12,er=32;function Ja(){let i=Ws.generateKeyPair();return{privateKey:x(i.secretKey,Q),publicKey:x(i.publicKey,Q)}}function ei(){let i=(0,Bt.randomBytes)(er);return x(i,Q)}function Ya(i,e){let t=Ws.sharedKey(k(i,Q),k(e,Q),!0),s=new Ca.HKDF(wt.SHA256,t).expand(er);return x(s,Q)}function _t(i){let e=(0,wt.hash)(k(i,Q));return x(e,Q)}function Ee(i){let e=(0,wt.hash)(k(i,Qt));return x(e,Q)}function Wa(i){return k(`${i}`,Ga)}function We(i){return Number(x(i,Ga))}function Xa(i){let e=Wa(typeof i.type<"u"?i.type:Ha);if(We(e)===be&&typeof i.senderPublicKey>"u")throw new Error("Missing sender public key for type 1 envelope");let t=typeof i.senderPublicKey<"u"?k(i.senderPublicKey,Q):void 0,s=typeof i.iv<"u"?k(i.iv,Q):(0,Bt.randomBytes)(Kt),r=new Ki.ChaCha20Poly1305(k(i.symKey,Q)).seal(s,k(i.message,Qt));return to({type:e,sealed:r,iv:s,senderPublicKey:t,encoding:i.encoding})}function Qa(i,e){let t=Wa(vt),s=(0,Bt.randomBytes)(Kt),r=k(i,Qt);return to({type:t,sealed:r,iv:s,encoding:e})}function Za(i){let e=new Ki.ChaCha20Poly1305(k(i.symKey,Q)),{sealed:t,iv:s}=It({encoded:i.encoded,encoding:i?.encoding}),r=e.open(s,t);if(r===null)throw new Error("Failed to decrypt");return x(r,Qt)}function eo(i,e){let{sealed:t}=It({encoded:i,encoding:e});return x(t,Qt)}function to(i){let{encoding:e=Pe}=i;if(We(i.type)===vt)return x(Ge([i.type,i.sealed]),e);if(We(i.type)===be){if(typeof i.senderPublicKey>"u")throw new Error("Missing sender public key for type 1 envelope");return x(Ge([i.type,i.senderPublicKey,i.iv,i.sealed]),e)}return x(Ge([i.type,i.iv,i.sealed]),e)}function It(i){let{encoded:e,encoding:t=Pe}=i,s=k(e,t),r=s.slice(ru,Sa),n=Sa;if(We(r)===be){let h=n+er,u=h+Kt,l=s.slice(n,h),g=s.slice(h,u),d=s.slice(u);return{type:r,sealed:d,iv:g,senderPublicKey:l}}if(We(r)===vt){let h=s.slice(n),u=(0,Bt.randomBytes)(Kt);return{type:r,sealed:h,iv:u}}let a=n+Kt,o=s.slice(n,a),c=s.slice(a);return{type:r,sealed:c,iv:o}}function so(i,e){let t=It({encoded:i,encoding:e?.encoding});return tr({type:We(t.type),senderPublicKey:typeof t.senderPublicKey<"u"?x(t.senderPublicKey,Q):void 0,receiverPublicKey:e?.receiverPublicKey})}function tr(i){let e=i?.type||Ha;if(e===be){if(typeof i?.senderPublicKey>"u")throw new Error("missing sender public key");if(typeof i?.receiverPublicKey>"u")throw new Error("missing receiver public key")}return{type:e,senderPublicKey:i?.senderPublicKey,receiverPublicKey:i?.receiverPublicKey}}function sr(i){return i.type===be&&typeof i.senderPublicKey=="string"&&typeof i.receiverPublicKey=="string"}function ir(i){return i.type===vt}function nu(i){return new Fa.ec("p256").keyFromPublic({x:q.Buffer.from(i.x,"base64").toString("hex"),y:q.Buffer.from(i.y,"base64").toString("hex")},"hex")}function au(i){let e=i.replace(/-/g,"+").replace(/_/g,"/"),t=e.length%4;return t>0&&(e+="=".repeat(4-t)),e}function ou(i){return q.Buffer.from(au(i),"base64")}function io(i,e){let[t,s,r]=i.split("."),n=ou(r);if(n.length!==64)throw new Error("Invalid signature length");let a=n.slice(0,32).toString("hex"),o=n.slice(32,64).toString("hex"),c=`${t}.${s}`,h=new wt.SHA256().update(q.Buffer.from(c)).digest(),u=nu(e),l=q.Buffer.from(h).toString("hex");if(!u.verify(l,{r:a,s:o}))throw new Error("Invalid signature");return Te(i).payload}var cu="irn";function ti(i){return i?.relay||{protocol:cu}}function St(i){let e=Fs[i];if(typeof e>"u")throw new Error(`Relay Protocol not supported: ${i}`);return e}var hu=Object.defineProperty,lu=Object.defineProperties,uu=Object.getOwnPropertyDescriptors,Ra=Object.getOwnPropertySymbols,pu=Object.prototype.hasOwnProperty,du=Object.prototype.propertyIsEnumerable,Ta=(i,e,t)=>e in i?hu(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,Oa=(i,e)=>{for(var t in e||(e={}))pu.call(e,t)&&Ta(i,t,e[t]);if(Ra)for(var t of Ra(e))du.call(e,t)&&Ta(i,t,e[t]);return i},gu=(i,e)=>lu(i,uu(e));function yu(i,e="-"){let t={},s="relay"+e;return Object.keys(i).forEach(r=>{if(r.startsWith(s)){let n=r.replace(s,""),a=i[r];t[n]=a}}),t}function rr(i){if(!i.includes("wc:")){let c=Va(i);c!=null&&c.includes("wc:")&&(i=c)}i=i.includes("wc://")?i.replace("wc://",""):i,i=i.includes("wc:")?i.replace("wc:",""):i;let e=i.indexOf(":"),t=i.indexOf("?")!==-1?i.indexOf("?"):void 0,s=i.substring(0,e),r=i.substring(e+1,t).split("@"),n=typeof t<"u"?i.substring(t):"",a=mt.parse(n),o=typeof a.methods=="string"?a.methods.split(","):void 0;return{protocol:s,topic:fu(r[0]),version:parseInt(r[1],10),symKey:a.symKey,relay:yu(a),methods:o,expiryTimestamp:a.expiryTimestamp?parseInt(a.expiryTimestamp,10):void 0}}function fu(i){return i.startsWith("//")?i.substring(2):i}function mu(i,e="-"){let t="relay",s={};return Object.keys(i).forEach(r=>{let n=t+e+r;i[r]&&(s[n]=i[r])}),s}function nr(i){return`${i.protocol}:${i.topic}@${i.version}?`+mt.stringify(Oa(gu(Oa({symKey:i.symKey},mu(i.relay)),{expiryTimestamp:i.expiryTimestamp}),i.methods?{methods:i.methods.join(",")}:{}))}function Zt(i,e,t){return`${i}?wc_ev=${t}&topic=${e}`}function Rt(i){let e=[];return i.forEach(t=>{let[s,r]=t.split(":");e.push(`${s}:${r}`)}),e}function wu(i){let e=[];return Object.values(i).forEach(t=>{e.push(...Rt(t.accounts))}),e}function bu(i,e){let t=[];return Object.values(i).forEach(s=>{Rt(s.accounts).includes(e)&&t.push(...s.methods)}),t}function Eu(i,e){let t=[];return Object.values(i).forEach(s=>{Rt(s.accounts).includes(e)&&t.push(...s.events)}),t}function vu(i){let e={};return i?.forEach(t=>{let[s,r]=t.split(":");e[s]||(e[s]={accounts:[],chains:[],events:[]}),e[s].accounts.push(t),e[s].chains.push(`${s}:${r}`)}),e}function ar(i,e){e=e.map(s=>s.replace("did:pkh:",""));let t=vu(e);for(let[s,r]of Object.entries(t))r.methods?r.methods=Fl(r.methods,i):r.methods=i,r.events=["chainChanged","accountsChanged"];return t}var _u={INVALID_METHOD:{message:"Invalid method.",code:1001},INVALID_EVENT:{message:"Invalid event.",code:1002},INVALID_UPDATE_REQUEST:{message:"Invalid update request.",code:1003},INVALID_EXTEND_REQUEST:{message:"Invalid extend request.",code:1004},INVALID_SESSION_SETTLE_REQUEST:{message:"Invalid session settle request.",code:1005},UNAUTHORIZED_METHOD:{message:"Unauthorized method.",code:3001},UNAUTHORIZED_EVENT:{message:"Unauthorized event.",code:3002},UNAUTHORIZED_UPDATE_REQUEST:{message:"Unauthorized update request.",code:3003},UNAUTHORIZED_EXTEND_REQUEST:{message:"Unauthorized extend request.",code:3004},USER_REJECTED:{message:"User rejected.",code:5e3},USER_REJECTED_CHAINS:{message:"User rejected chains.",code:5001},USER_REJECTED_METHODS:{message:"User rejected methods.",code:5002},USER_REJECTED_EVENTS:{message:"User rejected events.",code:5003},UNSUPPORTED_CHAINS:{message:"Unsupported chains.",code:5100},UNSUPPORTED_METHODS:{message:"Unsupported methods.",code:5101},UNSUPPORTED_EVENTS:{message:"Unsupported events.",code:5102},UNSUPPORTED_ACCOUNTS:{message:"Unsupported accounts.",code:5103},UNSUPPORTED_NAMESPACE_KEY:{message:"Unsupported namespace key.",code:5104},USER_DISCONNECTED:{message:"User disconnected.",code:6e3},SESSION_SETTLEMENT_FAILED:{message:"Session settlement failed.",code:7e3},WC_METHOD_UNSUPPORTED:{message:"Unsupported wc_ method.",code:10001}},Iu={NOT_INITIALIZED:{message:"Not initialized.",code:1},NO_MATCHING_KEY:{message:"No matching key.",code:2},RESTORE_WILL_OVERRIDE:{message:"Restore will override.",code:3},RESUBSCRIBED:{message:"Resubscribed.",code:4},MISSING_OR_INVALID:{message:"Missing or invalid.",code:5},EXPIRED:{message:"Expired.",code:6},UNKNOWN_TYPE:{message:"Unknown type.",code:7},MISMATCHED_TOPIC:{message:"Mismatched topic.",code:8},NON_CONFORMING_NAMESPACES:{message:"Non conforming namespaces.",code:9}};function f(i,e){let{message:t,code:s}=Iu[i];return{message:e?`${t} ${e}`:t,code:s}}function L(i,e){let{message:t,code:s}=_u[i];return{message:e?`${t} ${e}`:t,code:s}}function Tt(i,e){return Array.isArray(i)?typeof e<"u"&&i.length?i.every(e):!0:!1}function es(i){return Object.getPrototypeOf(i)===Object.prototype&&Object.keys(i).length}function Y(i){return typeof i>"u"}function V(i,e){return e&&Y(i)?!0:typeof i=="string"&&!!i.trim().length}function or(i,e){return e&&Y(i)?!0:typeof i=="number"&&!isNaN(i)}function ro(i,e){let{requiredNamespaces:t}=e,s=Object.keys(i.namespaces),r=Object.keys(t),n=!0;return ot(r,s)?(s.forEach(a=>{let{accounts:o,methods:c,events:h}=i.namespaces[a],u=Rt(o),l=t[a];(!ot(Da(a,l),u)||!ot(l.methods,c)||!ot(l.events,h))&&(n=!1)}),n):!1}function Ys(i){return V(i,!1)&&i.includes(":")?i.split(":").length===2:!1}function Su(i){if(V(i,!1)&&i.includes(":")){let e=i.split(":");if(e.length===3){let t=e[0]+":"+e[1];return!!e[2]&&Ys(t)}}return!1}function no(i){function e(t){try{return typeof new URL(t)<"u"}catch{return!1}}try{if(V(i,!1)){if(e(i))return!0;let t=Va(i);return e(t)}}catch{}return!1}function ao(i){var e;return(e=i?.proposer)==null?void 0:e.publicKey}function oo(i){return i?.topic}function co(i,e){let t=null;return V(i?.publicKey,!1)||(t=f("MISSING_OR_INVALID",`${e} controller public key should be a string`)),t}function Pa(i){let e=!0;return Tt(i)?i.length&&(e=i.every(t=>V(t,!1))):e=!1,e}function Ru(i,e,t){let s=null;return Tt(e)&&e.length?e.forEach(r=>{s||Ys(r)||(s=L("UNSUPPORTED_CHAINS",`${t}, chain ${r} should be a string and conform to "namespace:chainId" format`))}):Ys(i)||(s=L("UNSUPPORTED_CHAINS",`${t}, chains must be defined as "namespace:chainId" e.g. "eip155:1": {...} in the namespace key OR as an array of CAIP-2 chainIds e.g. eip155: { chains: ["eip155:1", "eip155:5"] }`)),s}function Tu(i,e,t){let s=null;return Object.entries(i).forEach(([r,n])=>{if(s)return;let a=Ru(r,Da(r,n),`${e} ${t}`);a&&(s=a)}),s}function Ou(i,e){let t=null;return Tt(i)?i.forEach(s=>{t||Su(s)||(t=L("UNSUPPORTED_ACCOUNTS",`${e}, account ${s} should be a string and conform to "namespace:chainId:address" format`))}):t=L("UNSUPPORTED_ACCOUNTS",`${e}, accounts should be an array of strings conforming to "namespace:chainId:address" format`),t}function Pu(i,e){let t=null;return Object.values(i).forEach(s=>{if(t)return;let r=Ou(s?.accounts,`${e} namespace`);r&&(t=r)}),t}function Nu(i,e){let t=null;return Pa(i?.methods)?Pa(i?.events)||(t=L("UNSUPPORTED_EVENTS",`${e}, events should be an array of strings or empty array for no events`)):t=L("UNSUPPORTED_METHODS",`${e}, methods should be an array of strings or empty array for no methods`),t}function ho(i,e){let t=null;return Object.values(i).forEach(s=>{if(t)return;let r=Nu(s,`${e}, namespace`);r&&(t=r)}),t}function lo(i,e,t){let s=null;if(i&&es(i)){let r=ho(i,e);r&&(s=r);let n=Tu(i,e,t);n&&(s=n)}else s=f("MISSING_OR_INVALID",`${e}, ${t} should be an object with data`);return s}function si(i,e){let t=null;if(i&&es(i)){let s=ho(i,e);s&&(t=s);let r=Pu(i,e);r&&(t=r)}else t=f("MISSING_OR_INVALID",`${e}, namespaces should be an object with data`);return t}function cr(i){return V(i.protocol,!0)}function uo(i,e){let t=!1;return e&&!i?t=!0:i&&Tt(i)&&i.length&&i.forEach(s=>{t=cr(s)}),t}function po(i){return typeof i=="number"}function Z(i){return typeof i<"u"&&typeof i!==null}function go(i){return!(!i||typeof i!="object"||!i.code||!or(i.code,!1)||!i.message||!V(i.message,!1))}function yo(i){return!(Y(i)||!V(i.method,!1))}function fo(i){return!(Y(i)||Y(i.result)&&Y(i.error)||!or(i.id,!1)||!V(i.jsonrpc,!1))}function mo(i){return!(Y(i)||!V(i.name,!1))}function hr(i,e){return!(!Ys(e)||!wu(i).includes(e))}function wo(i,e,t){return V(t,!1)?bu(i,e).includes(t):!1}function bo(i,e,t){return V(t,!1)?Eu(i,e).includes(t):!1}function lr(i,e,t){let s=null,r=xu(i),n=Au(e),a=Object.keys(r),o=Object.keys(n),c=Na(Object.keys(i)),h=Na(Object.keys(e)),u=c.filter(l=>!h.includes(l));return u.length&&(s=f("NON_CONFORMING_NAMESPACES",`${t} namespaces keys don't satisfy requiredNamespaces.
      Required: ${u.toString()}
      Received: ${Object.keys(e).toString()}`)),ot(a,o)||(s=f("NON_CONFORMING_NAMESPACES",`${t} namespaces chains don't satisfy required namespaces.
      Required: ${a.toString()}
      Approved: ${o.toString()}`)),Object.keys(e).forEach(l=>{if(!l.includes(":")||s)return;let g=Rt(e[l].accounts);g.includes(l)||(s=f("NON_CONFORMING_NAMESPACES",`${t} namespaces accounts don't satisfy namespace accounts for ${l}
        Required: ${l}
        Approved: ${g.toString()}`))}),a.forEach(l=>{s||(ot(r[l].methods,n[l].methods)?ot(r[l].events,n[l].events)||(s=f("NON_CONFORMING_NAMESPACES",`${t} namespaces events don't satisfy namespace events for ${l}`)):s=f("NON_CONFORMING_NAMESPACES",`${t} namespaces methods don't satisfy namespace methods for ${l}`))}),s}function xu(i){let e={};return Object.keys(i).forEach(t=>{var s;t.includes(":")?e[t]=i[t]:(s=i[t].chains)==null||s.forEach(r=>{e[r]={methods:i[t].methods,events:i[t].events}})}),e}function Na(i){return[...new Set(i.map(e=>e.includes(":")?e.split(":")[0]:e))]}function Au(i){let e={};return Object.keys(i).forEach(t=>{t.includes(":")?e[t]=i[t]:Rt(i[t].accounts)?.forEach(r=>{e[r]={accounts:i[t].accounts.filter(n=>n.includes(`${r}:`)),methods:i[t].methods,events:i[t].events}})}),e}function Eo(i,e){return or(i,!1)&&i<=e.max&&i>=e.min}function ur(){let i=Jt();return new Promise(e=>{switch(i){case ae.browser:e(Cu());break;case ae.reactNative:e(Fu());break;case ae.node:e(Du());break;default:e(!0)}})}function Cu(){return bt()&&navigator?.onLine}async function Fu(){return ht()&&typeof globalThis<"u"&&globalThis!=null&&globalThis.NetInfo?(await globalThis?.NetInfo.fetch())?.isConnected:!0}function Du(){return!0}function vo(i){switch(Jt()){case ae.browser:Lu(i);break;case ae.reactNative:Uu(i);break;case ae.node:break}}function Lu(i){!ht()&&bt()&&(window.addEventListener("online",()=>i(!0)),window.addEventListener("offline",()=>i(!1)))}function Uu(i){ht()&&typeof globalThis<"u"&&globalThis!=null&&globalThis.NetInfo&&globalThis?.NetInfo.addEventListener(e=>i(e?.isConnected))}var Mi={},Xe=class{static get(e){return Mi[e]}static set(e,t){Mi[e]=t}static delete(e){delete Mi[e]}};var Ko=O(ra()),zo=O(Cs()),Bo="wc",Go=2,Ur="core",Ae=`${Bo}@2:${Ur}:`,$u={name:Ur,logger:"error"},ku={database:":memory:"},ju="crypto",_o="client_ed25519_seed",Mu=v.ONE_DAY,Vu="keychain",Ku="0.3",zu="messages",Bu="0.3",Gu=v.SIX_HOURS,Hu="publisher",qr="irn",Ju="error",Ho="wss://relay.walletconnect.org",Yu="relayer",ee={message:"relayer_message",message_ack:"relayer_message_ack",connect:"relayer_connect",disconnect:"relayer_disconnect",error:"relayer_error",connection_stalled:"relayer_connection_stalled",transport_closed:"relayer_transport_closed",publish:"relayer_publish"},Wu="_subscription",de={payload:"payload",connect:"connect",disconnect:"disconnect",error:"error"},Xu=.1;var gr="2.17.1";var $={link_mode:"link_mode",relay:"relay"},Qu="0.3",Zu="WALLETCONNECT_CLIENT_ID",Io="WALLETCONNECT_LINK_MODE_APPS",Ne={created:"subscription_created",deleted:"subscription_deleted",expired:"subscription_expired",disabled:"subscription_disabled",sync:"subscription_sync",resubscribed:"subscription_resubscribed"};var ep="subscription",tp="0.3",sp=v.FIVE_SECONDS*1e3,ip="pairing",rp="0.3";var ts={wc_pairingDelete:{req:{ttl:v.ONE_DAY,prompt:!1,tag:1e3},res:{ttl:v.ONE_DAY,prompt:!1,tag:1001}},wc_pairingPing:{req:{ttl:v.THIRTY_SECONDS,prompt:!1,tag:1002},res:{ttl:v.THIRTY_SECONDS,prompt:!1,tag:1003}},unregistered_method:{req:{ttl:v.ONE_DAY,prompt:!1,tag:0},res:{ttl:v.ONE_DAY,prompt:!1,tag:0}}},Qe={create:"pairing_create",expire:"pairing_expire",delete:"pairing_delete",ping:"pairing_ping"},ve={created:"history_created",updated:"history_updated",deleted:"history_deleted",sync:"history_sync"},np="history",ap="0.3",op="expirer",he={created:"expirer_created",deleted:"expirer_deleted",expired:"expirer_expired",sync:"expirer_sync"},cp="0.3";var hp="verify-api",lp="https://verify.walletconnect.com",Jo="https://verify.walletconnect.org",Ot=Jo,up=`${Ot}/v3`,pp=[lp,Jo],dp="echo",gp="https://echo.walletconnect.com";var _e={pairing_started:"pairing_started",pairing_uri_validation_success:"pairing_uri_validation_success",pairing_uri_not_expired:"pairing_uri_not_expired",store_new_pairing:"store_new_pairing",subscribing_pairing_topic:"subscribing_pairing_topic",subscribe_pairing_topic_success:"subscribe_pairing_topic_success",existing_pairing:"existing_pairing",pairing_not_expired:"pairing_not_expired",emit_inactive_pairing:"emit_inactive_pairing",emit_session_proposal:"emit_session_proposal",subscribing_to_pairing_topic:"subscribing_to_pairing_topic"},xe={no_wss_connection:"no_wss_connection",no_internet_connection:"no_internet_connection",malformed_pairing_uri:"malformed_pairing_uri",active_pairing_already_exists:"active_pairing_already_exists",subscribe_pairing_topic_failure:"subscribe_pairing_topic_failure",pairing_expired:"pairing_expired",proposal_expired:"proposal_expired",proposal_listener_not_found:"proposal_listener_not_found"},ge={session_approve_started:"session_approve_started",proposal_not_expired:"proposal_not_expired",session_namespaces_validation_success:"session_namespaces_validation_success",create_session_topic:"create_session_topic",subscribing_session_topic:"subscribing_session_topic",subscribe_session_topic_success:"subscribe_session_topic_success",publishing_session_approve:"publishing_session_approve",session_approve_publish_success:"session_approve_publish_success",store_session:"store_session",publishing_session_settle:"publishing_session_settle",session_settle_publish_success:"session_settle_publish_success"},Ze={no_internet_connection:"no_internet_connection",no_wss_connection:"no_wss_connection",proposal_expired:"proposal_expired",subscribe_session_topic_failure:"subscribe_session_topic_failure",session_approve_publish_failure:"session_approve_publish_failure",session_settle_publish_failure:"session_settle_publish_failure",session_approve_namespace_validation_failure:"session_approve_namespace_validation_failure",proposal_not_found:"proposal_not_found"},et={authenticated_session_approve_started:"authenticated_session_approve_started",authenticated_session_not_expired:"authenticated_session_not_expired",chains_caip2_compliant:"chains_caip2_compliant",chains_evm_compliant:"chains_evm_compliant",create_authenticated_session_topic:"create_authenticated_session_topic",cacaos_verified:"cacaos_verified",store_authenticated_session:"store_authenticated_session",subscribing_authenticated_session_topic:"subscribing_authenticated_session_topic",subscribe_authenticated_session_topic_success:"subscribe_authenticated_session_topic_success",publishing_authenticated_session_approve:"publishing_authenticated_session_approve",authenticated_session_approve_publish_success:"authenticated_session_approve_publish_success"},Pt={no_internet_connection:"no_internet_connection",no_wss_connection:"no_wss_connection",missing_session_authenticate_request:"missing_session_authenticate_request",session_authenticate_request_expired:"session_authenticate_request_expired",chains_caip2_compliant_failure:"chains_caip2_compliant_failure",chains_evm_compliant_failure:"chains_evm_compliant_failure",invalid_cacao:"invalid_cacao",subscribe_authenticated_session_topic_failure:"subscribe_authenticated_session_topic_failure",authenticated_session_approve_publish_failure:"authenticated_session_approve_publish_failure",authenticated_session_pending_request_not_found:"authenticated_session_pending_request_not_found"},yp=.1,fp="event-client",mp=86400,wp="https://pulse.walletconnect.org/batch";function bp(i,e){if(i.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),s=0;s<t.length;s++)t[s]=255;for(var r=0;r<i.length;r++){var n=i.charAt(r),a=n.charCodeAt(0);if(t[a]!==255)throw new TypeError(n+" is ambiguous");t[a]=r}var o=i.length,c=i.charAt(0),h=Math.log(o)/Math.log(256),u=Math.log(256)/Math.log(o);function l(p){if(p instanceof Uint8Array||(ArrayBuffer.isView(p)?p=new Uint8Array(p.buffer,p.byteOffset,p.byteLength):Array.isArray(p)&&(p=Uint8Array.from(p))),!(p instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(p.length===0)return"";for(var y=0,w=0,m=0,b=p.length;m!==b&&p[m]===0;)m++,y++;for(var P=(b-m)*u+1>>>0,E=new Uint8Array(P);m!==b;){for(var I=p[m],F=0,C=P-1;(I!==0||F<w)&&C!==-1;C--,F++)I+=256*E[C]>>>0,E[C]=I%o>>>0,I=I/o>>>0;if(I!==0)throw new Error("Non-zero carry");w=F,m++}for(var R=P-w;R!==P&&E[R]===0;)R++;for(var ue=c.repeat(y);R<P;++R)ue+=i.charAt(E[R]);return ue}function g(p){if(typeof p!="string")throw new TypeError("Expected String");if(p.length===0)return new Uint8Array;var y=0;if(p[y]!==" "){for(var w=0,m=0;p[y]===c;)w++,y++;for(var b=(p.length-y)*h+1>>>0,P=new Uint8Array(b);p[y];){var E=t[p.charCodeAt(y)];if(E===255)return;for(var I=0,F=b-1;(E!==0||I<m)&&F!==-1;F--,I++)E+=o*P[F]>>>0,P[F]=E%256>>>0,E=E/256>>>0;if(E!==0)throw new Error("Non-zero carry");m=I,y++}if(p[y]!==" "){for(var C=b-m;C!==b&&P[C]===0;)C++;for(var R=new Uint8Array(w+(b-C)),ue=w;C!==b;)R[ue++]=P[C++];return R}}}function d(p){var y=g(p);if(y)return y;throw new Error(`Non-${e} character`)}return{encode:l,decodeUnsafe:g,decode:d}}var Ep=bp,vp=Ep,Yo=i=>{if(i instanceof Uint8Array&&i.constructor.name==="Uint8Array")return i;if(i instanceof ArrayBuffer)return new Uint8Array(i);if(ArrayBuffer.isView(i))return new Uint8Array(i.buffer,i.byteOffset,i.byteLength);throw new Error("Unknown type, must be binary type")},_p=i=>new TextEncoder().encode(i),Ip=i=>new TextDecoder().decode(i),yr=class{constructor(e,t,s){this.name=e,this.prefix=t,this.baseEncode=s}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},fr=class{constructor(e,t,s){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=s}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return Wo(this,e)}},mr=class{constructor(e){this.decoders=e}or(e){return Wo(this,e)}decode(e){let t=e[0],s=this.decoders[t];if(s)return s.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}},Wo=(i,e)=>new mr({...i.decoders||{[i.prefix]:i},...e.decoders||{[e.prefix]:e}}),wr=class{constructor(e,t,s,r){this.name=e,this.prefix=t,this.baseEncode=s,this.baseDecode=r,this.encoder=new yr(e,t,s),this.decoder=new fr(e,t,r)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}},ii=({name:i,prefix:e,encode:t,decode:s})=>new wr(i,e,t,s),ns=({prefix:i,name:e,alphabet:t})=>{let{encode:s,decode:r}=vp(t,e);return ii({prefix:i,name:e,encode:s,decode:n=>Yo(r(n))})},Sp=(i,e,t,s)=>{let r={};for(let u=0;u<e.length;++u)r[e[u]]=u;let n=i.length;for(;i[n-1]==="=";)--n;let a=new Uint8Array(n*t/8|0),o=0,c=0,h=0;for(let u=0;u<n;++u){let l=r[i[u]];if(l===void 0)throw new SyntaxError(`Non-${s} character`);c=c<<t|l,o+=t,o>=8&&(o-=8,a[h++]=255&c>>o)}if(o>=t||255&c<<8-o)throw new SyntaxError("Unexpected end of data");return a},Rp=(i,e,t)=>{let s=e[e.length-1]==="=",r=(1<<t)-1,n="",a=0,o=0;for(let c=0;c<i.length;++c)for(o=o<<8|i[c],a+=8;a>t;)a-=t,n+=e[r&o>>a];if(a&&(n+=e[r&o<<t-a]),s)for(;n.length*t&7;)n+="=";return n},W=({name:i,prefix:e,bitsPerChar:t,alphabet:s})=>ii({prefix:e,name:i,encode(r){return Rp(r,s,t)},decode(r){return Sp(r,s,t,i)}}),Tp=ii({prefix:"\0",name:"identity",encode:i=>Ip(i),decode:i=>_p(i)}),Op=Object.freeze({__proto__:null,identity:Tp}),Pp=W({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),Np=Object.freeze({__proto__:null,base2:Pp}),xp=W({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),Ap=Object.freeze({__proto__:null,base8:xp}),Cp=ns({prefix:"9",name:"base10",alphabet:"0123456789"}),Fp=Object.freeze({__proto__:null,base10:Cp}),Dp=W({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),Lp=W({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),Up=Object.freeze({__proto__:null,base16:Dp,base16upper:Lp}),qp=W({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),$p=W({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),kp=W({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),jp=W({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),Mp=W({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),Vp=W({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),Kp=W({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),zp=W({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),Bp=W({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),Gp=Object.freeze({__proto__:null,base32:qp,base32upper:$p,base32pad:kp,base32padupper:jp,base32hex:Mp,base32hexupper:Vp,base32hexpad:Kp,base32hexpadupper:zp,base32z:Bp}),Hp=ns({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),Jp=ns({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),Yp=Object.freeze({__proto__:null,base36:Hp,base36upper:Jp}),Wp=ns({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),Xp=ns({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),Qp=Object.freeze({__proto__:null,base58btc:Wp,base58flickr:Xp}),Zp=W({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),ed=W({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),td=W({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),sd=W({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),id=Object.freeze({__proto__:null,base64:Zp,base64pad:ed,base64url:td,base64urlpad:sd}),Xo=Array.from("\u{1F680}\u{1FA90}\u2604\u{1F6F0}\u{1F30C}\u{1F311}\u{1F312}\u{1F313}\u{1F314}\u{1F315}\u{1F316}\u{1F317}\u{1F318}\u{1F30D}\u{1F30F}\u{1F30E}\u{1F409}\u2600\u{1F4BB}\u{1F5A5}\u{1F4BE}\u{1F4BF}\u{1F602}\u2764\u{1F60D}\u{1F923}\u{1F60A}\u{1F64F}\u{1F495}\u{1F62D}\u{1F618}\u{1F44D}\u{1F605}\u{1F44F}\u{1F601}\u{1F525}\u{1F970}\u{1F494}\u{1F496}\u{1F499}\u{1F622}\u{1F914}\u{1F606}\u{1F644}\u{1F4AA}\u{1F609}\u263A\u{1F44C}\u{1F917}\u{1F49C}\u{1F614}\u{1F60E}\u{1F607}\u{1F339}\u{1F926}\u{1F389}\u{1F49E}\u270C\u2728\u{1F937}\u{1F631}\u{1F60C}\u{1F338}\u{1F64C}\u{1F60B}\u{1F497}\u{1F49A}\u{1F60F}\u{1F49B}\u{1F642}\u{1F493}\u{1F929}\u{1F604}\u{1F600}\u{1F5A4}\u{1F603}\u{1F4AF}\u{1F648}\u{1F447}\u{1F3B6}\u{1F612}\u{1F92D}\u2763\u{1F61C}\u{1F48B}\u{1F440}\u{1F62A}\u{1F611}\u{1F4A5}\u{1F64B}\u{1F61E}\u{1F629}\u{1F621}\u{1F92A}\u{1F44A}\u{1F973}\u{1F625}\u{1F924}\u{1F449}\u{1F483}\u{1F633}\u270B\u{1F61A}\u{1F61D}\u{1F634}\u{1F31F}\u{1F62C}\u{1F643}\u{1F340}\u{1F337}\u{1F63B}\u{1F613}\u2B50\u2705\u{1F97A}\u{1F308}\u{1F608}\u{1F918}\u{1F4A6}\u2714\u{1F623}\u{1F3C3}\u{1F490}\u2639\u{1F38A}\u{1F498}\u{1F620}\u261D\u{1F615}\u{1F33A}\u{1F382}\u{1F33B}\u{1F610}\u{1F595}\u{1F49D}\u{1F64A}\u{1F639}\u{1F5E3}\u{1F4AB}\u{1F480}\u{1F451}\u{1F3B5}\u{1F91E}\u{1F61B}\u{1F534}\u{1F624}\u{1F33C}\u{1F62B}\u26BD\u{1F919}\u2615\u{1F3C6}\u{1F92B}\u{1F448}\u{1F62E}\u{1F646}\u{1F37B}\u{1F343}\u{1F436}\u{1F481}\u{1F632}\u{1F33F}\u{1F9E1}\u{1F381}\u26A1\u{1F31E}\u{1F388}\u274C\u270A\u{1F44B}\u{1F630}\u{1F928}\u{1F636}\u{1F91D}\u{1F6B6}\u{1F4B0}\u{1F353}\u{1F4A2}\u{1F91F}\u{1F641}\u{1F6A8}\u{1F4A8}\u{1F92C}\u2708\u{1F380}\u{1F37A}\u{1F913}\u{1F619}\u{1F49F}\u{1F331}\u{1F616}\u{1F476}\u{1F974}\u25B6\u27A1\u2753\u{1F48E}\u{1F4B8}\u2B07\u{1F628}\u{1F31A}\u{1F98B}\u{1F637}\u{1F57A}\u26A0\u{1F645}\u{1F61F}\u{1F635}\u{1F44E}\u{1F932}\u{1F920}\u{1F927}\u{1F4CC}\u{1F535}\u{1F485}\u{1F9D0}\u{1F43E}\u{1F352}\u{1F617}\u{1F911}\u{1F30A}\u{1F92F}\u{1F437}\u260E\u{1F4A7}\u{1F62F}\u{1F486}\u{1F446}\u{1F3A4}\u{1F647}\u{1F351}\u2744\u{1F334}\u{1F4A3}\u{1F438}\u{1F48C}\u{1F4CD}\u{1F940}\u{1F922}\u{1F445}\u{1F4A1}\u{1F4A9}\u{1F450}\u{1F4F8}\u{1F47B}\u{1F910}\u{1F92E}\u{1F3BC}\u{1F975}\u{1F6A9}\u{1F34E}\u{1F34A}\u{1F47C}\u{1F48D}\u{1F4E3}\u{1F942}"),rd=Xo.reduce((i,e,t)=>(i[t]=e,i),[]),nd=Xo.reduce((i,e,t)=>(i[e.codePointAt(0)]=t,i),[]);function ad(i){return i.reduce((e,t)=>(e+=rd[t],e),"")}function od(i){let e=[];for(let t of i){let s=nd[t.codePointAt(0)];if(s===void 0)throw new Error(`Non-base256emoji character: ${t}`);e.push(s)}return new Uint8Array(e)}var cd=ii({prefix:"\u{1F680}",name:"base256emoji",encode:ad,decode:od}),hd=Object.freeze({__proto__:null,base256emoji:cd}),ld=Qo,So=128,ud=127,pd=~ud,dd=Math.pow(2,31);function Qo(i,e,t){e=e||[],t=t||0;for(var s=t;i>=dd;)e[t++]=i&255|So,i/=128;for(;i&pd;)e[t++]=i&255|So,i>>>=7;return e[t]=i|0,Qo.bytes=t-s+1,e}var gd=br,yd=128,Ro=127;function br(i,s){var t=0,s=s||0,r=0,n=s,a,o=i.length;do{if(n>=o)throw br.bytes=0,new RangeError("Could not decode varint");a=i[n++],t+=r<28?(a&Ro)<<r:(a&Ro)*Math.pow(2,r),r+=7}while(a>=yd);return br.bytes=n-s,t}var fd=Math.pow(2,7),md=Math.pow(2,14),wd=Math.pow(2,21),bd=Math.pow(2,28),Ed=Math.pow(2,35),vd=Math.pow(2,42),_d=Math.pow(2,49),Id=Math.pow(2,56),Sd=Math.pow(2,63),Rd=function(i){return i<fd?1:i<md?2:i<wd?3:i<bd?4:i<Ed?5:i<vd?6:i<_d?7:i<Id?8:i<Sd?9:10},Td={encode:ld,decode:gd,encodingLength:Rd},Zo=Td,To=(i,e,t=0)=>(Zo.encode(i,e,t),e),Oo=i=>Zo.encodingLength(i),Er=(i,e)=>{let t=e.byteLength,s=Oo(i),r=s+Oo(t),n=new Uint8Array(r+t);return To(i,n,0),To(t,n,s),n.set(e,r),new vr(i,t,e,n)},vr=class{constructor(e,t,s,r){this.code=e,this.size=t,this.digest=s,this.bytes=r}},ec=({name:i,code:e,encode:t})=>new _r(i,e,t),_r=class{constructor(e,t,s){this.name=e,this.code=t,this.encode=s}digest(e){if(e instanceof Uint8Array){let t=this.encode(e);return t instanceof Uint8Array?Er(this.code,t):t.then(s=>Er(this.code,s))}else throw Error("Unknown type, must be binary type")}},tc=i=>async e=>new Uint8Array(await crypto.subtle.digest(i,e)),Od=ec({name:"sha2-256",code:18,encode:tc("SHA-256")}),Pd=ec({name:"sha2-512",code:19,encode:tc("SHA-512")}),Nd=Object.freeze({__proto__:null,sha256:Od,sha512:Pd}),sc=0,xd="identity",ic=Yo,Ad=i=>Er(sc,ic(i)),Cd={code:sc,name:xd,encode:ic,digest:Ad},Fd=Object.freeze({__proto__:null,identity:Cd});new TextEncoder,new TextDecoder;var Po={...Op,...Np,...Ap,...Fp,...Up,...Gp,...Yp,...Qp,...id,...hd};({...Nd,...Fd});function Dd(i=0){return globalThis.Buffer!=null&&globalThis.Buffer.allocUnsafe!=null?globalThis.Buffer.allocUnsafe(i):new Uint8Array(i)}function rc(i,e,t,s){return{name:i,prefix:e,encoder:{name:i,prefix:e,encode:t},decoder:{decode:s}}}var No=rc("utf8","u",i=>"u"+new TextDecoder("utf8").decode(i),i=>new TextEncoder().encode(i.substring(1))),pr=rc("ascii","a",i=>{let e="a";for(let t=0;t<i.length;t++)e+=String.fromCharCode(i[t]);return e},i=>{i=i.substring(1);let e=Dd(i.length);for(let t=0;t<i.length;t++)e[t]=i.charCodeAt(t);return e}),Ld={utf8:No,"utf-8":No,hex:Po.base16,latin1:pr,ascii:pr,binary:pr,...Po};function Ud(i,e="utf8"){let t=Ld[e];if(!t)throw new Error(`Unsupported encoding "${e}"`);return(e==="utf8"||e==="utf-8")&&globalThis.Buffer!=null&&globalThis.Buffer.from!=null?globalThis.Buffer.from(i,"utf8"):t.decoder.decode(`${t.prefix}${i}`)}var Ir=class{constructor(e,t){this.core=e,this.logger=t,this.keychain=new Map,this.name=Vu,this.version=Ku,this.initialized=!1,this.storagePrefix=Ae,this.init=async()=>{if(!this.initialized){let s=await this.getKeyChain();typeof s<"u"&&(this.keychain=s),this.initialized=!0}},this.has=s=>(this.isInitialized(),this.keychain.has(s)),this.set=async(s,r)=>{this.isInitialized(),this.keychain.set(s,r),await this.persist()},this.get=s=>{this.isInitialized();let r=this.keychain.get(s);if(typeof r>"u"){let{message:n}=f("NO_MATCHING_KEY",`${this.name}: ${s}`);throw new Error(n)}return r},this.del=async s=>{this.isInitialized(),this.keychain.delete(s),await this.persist()},this.core=e,this.logger=N(t,this.name)}get context(){return D(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name}async setKeyChain(e){await this.core.storage.setItem(this.storageKey,Bi(e))}async getKeyChain(){let e=await this.core.storage.getItem(this.storageKey);return typeof e<"u"?Gi(e):void 0}async persist(){await this.setKeyChain(this.keychain)}isInitialized(){if(!this.initialized){let{message:e}=f("NOT_INITIALIZED",this.name);throw new Error(e)}}},Sr=class{constructor(e,t,s){this.core=e,this.logger=t,this.name=ju,this.randomSessionIdentifier=ei(),this.initialized=!1,this.init=async()=>{this.initialized||(await this.keychain.init(),this.initialized=!0)},this.hasKeys=r=>(this.isInitialized(),this.keychain.has(r)),this.getClientId=async()=>{this.isInitialized();let r=await this.getClientSeed(),n=yt(r);return Ns(n.publicKey)},this.generateKeyPair=()=>{this.isInitialized();let r=Ja();return this.setPrivateKey(r.publicKey,r.privateKey)},this.signJWT=async r=>{this.isInitialized();let n=await this.getClientSeed(),a=yt(n),o=this.randomSessionIdentifier;return await xs(o,r,Mu,a)},this.generateSharedKey=(r,n,a)=>{this.isInitialized();let o=this.getPrivateKey(r),c=Ya(o,n);return this.setSymKey(c,a)},this.setSymKey=async(r,n)=>{this.isInitialized();let a=n||_t(r);return await this.keychain.set(a,r),a},this.deleteKeyPair=async r=>{this.isInitialized(),await this.keychain.del(r)},this.deleteSymKey=async r=>{this.isInitialized(),await this.keychain.del(r)},this.encode=async(r,n,a)=>{this.isInitialized();let o=tr(a),c=Ts(n);if(ir(o))return Qa(c,a?.encoding);if(sr(o)){let g=o.senderPublicKey,d=o.receiverPublicKey;r=await this.generateSharedKey(g,d)}let h=this.getSymKey(r),{type:u,senderPublicKey:l}=o;return Xa({type:u,symKey:h,message:c,senderPublicKey:l,encoding:a?.encoding})},this.decode=async(r,n,a)=>{this.isInitialized();let o=so(n,a);if(ir(o)){let c=eo(n,a?.encoding);return dt(c)}if(sr(o)){let c=o.receiverPublicKey,h=o.senderPublicKey;r=await this.generateSharedKey(c,h)}try{let c=this.getSymKey(r),h=Za({symKey:c,encoded:n,encoding:a?.encoding});return dt(h)}catch(c){this.logger.error(`Failed to decode message from topic: '${r}', clientId: '${await this.getClientId()}'`),this.logger.error(c)}},this.getPayloadType=(r,n=Pe)=>{let a=It({encoded:r,encoding:n});return We(a.type)},this.getPayloadSenderPublicKey=(r,n=Pe)=>{let a=It({encoded:r,encoding:n});return a.senderPublicKey?x(a.senderPublicKey,Q):void 0},this.core=e,this.logger=N(t,this.name),this.keychain=s||new Ir(this.core,this.logger)}get context(){return D(this.logger)}async setPrivateKey(e,t){return await this.keychain.set(e,t),e}getPrivateKey(e){return this.keychain.get(e)}async getClientSeed(){let e="";try{e=this.keychain.get(_o)}catch{e=ei(),await this.keychain.set(_o,e)}return Ud(e,"base16")}getSymKey(e){return this.keychain.get(e)}isInitialized(){if(!this.initialized){let{message:e}=f("NOT_INITIALIZED",this.name);throw new Error(e)}}},Rr=class extends $s{constructor(e,t){super(e,t),this.logger=e,this.core=t,this.messages=new Map,this.name=zu,this.version=Bu,this.initialized=!1,this.storagePrefix=Ae,this.init=async()=>{if(!this.initialized){this.logger.trace("Initialized");try{let s=await this.getRelayerMessages();typeof s<"u"&&(this.messages=s),this.logger.debug(`Successfully Restored records for ${this.name}`),this.logger.trace({type:"method",method:"restore",size:this.messages.size})}catch(s){this.logger.debug(`Failed to Restore records for ${this.name}`),this.logger.error(s)}finally{this.initialized=!0}}},this.set=async(s,r)=>{this.isInitialized();let n=Ee(r),a=this.messages.get(s);return typeof a>"u"&&(a={}),typeof a[n]<"u"||(a[n]=r,this.messages.set(s,a),await this.persist()),n},this.get=s=>{this.isInitialized();let r=this.messages.get(s);return typeof r>"u"&&(r={}),r},this.has=(s,r)=>{this.isInitialized();let n=this.get(s),a=Ee(r);return typeof n[a]<"u"},this.del=async s=>{this.isInitialized(),this.messages.delete(s),await this.persist()},this.logger=N(e,this.name),this.core=t}get context(){return D(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name}async setRelayerMessages(e){await this.core.storage.setItem(this.storageKey,Bi(e))}async getRelayerMessages(){let e=await this.core.storage.getItem(this.storageKey);return typeof e<"u"?Gi(e):void 0}async persist(){await this.setRelayerMessages(this.messages)}isInitialized(){if(!this.initialized){let{message:e}=f("NOT_INITIALIZED",this.name);throw new Error(e)}}},Tr=class extends ks{constructor(e,t){super(e,t),this.relayer=e,this.logger=t,this.events=new je.EventEmitter,this.name=Hu,this.queue=new Map,this.publishTimeout=(0,v.toMiliseconds)(v.ONE_MINUTE),this.failedPublishTimeout=(0,v.toMiliseconds)(v.ONE_SECOND),this.needsTransportRestart=!1,this.publish=async(s,r,n)=>{var a;this.logger.debug("Publishing Payload"),this.logger.trace({type:"method",method:"publish",params:{topic:s,message:r,opts:n}});let o=n?.ttl||Gu,c=ti(n),h=n?.prompt||!1,u=n?.tag||0,l=n?.id||me().toString(),g={topic:s,message:r,opts:{ttl:o,relay:c,prompt:h,tag:u,id:l,attestation:n?.attestation}},d=`Failed to publish payload, please try again. id:${l} tag:${u}`,p=Date.now(),y,w=1;try{for(;y===void 0;){if(Date.now()-p>this.publishTimeout)throw new Error(d);this.logger.trace({id:l,attempts:w},`publisher.publish - attempt ${w}`),y=await await lt(this.rpcPublish(s,r,o,c,h,u,l,n?.attestation).catch(m=>this.logger.warn(m)),this.publishTimeout,d),w++,y||await new Promise(m=>setTimeout(m,this.failedPublishTimeout))}this.relayer.events.emit(ee.publish,g),this.logger.debug("Successfully Published Payload"),this.logger.trace({type:"method",method:"publish",params:{id:l,topic:s,message:r,opts:n}})}catch(m){if(this.logger.debug("Failed to Publish Payload"),this.logger.error(m),(a=n?.internal)!=null&&a.throwOnFailedPublish)throw m;this.queue.set(l,g)}},this.on=(s,r)=>{this.events.on(s,r)},this.once=(s,r)=>{this.events.once(s,r)},this.off=(s,r)=>{this.events.off(s,r)},this.removeListener=(s,r)=>{this.events.removeListener(s,r)},this.relayer=e,this.logger=N(t,this.name),this.registerEventListeners()}get context(){return D(this.logger)}rpcPublish(e,t,s,r,n,a,o,c){var h,u,l,g;let d={method:St(r.protocol).publish,params:{topic:e,message:t,ttl:s,prompt:n,tag:a,attestation:c},id:o};return Y((h=d.params)==null?void 0:h.prompt)&&((u=d.params)==null||delete u.prompt),Y((l=d.params)==null?void 0:l.tag)&&((g=d.params)==null||delete g.tag),this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"message",direction:"outgoing",request:d}),this.relayer.request(d)}removeRequestFromQueue(e){this.queue.delete(e)}checkQueue(){this.queue.forEach(async e=>{let{topic:t,message:s,opts:r}=e;await this.publish(t,s,r)})}registerEventListeners(){this.relayer.core.heartbeat.on(pe.pulse,()=>{if(this.needsTransportRestart){this.needsTransportRestart=!1,this.relayer.events.emit(ee.connection_stalled);return}this.checkQueue()}),this.relayer.on(ee.message_ack,e=>{this.removeRequestFromQueue(e.id.toString())})}},Or=class{constructor(){this.map=new Map,this.set=(e,t)=>{let s=this.get(e);this.exists(e,t)||this.map.set(e,[...s,t])},this.get=e=>this.map.get(e)||[],this.exists=(e,t)=>this.get(e).includes(t),this.delete=(e,t)=>{if(typeof t>"u"){this.map.delete(e);return}if(!this.map.has(e))return;let s=this.get(e);if(!this.exists(e,t))return;let r=s.filter(n=>n!==t);if(!r.length){this.map.delete(e);return}this.map.set(e,r)},this.clear=()=>{this.map.clear()}}get topics(){return Array.from(this.map.keys())}},qd=Object.defineProperty,$d=Object.defineProperties,kd=Object.getOwnPropertyDescriptors,xo=Object.getOwnPropertySymbols,jd=Object.prototype.hasOwnProperty,Md=Object.prototype.propertyIsEnumerable,Ao=(i,e,t)=>e in i?qd(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,ss=(i,e)=>{for(var t in e||(e={}))jd.call(e,t)&&Ao(i,t,e[t]);if(xo)for(var t of xo(e))Md.call(e,t)&&Ao(i,t,e[t]);return i},dr=(i,e)=>$d(i,kd(e)),Pr=class extends Vs{constructor(e,t){super(e,t),this.relayer=e,this.logger=t,this.subscriptions=new Map,this.topicMap=new Or,this.events=new je.EventEmitter,this.name=ep,this.version=tp,this.pending=new Map,this.cached=[],this.initialized=!1,this.pendingSubscriptionWatchLabel="pending_sub_watch_label",this.pollingInterval=20,this.storagePrefix=Ae,this.subscribeTimeout=(0,v.toMiliseconds)(v.ONE_MINUTE),this.restartInProgress=!1,this.batchSubscribeTopicsLimit=500,this.pendingBatchMessages=[],this.init=async()=>{this.initialized||(this.logger.trace("Initialized"),this.registerEventListeners(),this.clientId=await this.relayer.core.crypto.getClientId(),await this.restore()),this.initialized=!0},this.subscribe=async(s,r)=>{this.isInitialized(),this.logger.debug("Subscribing Topic"),this.logger.trace({type:"method",method:"subscribe",params:{topic:s,opts:r}});try{let n=ti(r),a={topic:s,relay:n,transportType:r?.transportType};this.pending.set(s,a);let o=await this.rpcSubscribe(s,n,r);return typeof o=="string"&&(this.onSubscribe(o,a),this.logger.debug("Successfully Subscribed Topic"),this.logger.trace({type:"method",method:"subscribe",params:{topic:s,opts:r}})),o}catch(n){throw this.logger.debug("Failed to Subscribe Topic"),this.logger.error(n),n}},this.unsubscribe=async(s,r)=>{await this.restartToComplete(),this.isInitialized(),typeof r?.id<"u"?await this.unsubscribeById(s,r.id,r):await this.unsubscribeByTopic(s,r)},this.isSubscribed=async s=>{if(this.topics.includes(s))return!0;let r=`${this.pendingSubscriptionWatchLabel}_${s}`;return await new Promise((n,a)=>{let o=new v.Watch;o.start(r);let c=setInterval(()=>{!this.pending.has(s)&&this.topics.includes(s)&&(clearInterval(c),o.stop(r),n(!0)),o.elapsed(r)>=sp&&(clearInterval(c),o.stop(r),a(new Error("Subscription resolution timeout")))},this.pollingInterval)}).catch(()=>!1)},this.on=(s,r)=>{this.events.on(s,r)},this.once=(s,r)=>{this.events.once(s,r)},this.off=(s,r)=>{this.events.off(s,r)},this.removeListener=(s,r)=>{this.events.removeListener(s,r)},this.start=async()=>{await this.onConnect()},this.stop=async()=>{await this.onDisconnect()},this.restart=async()=>{this.restartInProgress=!0,await this.restore(),await this.reset(),this.restartInProgress=!1},this.relayer=e,this.logger=N(t,this.name),this.clientId=""}get context(){return D(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.relayer.core.customStoragePrefix+"//"+this.name}get length(){return this.subscriptions.size}get ids(){return Array.from(this.subscriptions.keys())}get values(){return Array.from(this.subscriptions.values())}get topics(){return this.topicMap.topics}hasSubscription(e,t){let s=!1;try{s=this.getSubscription(e).topic===t}catch{}return s}onEnable(){this.cached=[],this.initialized=!0}onDisable(){this.cached=this.values,this.subscriptions.clear(),this.topicMap.clear()}async unsubscribeByTopic(e,t){let s=this.topicMap.get(e);await Promise.all(s.map(async r=>await this.unsubscribeById(e,r,t)))}async unsubscribeById(e,t,s){this.logger.debug("Unsubscribing Topic"),this.logger.trace({type:"method",method:"unsubscribe",params:{topic:e,id:t,opts:s}});try{let r=ti(s);await this.rpcUnsubscribe(e,t,r);let n=L("USER_DISCONNECTED",`${this.name}, ${e}`);await this.onUnsubscribe(e,t,n),this.logger.debug("Successfully Unsubscribed Topic"),this.logger.trace({type:"method",method:"unsubscribe",params:{topic:e,id:t,opts:s}})}catch(r){throw this.logger.debug("Failed to Unsubscribe Topic"),this.logger.error(r),r}}async rpcSubscribe(e,t,s){var r;s?.transportType===$.relay&&await this.restartToComplete();let n={method:St(t.protocol).subscribe,params:{topic:e}};this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"payload",direction:"outgoing",request:n});let a=(r=s?.internal)==null?void 0:r.throwOnFailedPublish;try{let o=Ee(e+this.clientId);if(s?.transportType===$.link_mode)return setTimeout(()=>{(this.relayer.connected||this.relayer.connecting)&&this.relayer.request(n).catch(h=>this.logger.warn(h))},(0,v.toMiliseconds)(v.ONE_SECOND)),o;let c=await lt(this.relayer.request(n).catch(h=>this.logger.warn(h)),this.subscribeTimeout,`Subscribing to ${e} failed, please try again`);if(!c&&a)throw new Error(`Subscribing to ${e} failed, please try again`);return c?o:null}catch(o){if(this.logger.debug("Outgoing Relay Subscribe Payload stalled"),this.relayer.events.emit(ee.connection_stalled),a)throw o}return null}async rpcBatchSubscribe(e){if(!e.length)return;let t=e[0].relay,s={method:St(t.protocol).batchSubscribe,params:{topics:e.map(r=>r.topic)}};this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"payload",direction:"outgoing",request:s});try{return await await lt(this.relayer.request(s).catch(r=>this.logger.warn(r)),this.subscribeTimeout)}catch{this.relayer.events.emit(ee.connection_stalled)}}async rpcBatchFetchMessages(e){if(!e.length)return;let t=e[0].relay,s={method:St(t.protocol).batchFetchMessages,params:{topics:e.map(n=>n.topic)}};this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"payload",direction:"outgoing",request:s});let r;try{r=await await lt(this.relayer.request(s).catch(n=>this.logger.warn(n)),this.subscribeTimeout)}catch{this.relayer.events.emit(ee.connection_stalled)}return r}rpcUnsubscribe(e,t,s){let r={method:St(s.protocol).unsubscribe,params:{topic:e,id:t}};return this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"payload",direction:"outgoing",request:r}),this.relayer.request(r)}onSubscribe(e,t){this.setSubscription(e,dr(ss({},t),{id:e})),this.pending.delete(t.topic)}onBatchSubscribe(e){e.length&&e.forEach(t=>{this.setSubscription(t.id,ss({},t)),this.pending.delete(t.topic)})}async onUnsubscribe(e,t,s){this.events.removeAllListeners(t),this.hasSubscription(t,e)&&this.deleteSubscription(t,s),await this.relayer.messages.del(e)}async setRelayerSubscriptions(e){await this.relayer.core.storage.setItem(this.storageKey,e)}async getRelayerSubscriptions(){return await this.relayer.core.storage.getItem(this.storageKey)}setSubscription(e,t){this.logger.debug("Setting subscription"),this.logger.trace({type:"method",method:"setSubscription",id:e,subscription:t}),this.addSubscription(e,t)}addSubscription(e,t){this.subscriptions.set(e,ss({},t)),this.topicMap.set(t.topic,e),this.events.emit(Ne.created,t)}getSubscription(e){this.logger.debug("Getting subscription"),this.logger.trace({type:"method",method:"getSubscription",id:e});let t=this.subscriptions.get(e);if(!t){let{message:s}=f("NO_MATCHING_KEY",`${this.name}: ${e}`);throw new Error(s)}return t}deleteSubscription(e,t){this.logger.debug("Deleting subscription"),this.logger.trace({type:"method",method:"deleteSubscription",id:e,reason:t});let s=this.getSubscription(e);this.subscriptions.delete(e),this.topicMap.delete(s.topic,e),this.events.emit(Ne.deleted,dr(ss({},s),{reason:t}))}async persist(){await this.setRelayerSubscriptions(this.values),this.events.emit(Ne.sync)}async reset(){if(this.cached.length){let e=Math.ceil(this.cached.length/this.batchSubscribeTopicsLimit);for(let t=0;t<e;t++){let s=this.cached.splice(0,this.batchSubscribeTopicsLimit);await this.batchFetchMessages(s),await this.batchSubscribe(s)}}this.events.emit(Ne.resubscribed)}async restore(){try{let e=await this.getRelayerSubscriptions();if(typeof e>"u"||!e.length)return;if(this.subscriptions.size){let{message:t}=f("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(t),this.logger.error(`${this.name}: ${JSON.stringify(this.values)}`),new Error(t)}this.cached=e,this.logger.debug(`Successfully Restored subscriptions for ${this.name}`),this.logger.trace({type:"method",method:"restore",subscriptions:this.values})}catch(e){this.logger.debug(`Failed to Restore subscriptions for ${this.name}`),this.logger.error(e)}}async batchSubscribe(e){if(!e.length)return;let t=await this.rpcBatchSubscribe(e);Tt(t)&&this.onBatchSubscribe(t.map((s,r)=>dr(ss({},e[r]),{id:s})))}async batchFetchMessages(e){if(!e.length)return;this.logger.trace(`Fetching batch messages for ${e.length} subscriptions`);let t=await this.rpcBatchFetchMessages(e);t&&t.messages&&(this.pendingBatchMessages=this.pendingBatchMessages.concat(t.messages))}async onConnect(){await this.restart(),this.onEnable()}onDisconnect(){this.onDisable()}async checkPending(){if(!this.initialized||!this.relayer.connected)return;let e=[];this.pending.forEach(t=>{e.push(t)}),await this.batchSubscribe(e),this.pendingBatchMessages.length&&(await this.relayer.handleBatchMessageEvents(this.pendingBatchMessages),this.pendingBatchMessages=[])}registerEventListeners(){this.relayer.core.heartbeat.on(pe.pulse,async()=>{await this.checkPending()}),this.events.on(Ne.created,async e=>{let t=Ne.created;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,data:e}),await this.persist()}),this.events.on(Ne.deleted,async e=>{let t=Ne.deleted;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,data:e}),await this.persist()})}isInitialized(){if(!this.initialized){let{message:e}=f("NOT_INITIALIZED",this.name);throw new Error(e)}}async restartToComplete(){!this.relayer.connected&&!this.relayer.connecting&&await this.relayer.transportOpen(),this.restartInProgress&&await new Promise(e=>{let t=setInterval(()=>{this.restartInProgress||(clearInterval(t),e())},this.pollingInterval)})}},Vd=Object.defineProperty,Co=Object.getOwnPropertySymbols,Kd=Object.prototype.hasOwnProperty,zd=Object.prototype.propertyIsEnumerable,Fo=(i,e,t)=>e in i?Vd(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,Do=(i,e)=>{for(var t in e||(e={}))Kd.call(e,t)&&Fo(i,t,e[t]);if(Co)for(var t of Co(e))zd.call(e,t)&&Fo(i,t,e[t]);return i},Nr=class extends js{constructor(e){super(e),this.protocol="wc",this.version=2,this.events=new je.EventEmitter,this.name=Yu,this.transportExplicitlyClosed=!1,this.initialized=!1,this.connectionAttemptInProgress=!1,this.connectionStatusPollingInterval=20,this.staleConnectionErrors=["socket hang up","stalled","interrupted"],this.hasExperiencedNetworkDisruption=!1,this.requestsInFlight=new Map,this.heartBeatTimeout=(0,v.toMiliseconds)(v.THIRTY_SECONDS+v.ONE_SECOND),this.request=async t=>{var s,r;this.logger.debug("Publishing Request Payload");let n=t.id||me().toString();await this.toEstablishConnection();try{let a=this.provider.request(t);this.requestsInFlight.set(n,{promise:a,request:t}),this.logger.trace({id:n,method:t.method,topic:(s=t.params)==null?void 0:s.topic},"relayer.request - attempt to publish...");let o=await new Promise(async(c,h)=>{let u=()=>{h(new Error(`relayer.request - publish interrupted, id: ${n}`))};this.provider.on(de.disconnect,u);let l=await a;this.provider.off(de.disconnect,u),c(l)});return this.logger.trace({id:n,method:t.method,topic:(r=t.params)==null?void 0:r.topic},"relayer.request - published"),o}catch(a){throw this.logger.debug(`Failed to Publish Request: ${n}`),a}finally{this.requestsInFlight.delete(n)}},this.resetPingTimeout=()=>{if(Ht())try{clearTimeout(this.pingTimeout),this.pingTimeout=setTimeout(()=>{var t,s,r;(r=(s=(t=this.provider)==null?void 0:t.connection)==null?void 0:s.socket)==null||r.terminate()},this.heartBeatTimeout)}catch(t){this.logger.warn(t)}},this.onPayloadHandler=t=>{this.onProviderPayload(t),this.resetPingTimeout()},this.onConnectHandler=()=>{this.logger.trace("relayer connected"),this.startPingTimeout(),this.events.emit(ee.connect)},this.onDisconnectHandler=()=>{this.logger.trace("relayer disconnected"),this.onProviderDisconnect()},this.onProviderErrorHandler=t=>{this.logger.error(t),this.events.emit(ee.error,t),this.logger.info("Fatal socket error received, closing transport"),this.transportClose()},this.registerProviderListeners=()=>{this.provider.on(de.payload,this.onPayloadHandler),this.provider.on(de.connect,this.onConnectHandler),this.provider.on(de.disconnect,this.onDisconnectHandler),this.provider.on(de.error,this.onProviderErrorHandler)},this.core=e.core,this.logger=typeof e.logger<"u"&&typeof e.logger!="string"?N(e.logger,this.name):(0,gt.default)(Be({level:e.logger||Ju})),this.messages=new Rr(this.logger,e.core),this.subscriber=new Pr(this,this.logger),this.publisher=new Tr(this,this.logger),this.relayUrl=e?.relayUrl||Ho,this.projectId=e.projectId,this.bundleId=La(),this.provider={}}async init(){if(this.logger.trace("Initialized"),this.registerEventListeners(),await Promise.all([this.messages.init(),this.subscriber.init()]),this.initialized=!0,this.subscriber.cached.length>0)try{await this.transportOpen()}catch(e){this.logger.warn(e)}}get context(){return D(this.logger)}get connected(){var e,t,s;return((s=(t=(e=this.provider)==null?void 0:e.connection)==null?void 0:t.socket)==null?void 0:s.readyState)===1}get connecting(){var e,t,s;return((s=(t=(e=this.provider)==null?void 0:e.connection)==null?void 0:t.socket)==null?void 0:s.readyState)===0}async publish(e,t,s){this.isInitialized(),await this.publisher.publish(e,t,s),await this.recordMessageEvent({topic:e,message:t,publishedAt:Date.now(),transportType:$.relay})}async subscribe(e,t){var s,r,n;this.isInitialized(),t?.transportType==="relay"&&await this.toEstablishConnection();let a=typeof((s=t?.internal)==null?void 0:s.throwOnFailedPublish)>"u"?!0:(r=t?.internal)==null?void 0:r.throwOnFailedPublish,o=((n=this.subscriber.topicMap.get(e))==null?void 0:n[0])||"",c,h=u=>{u.topic===e&&(this.subscriber.off(Ne.created,h),c())};return await Promise.all([new Promise(u=>{c=u,this.subscriber.on(Ne.created,h)}),new Promise(async(u,l)=>{o=await this.subscriber.subscribe(e,Do({internal:{throwOnFailedPublish:a}},t)).catch(g=>{a&&l(g)})||o,u()})]),o}async unsubscribe(e,t){this.isInitialized(),await this.subscriber.unsubscribe(e,t)}on(e,t){this.events.on(e,t)}once(e,t){this.events.once(e,t)}off(e,t){this.events.off(e,t)}removeListener(e,t){this.events.removeListener(e,t)}async transportDisconnect(){if(!this.hasExperiencedNetworkDisruption&&this.connected&&this.requestsInFlight.size>0)try{await Promise.all(Array.from(this.requestsInFlight.values()).map(e=>e.promise))}catch(e){this.logger.warn(e)}this.hasExperiencedNetworkDisruption||this.connected?await lt(this.provider.disconnect(),2e3,"provider.disconnect()").catch(()=>this.onProviderDisconnect()):this.onProviderDisconnect()}async transportClose(){this.transportExplicitlyClosed=!0,await this.transportDisconnect()}async transportOpen(e){await this.confirmOnlineStateOrThrow(),e&&e!==this.relayUrl&&(this.relayUrl=e,await this.transportDisconnect()),await this.createProvider(),this.connectionAttemptInProgress=!0,this.transportExplicitlyClosed=!1;try{await new Promise(async(t,s)=>{let r=()=>{this.provider.off(de.disconnect,r),s(new Error("Connection interrupted while trying to subscribe"))};this.provider.on(de.disconnect,r),await lt(this.provider.connect(),(0,v.toMiliseconds)(v.ONE_MINUTE),`Socket stalled when trying to connect to ${this.relayUrl}`).catch(n=>{s(n)}).finally(()=>{clearTimeout(this.reconnectTimeout),this.reconnectTimeout=void 0}),this.subscriber.start().catch(n=>{this.logger.error(n),this.onDisconnectHandler()}),this.hasExperiencedNetworkDisruption=!1,t()})}catch(t){this.logger.error(t);let s=t;if(this.hasExperiencedNetworkDisruption=!0,!this.isConnectionStalled(s.message))throw t}finally{this.connectionAttemptInProgress=!1}}async restartTransport(e){this.connectionAttemptInProgress||(this.relayUrl=e||this.relayUrl,await this.confirmOnlineStateOrThrow(),await this.transportClose(),await this.transportOpen())}async confirmOnlineStateOrThrow(){if(!await ur())throw new Error("No internet connection detected. Please restart your network and try again.")}async handleBatchMessageEvents(e){if(e?.length===0){this.logger.trace("Batch message events is empty. Ignoring...");return}let t=e.sort((s,r)=>s.publishedAt-r.publishedAt);this.logger.trace(`Batch of ${t.length} message events sorted`);for(let s of t)try{await this.onMessageEvent(s)}catch(r){this.logger.warn(r)}this.logger.trace(`Batch of ${t.length} message events processed`)}async onLinkMessageEvent(e,t){let{topic:s}=e;if(!t.sessionExists){let r=B(v.FIVE_MINUTES),n={topic:s,expiry:r,relay:{protocol:"irn"},active:!1};await this.core.pairing.pairings.set(s,n)}this.events.emit(ee.message,e),await this.recordMessageEvent(e)}startPingTimeout(){var e,t,s,r,n;if(Ht())try{(t=(e=this.provider)==null?void 0:e.connection)!=null&&t.socket&&((n=(r=(s=this.provider)==null?void 0:s.connection)==null?void 0:r.socket)==null||n.once("ping",()=>{this.resetPingTimeout()})),this.resetPingTimeout()}catch(a){this.logger.warn(a)}}isConnectionStalled(e){return this.staleConnectionErrors.some(t=>e.includes(t))}async createProvider(){this.provider.connection&&this.unregisterProviderListeners();let e=await this.core.crypto.signJWT(this.relayUrl);this.provider=new Ds(new Ls(Ua({sdkVersion:gr,protocol:this.protocol,version:this.version,relayUrl:this.relayUrl,projectId:this.projectId,auth:e,useOnCloseEvent:!0,bundleId:this.bundleId}))),this.registerProviderListeners()}async recordMessageEvent(e){let{topic:t,message:s}=e;await this.messages.set(t,s)}async shouldIgnoreMessageEvent(e){let{topic:t,message:s}=e;if(!s||s.length===0)return this.logger.debug(`Ignoring invalid/empty message: ${s}`),!0;if(!await this.subscriber.isSubscribed(t))return this.logger.debug(`Ignoring message for non-subscribed topic ${t}`),!0;let r=this.messages.has(t,s);return r&&this.logger.debug(`Ignoring duplicate message: ${s}`),r}async onProviderPayload(e){if(this.logger.debug("Incoming Relay Payload"),this.logger.trace({type:"payload",direction:"incoming",payload:e}),Je(e)){if(!e.method.endsWith(Wu))return;let t=e.params,{topic:s,message:r,publishedAt:n,attestation:a}=t.data,o={topic:s,message:r,publishedAt:n,transportType:$.relay,attestation:a};this.logger.debug("Emitting Relayer Payload"),this.logger.trace(Do({type:"event",event:t.id},o)),this.events.emit(t.id,o),await this.acknowledgePayload(e),await this.onMessageEvent(o)}else Ye(e)&&this.events.emit(ee.message_ack,e)}async onMessageEvent(e){await this.shouldIgnoreMessageEvent(e)||(this.events.emit(ee.message,e),await this.recordMessageEvent(e))}async acknowledgePayload(e){let t=He(e.id,!0);await this.provider.connection.send(t)}unregisterProviderListeners(){this.provider.off(de.payload,this.onPayloadHandler),this.provider.off(de.connect,this.onConnectHandler),this.provider.off(de.disconnect,this.onDisconnectHandler),this.provider.off(de.error,this.onProviderErrorHandler),clearTimeout(this.pingTimeout)}async registerEventListeners(){let e=await ur();vo(async t=>{e!==t&&(e=t,t?await this.restartTransport().catch(s=>this.logger.error(s)):(this.hasExperiencedNetworkDisruption=!0,await this.transportDisconnect(),this.transportExplicitlyClosed=!1))})}async onProviderDisconnect(){await this.subscriber.stop(),this.requestsInFlight.clear(),clearTimeout(this.pingTimeout),this.events.emit(ee.disconnect),this.connectionAttemptInProgress=!1,!this.transportExplicitlyClosed&&(this.reconnectTimeout||(this.reconnectTimeout=setTimeout(async()=>{await this.transportOpen().catch(e=>this.logger.error(e))},(0,v.toMiliseconds)(Xu))))}isInitialized(){if(!this.initialized){let{message:e}=f("NOT_INITIALIZED",this.name);throw new Error(e)}}async toEstablishConnection(){await this.confirmOnlineStateOrThrow(),!this.connected&&(this.connectionAttemptInProgress&&await new Promise(e=>{let t=setInterval(()=>{this.connected&&(clearInterval(t),e())},this.connectionStatusPollingInterval)}),await this.transportOpen())}},Bd=Object.defineProperty,Lo=Object.getOwnPropertySymbols,Gd=Object.prototype.hasOwnProperty,Hd=Object.prototype.propertyIsEnumerable,Uo=(i,e,t)=>e in i?Bd(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,qo=(i,e)=>{for(var t in e||(e={}))Gd.call(e,t)&&Uo(i,t,e[t]);if(Lo)for(var t of Lo(e))Hd.call(e,t)&&Uo(i,t,e[t]);return i},Ce=class extends Ms{constructor(e,t,s,r=Ae,n=void 0){super(e,t,s,r),this.core=e,this.logger=t,this.name=s,this.map=new Map,this.version=Qu,this.cached=[],this.initialized=!1,this.storagePrefix=Ae,this.recentlyDeleted=[],this.recentlyDeletedLimit=200,this.init=async()=>{this.initialized||(this.logger.trace("Initialized"),await this.restore(),this.cached.forEach(a=>{this.getKey&&a!==null&&!Y(a)?this.map.set(this.getKey(a),a):ao(a)?this.map.set(a.id,a):oo(a)&&this.map.set(a.topic,a)}),this.cached=[],this.initialized=!0)},this.set=async(a,o)=>{this.isInitialized(),this.map.has(a)?await this.update(a,o):(this.logger.debug("Setting value"),this.logger.trace({type:"method",method:"set",key:a,value:o}),this.map.set(a,o),await this.persist())},this.get=a=>(this.isInitialized(),this.logger.debug("Getting value"),this.logger.trace({type:"method",method:"get",key:a}),this.getData(a)),this.getAll=a=>(this.isInitialized(),a?this.values.filter(o=>Object.keys(a).every(c=>(0,Ko.default)(o[c],a[c]))):this.values),this.update=async(a,o)=>{this.isInitialized(),this.logger.debug("Updating value"),this.logger.trace({type:"method",method:"update",key:a,update:o});let c=qo(qo({},this.getData(a)),o);this.map.set(a,c),await this.persist()},this.delete=async(a,o)=>{this.isInitialized(),this.map.has(a)&&(this.logger.debug("Deleting value"),this.logger.trace({type:"method",method:"delete",key:a,reason:o}),this.map.delete(a),this.addToRecentlyDeleted(a),await this.persist())},this.logger=N(t,this.name),this.storagePrefix=r,this.getKey=n}get context(){return D(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name}get length(){return this.map.size}get keys(){return Array.from(this.map.keys())}get values(){return Array.from(this.map.values())}addToRecentlyDeleted(e){this.recentlyDeleted.push(e),this.recentlyDeleted.length>=this.recentlyDeletedLimit&&this.recentlyDeleted.splice(0,this.recentlyDeletedLimit/2)}async setDataStore(e){await this.core.storage.setItem(this.storageKey,e)}async getDataStore(){return await this.core.storage.getItem(this.storageKey)}getData(e){let t=this.map.get(e);if(!t){if(this.recentlyDeleted.includes(e)){let{message:r}=f("MISSING_OR_INVALID",`Record was recently deleted - ${this.name}: ${e}`);throw this.logger.error(r),new Error(r)}let{message:s}=f("NO_MATCHING_KEY",`${this.name}: ${e}`);throw this.logger.error(s),new Error(s)}return t}async persist(){await this.setDataStore(this.values)}async restore(){try{let e=await this.getDataStore();if(typeof e>"u"||!e.length)return;if(this.map.size){let{message:t}=f("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(t),new Error(t)}this.cached=e,this.logger.debug(`Successfully Restored value for ${this.name}`),this.logger.trace({type:"method",method:"restore",value:this.values})}catch(e){this.logger.debug(`Failed to Restore value for ${this.name}`),this.logger.error(e)}}isInitialized(){if(!this.initialized){let{message:e}=f("NOT_INITIALIZED",this.name);throw new Error(e)}}},xr=class{constructor(e,t){this.core=e,this.logger=t,this.name=ip,this.version=rp,this.events=new je.default,this.initialized=!1,this.storagePrefix=Ae,this.ignoredPayloadTypes=[be],this.registeredMethods=[],this.init=async()=>{this.initialized||(await this.pairings.init(),await this.cleanup(),this.registerRelayerEvents(),this.registerExpirerEvents(),this.initialized=!0,this.logger.trace("Initialized"))},this.register=({methods:s})=>{this.isInitialized(),this.registeredMethods=[...new Set([...this.registeredMethods,...s])]},this.create=async s=>{this.isInitialized();let r=ei(),n=await this.core.crypto.setSymKey(r),a=B(v.FIVE_MINUTES),o={protocol:qr},c={topic:n,expiry:a,relay:o,active:!1,methods:s?.methods},h=nr({protocol:this.core.protocol,version:this.core.version,topic:n,symKey:r,relay:o,expiryTimestamp:a,methods:s?.methods});return this.events.emit(Qe.create,c),this.core.expirer.set(n,a),await this.pairings.set(n,c),await this.core.relayer.subscribe(n,{transportType:s?.transportType}),{topic:n,uri:h}},this.pair=async s=>{this.isInitialized();let r=this.core.eventClient.createEvent({properties:{topic:s?.uri,trace:[_e.pairing_started]}});this.isValidPair(s,r);let{topic:n,symKey:a,relay:o,expiryTimestamp:c,methods:h}=rr(s.uri);r.props.properties.topic=n,r.addTrace(_e.pairing_uri_validation_success),r.addTrace(_e.pairing_uri_not_expired);let u;if(this.pairings.keys.includes(n)){if(u=this.pairings.get(n),r.addTrace(_e.existing_pairing),u.active)throw r.setError(xe.active_pairing_already_exists),new Error(`Pairing already exists: ${n}. Please try again with a new connection URI.`);r.addTrace(_e.pairing_not_expired)}let l=c||B(v.FIVE_MINUTES),g={topic:n,relay:o,expiry:l,active:!1,methods:h};this.core.expirer.set(n,l),await this.pairings.set(n,g),r.addTrace(_e.store_new_pairing),s.activatePairing&&await this.activate({topic:n}),this.events.emit(Qe.create,g),r.addTrace(_e.emit_inactive_pairing),this.core.crypto.keychain.has(n)||await this.core.crypto.setSymKey(a,n),r.addTrace(_e.subscribing_pairing_topic);try{await this.core.relayer.confirmOnlineStateOrThrow()}catch{r.setError(xe.no_internet_connection)}try{await this.core.relayer.subscribe(n,{relay:o})}catch(d){throw r.setError(xe.subscribe_pairing_topic_failure),d}return r.addTrace(_e.subscribe_pairing_topic_success),g},this.activate=async({topic:s})=>{this.isInitialized();let r=B(v.THIRTY_DAYS);this.core.expirer.set(s,r),await this.pairings.update(s,{active:!0,expiry:r})},this.ping=async s=>{this.isInitialized(),await this.isValidPing(s);let{topic:r}=s;if(this.pairings.keys.includes(r)){let n=await this.sendRequest(r,"wc_pairingPing",{}),{done:a,resolve:o,reject:c}=ke();this.events.once(S("pairing_ping",n),({error:h})=>{h?c(h):o()}),await a()}},this.updateExpiry=async({topic:s,expiry:r})=>{this.isInitialized(),await this.pairings.update(s,{expiry:r})},this.updateMetadata=async({topic:s,metadata:r})=>{this.isInitialized(),await this.pairings.update(s,{peerMetadata:r})},this.getPairings=()=>(this.isInitialized(),this.pairings.values),this.disconnect=async s=>{this.isInitialized(),await this.isValidDisconnect(s);let{topic:r}=s;this.pairings.keys.includes(r)&&(await this.sendRequest(r,"wc_pairingDelete",L("USER_DISCONNECTED")),await this.deletePairing(r))},this.formatUriFromPairing=s=>{this.isInitialized();let{topic:r,relay:n,expiry:a,methods:o}=s,c=this.core.crypto.keychain.get(r);return nr({protocol:this.core.protocol,version:this.core.version,topic:r,symKey:c,relay:n,expiryTimestamp:a,methods:o})},this.sendRequest=async(s,r,n)=>{let a=we(r,n),o=await this.core.crypto.encode(s,a),c=ts[r].req;return this.core.history.set(s,a),this.core.relayer.publish(s,o,c),a.id},this.sendResult=async(s,r,n)=>{let a=He(s,n),o=await this.core.crypto.encode(r,a),c=await this.core.history.get(r,s),h=ts[c.request.method].res;await this.core.relayer.publish(r,o,h),await this.core.history.resolve(a)},this.sendError=async(s,r,n)=>{let a=ft(s,n),o=await this.core.crypto.encode(r,a),c=await this.core.history.get(r,s),h=ts[c.request.method]?ts[c.request.method].res:ts.unregistered_method.res;await this.core.relayer.publish(r,o,h),await this.core.history.resolve(a)},this.deletePairing=async(s,r)=>{await this.core.relayer.unsubscribe(s),await Promise.all([this.pairings.delete(s,L("USER_DISCONNECTED")),this.core.crypto.deleteSymKey(s),r?Promise.resolve():this.core.expirer.del(s)])},this.cleanup=async()=>{let s=this.pairings.getAll().filter(r=>Oe(r.expiry));await Promise.all(s.map(r=>this.deletePairing(r.topic)))},this.onRelayEventRequest=s=>{let{topic:r,payload:n}=s;switch(n.method){case"wc_pairingPing":return this.onPairingPingRequest(r,n);case"wc_pairingDelete":return this.onPairingDeleteRequest(r,n);default:return this.onUnknownRpcMethodRequest(r,n)}},this.onRelayEventResponse=async s=>{let{topic:r,payload:n}=s,a=(await this.core.history.get(r,n.id)).request.method;switch(a){case"wc_pairingPing":return this.onPairingPingResponse(r,n);default:return this.onUnknownRpcMethodResponse(a)}},this.onPairingPingRequest=async(s,r)=>{let{id:n}=r;try{this.isValidPing({topic:s}),await this.sendResult(n,s,!0),this.events.emit(Qe.ping,{id:n,topic:s})}catch(a){await this.sendError(n,s,a),this.logger.error(a)}},this.onPairingPingResponse=(s,r)=>{let{id:n}=r;setTimeout(()=>{ce(r)?this.events.emit(S("pairing_ping",n),{}):se(r)&&this.events.emit(S("pairing_ping",n),{error:r.error})},500)},this.onPairingDeleteRequest=async(s,r)=>{let{id:n}=r;try{this.isValidDisconnect({topic:s}),await this.deletePairing(s),this.events.emit(Qe.delete,{id:n,topic:s})}catch(a){await this.sendError(n,s,a),this.logger.error(a)}},this.onUnknownRpcMethodRequest=async(s,r)=>{let{id:n,method:a}=r;try{if(this.registeredMethods.includes(a))return;let o=L("WC_METHOD_UNSUPPORTED",a);await this.sendError(n,s,o),this.logger.error(o)}catch(o){await this.sendError(n,s,o),this.logger.error(o)}},this.onUnknownRpcMethodResponse=s=>{this.registeredMethods.includes(s)||this.logger.error(L("WC_METHOD_UNSUPPORTED",s))},this.isValidPair=(s,r)=>{var n;if(!Z(s)){let{message:o}=f("MISSING_OR_INVALID",`pair() params: ${s}`);throw r.setError(xe.malformed_pairing_uri),new Error(o)}if(!no(s.uri)){let{message:o}=f("MISSING_OR_INVALID",`pair() uri: ${s.uri}`);throw r.setError(xe.malformed_pairing_uri),new Error(o)}let a=rr(s?.uri);if(!((n=a?.relay)!=null&&n.protocol)){let{message:o}=f("MISSING_OR_INVALID","pair() uri#relay-protocol");throw r.setError(xe.malformed_pairing_uri),new Error(o)}if(!(a!=null&&a.symKey)){let{message:o}=f("MISSING_OR_INVALID","pair() uri#symKey");throw r.setError(xe.malformed_pairing_uri),new Error(o)}if(a!=null&&a.expiryTimestamp&&(0,v.toMiliseconds)(a?.expiryTimestamp)<Date.now()){r.setError(xe.pairing_expired);let{message:o}=f("EXPIRED","pair() URI has expired. Please try again with a new connection URI.");throw new Error(o)}},this.isValidPing=async s=>{if(!Z(s)){let{message:n}=f("MISSING_OR_INVALID",`ping() params: ${s}`);throw new Error(n)}let{topic:r}=s;await this.isValidPairingTopic(r)},this.isValidDisconnect=async s=>{if(!Z(s)){let{message:n}=f("MISSING_OR_INVALID",`disconnect() params: ${s}`);throw new Error(n)}let{topic:r}=s;await this.isValidPairingTopic(r)},this.isValidPairingTopic=async s=>{if(!V(s,!1)){let{message:r}=f("MISSING_OR_INVALID",`pairing topic should be a string: ${s}`);throw new Error(r)}if(!this.pairings.keys.includes(s)){let{message:r}=f("NO_MATCHING_KEY",`pairing topic doesn't exist: ${s}`);throw new Error(r)}if(Oe(this.pairings.get(s).expiry)){await this.deletePairing(s);let{message:r}=f("EXPIRED",`pairing topic: ${s}`);throw new Error(r)}},this.core=e,this.logger=N(t,this.name),this.pairings=new Ce(this.core,this.logger,this.name,this.storagePrefix)}get context(){return D(this.logger)}isInitialized(){if(!this.initialized){let{message:e}=f("NOT_INITIALIZED",this.name);throw new Error(e)}}registerRelayerEvents(){this.core.relayer.on(ee.message,async e=>{let{topic:t,message:s,transportType:r}=e;if(!this.pairings.keys.includes(t)||r===$.link_mode||this.ignoredPayloadTypes.includes(this.core.crypto.getPayloadType(s)))return;let n=await this.core.crypto.decode(t,s);try{Je(n)?(this.core.history.set(t,n),this.onRelayEventRequest({topic:t,payload:n})):Ye(n)&&(await this.core.history.resolve(n),await this.onRelayEventResponse({topic:t,payload:n}),this.core.history.delete(t,n.id))}catch(a){this.logger.error(a)}})}registerExpirerEvents(){this.core.expirer.on(he.expired,async e=>{let{topic:t}=Qs(e.target);t&&this.pairings.keys.includes(t)&&(await this.deletePairing(t,!0),this.events.emit(Qe.expire,{topic:t}))})}},Ar=class extends qs{constructor(e,t){super(e,t),this.core=e,this.logger=t,this.records=new Map,this.events=new je.EventEmitter,this.name=np,this.version=ap,this.cached=[],this.initialized=!1,this.storagePrefix=Ae,this.init=async()=>{this.initialized||(this.logger.trace("Initialized"),await this.restore(),this.cached.forEach(s=>this.records.set(s.id,s)),this.cached=[],this.registerEventListeners(),this.initialized=!0)},this.set=(s,r,n)=>{if(this.isInitialized(),this.logger.debug("Setting JSON-RPC request history record"),this.logger.trace({type:"method",method:"set",topic:s,request:r,chainId:n}),this.records.has(r.id))return;let a={id:r.id,topic:s,request:{method:r.method,params:r.params||null},chainId:n,expiry:B(v.THIRTY_DAYS)};this.records.set(a.id,a),this.persist(),this.events.emit(ve.created,a)},this.resolve=async s=>{if(this.isInitialized(),this.logger.debug("Updating JSON-RPC response history record"),this.logger.trace({type:"method",method:"update",response:s}),!this.records.has(s.id))return;let r=await this.getRecord(s.id);typeof r.response>"u"&&(r.response=se(s)?{error:s.error}:{result:s.result},this.records.set(r.id,r),this.persist(),this.events.emit(ve.updated,r))},this.get=async(s,r)=>(this.isInitialized(),this.logger.debug("Getting record"),this.logger.trace({type:"method",method:"get",topic:s,id:r}),await this.getRecord(r)),this.delete=(s,r)=>{this.isInitialized(),this.logger.debug("Deleting record"),this.logger.trace({type:"method",method:"delete",id:r}),this.values.forEach(n=>{if(n.topic===s){if(typeof r<"u"&&n.id!==r)return;this.records.delete(n.id),this.events.emit(ve.deleted,n)}}),this.persist()},this.exists=async(s,r)=>(this.isInitialized(),this.records.has(r)?(await this.getRecord(r)).topic===s:!1),this.on=(s,r)=>{this.events.on(s,r)},this.once=(s,r)=>{this.events.once(s,r)},this.off=(s,r)=>{this.events.off(s,r)},this.removeListener=(s,r)=>{this.events.removeListener(s,r)},this.logger=N(t,this.name)}get context(){return D(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name}get size(){return this.records.size}get keys(){return Array.from(this.records.keys())}get values(){return Array.from(this.records.values())}get pending(){let e=[];return this.values.forEach(t=>{if(typeof t.response<"u")return;let s={topic:t.topic,request:we(t.request.method,t.request.params,t.id),chainId:t.chainId};return e.push(s)}),e}async setJsonRpcRecords(e){await this.core.storage.setItem(this.storageKey,e)}async getJsonRpcRecords(){return await this.core.storage.getItem(this.storageKey)}getRecord(e){this.isInitialized();let t=this.records.get(e);if(!t){let{message:s}=f("NO_MATCHING_KEY",`${this.name}: ${e}`);throw new Error(s)}return t}async persist(){await this.setJsonRpcRecords(this.values),this.events.emit(ve.sync)}async restore(){try{let e=await this.getJsonRpcRecords();if(typeof e>"u"||!e.length)return;if(this.records.size){let{message:t}=f("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(t),new Error(t)}this.cached=e,this.logger.debug(`Successfully Restored records for ${this.name}`),this.logger.trace({type:"method",method:"restore",records:this.values})}catch(e){this.logger.debug(`Failed to Restore records for ${this.name}`),this.logger.error(e)}}registerEventListeners(){this.events.on(ve.created,e=>{let t=ve.created;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,record:e})}),this.events.on(ve.updated,e=>{let t=ve.updated;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,record:e})}),this.events.on(ve.deleted,e=>{let t=ve.deleted;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,record:e})}),this.core.heartbeat.on(pe.pulse,()=>{this.cleanup()})}cleanup(){try{this.isInitialized();let e=!1;this.records.forEach(t=>{(0,v.toMiliseconds)(t.expiry||0)-Date.now()<=0&&(this.logger.info(`Deleting expired history log: ${t.id}`),this.records.delete(t.id),this.events.emit(ve.deleted,t,!1),e=!0)}),e&&this.persist()}catch(e){this.logger.warn(e)}}isInitialized(){if(!this.initialized){let{message:e}=f("NOT_INITIALIZED",this.name);throw new Error(e)}}},Cr=class extends Ks{constructor(e,t){super(e,t),this.core=e,this.logger=t,this.expirations=new Map,this.events=new je.EventEmitter,this.name=op,this.version=cp,this.cached=[],this.initialized=!1,this.storagePrefix=Ae,this.init=async()=>{this.initialized||(this.logger.trace("Initialized"),await this.restore(),this.cached.forEach(s=>this.expirations.set(s.target,s)),this.cached=[],this.registerEventListeners(),this.initialized=!0)},this.has=s=>{try{let r=this.formatTarget(s);return typeof this.getExpiration(r)<"u"}catch{return!1}},this.set=(s,r)=>{this.isInitialized();let n=this.formatTarget(s),a={target:n,expiry:r};this.expirations.set(n,a),this.checkExpiry(n,a),this.events.emit(he.created,{target:n,expiration:a})},this.get=s=>{this.isInitialized();let r=this.formatTarget(s);return this.getExpiration(r)},this.del=s=>{if(this.isInitialized(),this.has(s)){let r=this.formatTarget(s),n=this.getExpiration(r);this.expirations.delete(r),this.events.emit(he.deleted,{target:r,expiration:n})}},this.on=(s,r)=>{this.events.on(s,r)},this.once=(s,r)=>{this.events.once(s,r)},this.off=(s,r)=>{this.events.off(s,r)},this.removeListener=(s,r)=>{this.events.removeListener(s,r)},this.logger=N(t,this.name)}get context(){return D(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name}get length(){return this.expirations.size}get keys(){return Array.from(this.expirations.keys())}get values(){return Array.from(this.expirations.values())}formatTarget(e){if(typeof e=="string")return $a(e);if(typeof e=="number")return ka(e);let{message:t}=f("UNKNOWN_TYPE",`Target type: ${typeof e}`);throw new Error(t)}async setExpirations(e){await this.core.storage.setItem(this.storageKey,e)}async getExpirations(){return await this.core.storage.getItem(this.storageKey)}async persist(){await this.setExpirations(this.values),this.events.emit(he.sync)}async restore(){try{let e=await this.getExpirations();if(typeof e>"u"||!e.length)return;if(this.expirations.size){let{message:t}=f("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(t),new Error(t)}this.cached=e,this.logger.debug(`Successfully Restored expirations for ${this.name}`),this.logger.trace({type:"method",method:"restore",expirations:this.values})}catch(e){this.logger.debug(`Failed to Restore expirations for ${this.name}`),this.logger.error(e)}}getExpiration(e){let t=this.expirations.get(e);if(!t){let{message:s}=f("NO_MATCHING_KEY",`${this.name}: ${e}`);throw this.logger.warn(s),new Error(s)}return t}checkExpiry(e,t){let{expiry:s}=t;(0,v.toMiliseconds)(s)-Date.now()<=0&&this.expire(e,t)}expire(e,t){this.expirations.delete(e),this.events.emit(he.expired,{target:e,expiration:t})}checkExpirations(){this.core.relayer.connected&&this.expirations.forEach((e,t)=>this.checkExpiry(t,e))}registerEventListeners(){this.core.heartbeat.on(pe.pulse,()=>this.checkExpirations()),this.events.on(he.created,e=>{let t=he.created;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,data:e}),this.persist()}),this.events.on(he.expired,e=>{let t=he.expired;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,data:e}),this.persist()}),this.events.on(he.deleted,e=>{let t=he.deleted;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,data:e}),this.persist()})}isInitialized(){if(!this.initialized){let{message:e}=f("NOT_INITIALIZED",this.name);throw new Error(e)}}},Fr=class extends zs{constructor(e,t,s){super(e,t,s),this.core=e,this.logger=t,this.store=s,this.name=hp,this.verifyUrlV3=up,this.storagePrefix=Ae,this.version=Go,this.init=async()=>{var r;this.isDevEnv||(this.publicKey=await this.store.getItem(this.storeKey),this.publicKey&&(0,v.toMiliseconds)((r=this.publicKey)==null?void 0:r.expiresAt)<Date.now()&&(this.logger.debug("verify v2 public key expired"),await this.removePublicKey()))},this.register=async r=>{if(!bt()||this.isDevEnv)return;let n=window.location.origin,{id:a,decryptedId:o}=r,c=`${this.verifyUrlV3}/attestation?projectId=${this.core.projectId}&origin=${n}&id=${a}&decryptedId=${o}`;try{let h=(0,zo.getDocument)(),u=this.startAbortTimer(v.ONE_SECOND*5),l=await new Promise((g,d)=>{let p=()=>{window.removeEventListener("message",w),h.body.removeChild(y),d("attestation aborted")};this.abortController.signal.addEventListener("abort",p);let y=h.createElement("iframe");y.src=c,y.style.display="none",y.addEventListener("error",p,{signal:this.abortController.signal});let w=m=>{if(m.data&&typeof m.data=="string")try{let b=JSON.parse(m.data);if(b.type==="verify_attestation"){if(Te(b.attestation).payload.id!==a)return;clearInterval(u),h.body.removeChild(y),this.abortController.signal.removeEventListener("abort",p),window.removeEventListener("message",w),g(b.attestation===null?"":b.attestation)}}catch(b){this.logger.warn(b)}};h.body.appendChild(y),window.addEventListener("message",w,{signal:this.abortController.signal})});return this.logger.debug("jwt attestation",l),l}catch(h){this.logger.warn(h)}return""},this.resolve=async r=>{if(this.isDevEnv)return"";let{attestationId:n,hash:a,encryptedId:o}=r;if(n===""){this.logger.debug("resolve: attestationId is empty, skipping");return}if(n){if(Te(n).payload.id!==o)return;let h=await this.isValidJwtAttestation(n);if(h){if(!h.isVerified){this.logger.warn("resolve: jwt attestation: origin url not verified");return}return h}}if(!a)return;let c=this.getVerifyUrl(r?.verifyUrl);return this.fetchAttestation(a,c)},this.fetchAttestation=async(r,n)=>{this.logger.debug(`resolving attestation: ${r} from url: ${n}`);let a=this.startAbortTimer(v.ONE_SECOND*5),o=await fetch(`${n}/attestation/${r}?v2Supported=true`,{signal:this.abortController.signal});return clearTimeout(a),o.status===200?await o.json():void 0},this.getVerifyUrl=r=>{let n=r||Ot;return pp.includes(n)||(this.logger.info(`verify url: ${n}, not included in trusted list, assigning default: ${Ot}`),n=Ot),n},this.fetchPublicKey=async()=>{try{this.logger.debug(`fetching public key from: ${this.verifyUrlV3}`);let r=this.startAbortTimer(v.FIVE_SECONDS),n=await fetch(`${this.verifyUrlV3}/public-key`,{signal:this.abortController.signal});return clearTimeout(r),await n.json()}catch(r){this.logger.warn(r)}},this.persistPublicKey=async r=>{this.logger.debug("persisting public key to local storage",r),await this.store.setItem(this.storeKey,r),this.publicKey=r},this.removePublicKey=async()=>{this.logger.debug("removing verify v2 public key from storage"),await this.store.removeItem(this.storeKey),this.publicKey=void 0},this.isValidJwtAttestation=async r=>{let n=await this.getPublicKey();try{if(n)return this.validateAttestation(r,n)}catch(o){this.logger.error(o),this.logger.warn("error validating attestation")}let a=await this.fetchAndPersistPublicKey();try{if(a)return this.validateAttestation(r,a)}catch(o){this.logger.error(o),this.logger.warn("error validating attestation")}},this.getPublicKey=async()=>this.publicKey?this.publicKey:await this.fetchAndPersistPublicKey(),this.fetchAndPersistPublicKey=async()=>{if(this.fetchPromise)return await this.fetchPromise,this.publicKey;this.fetchPromise=new Promise(async n=>{let a=await this.fetchPublicKey();a&&(await this.persistPublicKey(a),n(a))});let r=await this.fetchPromise;return this.fetchPromise=void 0,r},this.validateAttestation=(r,n)=>{let a=io(r,n.publicKey),o={hasExpired:(0,v.toMiliseconds)(a.exp)<Date.now(),payload:a};if(o.hasExpired)throw this.logger.warn("resolve: jwt attestation expired"),new Error("JWT attestation expired");return{origin:o.payload.origin,isScam:o.payload.isScam,isVerified:o.payload.isVerified}},this.logger=N(t,this.name),this.abortController=new AbortController,this.isDevEnv=Yt(),this.init()}get storeKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//verify:public:key"}get context(){return D(this.logger)}startAbortTimer(e){return this.abortController=new AbortController,setTimeout(()=>this.abortController.abort(),(0,v.toMiliseconds)(e))}},Dr=class extends Bs{constructor(e,t){super(e,t),this.projectId=e,this.logger=t,this.context=dp,this.registerDeviceToken=async s=>{let{clientId:r,token:n,notificationType:a,enableEncrypted:o=!1}=s,c=`${gp}/${this.projectId}/clients`;await fetch(c,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({client_id:r,type:a,token:n,always_raw:o})})},this.logger=N(t,this.context)}},Jd=Object.defineProperty,$o=Object.getOwnPropertySymbols,Yd=Object.prototype.hasOwnProperty,Wd=Object.prototype.propertyIsEnumerable,ko=(i,e,t)=>e in i?Jd(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,is=(i,e)=>{for(var t in e||(e={}))Yd.call(e,t)&&ko(i,t,e[t]);if($o)for(var t of $o(e))Wd.call(e,t)&&ko(i,t,e[t]);return i},Lr=class extends Gs{constructor(e,t,s=!0){super(e,t,s),this.core=e,this.logger=t,this.context=fp,this.storagePrefix=Ae,this.storageVersion=yp,this.events=new Map,this.shouldPersist=!1,this.init=async()=>{if(!Yt())try{let r={eventId:Ji(),timestamp:Date.now(),domain:this.getAppDomain(),props:{event:"INIT",type:"",properties:{client_id:await this.core.crypto.getClientId(),user_agent:zi(this.core.relayer.protocol,this.core.relayer.version,gr)}}};await this.sendEvent([r])}catch(r){this.logger.warn(r)}},this.createEvent=r=>{let{event:n="ERROR",type:a="",properties:{topic:o,trace:c}}=r,h=Ji(),u=this.core.projectId||"",l=Date.now(),g=is({eventId:h,timestamp:l,props:{event:n,type:a,properties:{topic:o,trace:c}},bundleId:u,domain:this.getAppDomain()},this.setMethods(h));return this.telemetryEnabled&&(this.events.set(h,g),this.shouldPersist=!0),g},this.getEvent=r=>{let{eventId:n,topic:a}=r;if(n)return this.events.get(n);let o=Array.from(this.events.values()).find(c=>c.props.properties.topic===a);if(o)return is(is({},o),this.setMethods(o.eventId))},this.deleteEvent=r=>{let{eventId:n}=r;this.events.delete(n),this.shouldPersist=!0},this.setEventListeners=()=>{this.core.heartbeat.on(pe.pulse,async()=>{this.shouldPersist&&await this.persist(),this.events.forEach(r=>{(0,v.fromMiliseconds)(Date.now())-(0,v.fromMiliseconds)(r.timestamp)>mp&&(this.events.delete(r.eventId),this.shouldPersist=!0)})})},this.setMethods=r=>({addTrace:n=>this.addTrace(r,n),setError:n=>this.setError(r,n)}),this.addTrace=(r,n)=>{let a=this.events.get(r);a&&(a.props.properties.trace.push(n),this.events.set(r,a),this.shouldPersist=!0)},this.setError=(r,n)=>{let a=this.events.get(r);a&&(a.props.type=n,a.timestamp=Date.now(),this.events.set(r,a),this.shouldPersist=!0)},this.persist=async()=>{await this.core.storage.setItem(this.storageKey,Array.from(this.events.values())),this.shouldPersist=!1},this.restore=async()=>{try{let r=await this.core.storage.getItem(this.storageKey)||[];if(!r.length)return;r.forEach(n=>{this.events.set(n.eventId,is(is({},n),this.setMethods(n.eventId)))})}catch(r){this.logger.warn(r)}},this.submit=async()=>{if(!this.telemetryEnabled||this.events.size===0)return;let r=[];for(let[n,a]of this.events)a.props.type&&r.push(a);if(r.length!==0)try{if((await this.sendEvent(r)).ok)for(let n of r)this.events.delete(n.eventId),this.shouldPersist=!0}catch(n){this.logger.warn(n)}},this.sendEvent=async r=>{let n=this.getAppDomain()?"":"&sp=desktop";return await fetch(`${wp}?projectId=${this.core.projectId}&st=events_sdk&sv=js-${gr}${n}`,{method:"POST",body:JSON.stringify(r)})},this.getAppDomain=()=>Xs().url,this.logger=N(t,this.context),this.telemetryEnabled=s,s?this.restore().then(async()=>{await this.submit(),this.setEventListeners()}):this.persist()}get storageKey(){return this.storagePrefix+this.storageVersion+this.core.customStoragePrefix+"//"+this.context}},Xd=Object.defineProperty,jo=Object.getOwnPropertySymbols,Qd=Object.prototype.hasOwnProperty,Zd=Object.prototype.propertyIsEnumerable,Mo=(i,e,t)=>e in i?Xd(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,Vo=(i,e)=>{for(var t in e||(e={}))Qd.call(e,t)&&Mo(i,t,e[t]);if(jo)for(var t of jo(e))Zd.call(e,t)&&Mo(i,t,e[t]);return i},rs=class extends Us{constructor(e){var t;super(e),this.protocol=Bo,this.version=Go,this.name=Ur,this.events=new je.EventEmitter,this.initialized=!1,this.on=(a,o)=>this.events.on(a,o),this.once=(a,o)=>this.events.once(a,o),this.off=(a,o)=>this.events.off(a,o),this.removeListener=(a,o)=>this.events.removeListener(a,o),this.dispatchEnvelope=({topic:a,message:o,sessionExists:c})=>{if(!a||!o)return;let h={topic:a,message:o,publishedAt:Date.now(),transportType:$.link_mode};this.relayer.onLinkMessageEvent(h,{sessionExists:c})},this.projectId=e?.projectId,this.relayUrl=e?.relayUrl||Ho,this.customStoragePrefix=e!=null&&e.customStoragePrefix?`:${e.customStoragePrefix}`:"";let s=Be({level:typeof e?.logger=="string"&&e.logger?e.logger:$u.logger}),{logger:r,chunkLoggerController:n}=Ps({opts:s,maxSizeInBytes:e?.maxLogBlobSizeInBytes,loggerOverride:e?.logger});this.logChunkController=n,(t=this.logChunkController)!=null&&t.downloadLogsBlobInBrowser&&(window.downloadLogsBlobInBrowser=async()=>{var a,o;(a=this.logChunkController)!=null&&a.downloadLogsBlobInBrowser&&((o=this.logChunkController)==null||o.downloadLogsBlobInBrowser({clientId:await this.crypto.getClientId()}))}),this.logger=N(r,this.name),this.heartbeat=new Rs,this.crypto=new Sr(this,this.logger,e?.keychain),this.history=new Ar(this,this.logger),this.expirer=new Cr(this,this.logger),this.storage=e!=null&&e.storage?e.storage:new Os(Vo(Vo({},ku),e?.storageOptions)),this.relayer=new Nr({core:this,logger:this.logger,relayUrl:this.relayUrl,projectId:this.projectId}),this.pairing=new xr(this,this.logger),this.verify=new Fr(this,this.logger,this.storage),this.echoClient=new Dr(this.projectId||"",this.logger),this.linkModeSupportedApps=[],this.eventClient=new Lr(this,this.logger,e?.telemetryEnabled)}static async init(e){let t=new rs(e);await t.initialize();let s=await t.crypto.getClientId();return await t.storage.setItem(Zu,s),t}get context(){return D(this.logger)}async start(){this.initialized||await this.initialize()}async getLogsBlob(){var e;return(e=this.logChunkController)==null?void 0:e.logsToBlob({clientId:await this.crypto.getClientId()})}async addLinkModeSupportedApp(e){this.linkModeSupportedApps.includes(e)||(this.linkModeSupportedApps.push(e),await this.storage.setItem(Io,this.linkModeSupportedApps))}async initialize(){this.logger.trace("Initialized");try{await this.crypto.init(),await this.history.init(),await this.expirer.init(),await this.relayer.init(),await this.heartbeat.init(),await this.pairing.init(),this.eventClient.init(),this.linkModeSupportedApps=await this.storage.getItem(Io)||[],this.initialized=!0,this.logger.info("Core Initialization Success")}catch(e){throw this.logger.warn(`Core Initialization Failure at epoch ${Date.now()}`,e),this.logger.error(e.message),e}}},nc=rs;var ai=O(Mt()),T=O(Vt());var hc="wc",lc=2,uc="client",Hr=`${hc}@${lc}:${uc}:`,$r={name:uc,logger:"error",controller:!1,relayUrl:"wss://relay.walletconnect.org"};var ac="WALLETCONNECT_DEEPLINK_CHOICE";var eg="proposal";var tg="Proposal expired",sg="session",Nt=T.SEVEN_DAYS,ig="engine",H={wc_sessionPropose:{req:{ttl:T.FIVE_MINUTES,prompt:!0,tag:1100},res:{ttl:T.FIVE_MINUTES,prompt:!1,tag:1101},reject:{ttl:T.FIVE_MINUTES,prompt:!1,tag:1120},autoReject:{ttl:T.FIVE_MINUTES,prompt:!1,tag:1121}},wc_sessionSettle:{req:{ttl:T.FIVE_MINUTES,prompt:!1,tag:1102},res:{ttl:T.FIVE_MINUTES,prompt:!1,tag:1103}},wc_sessionUpdate:{req:{ttl:T.ONE_DAY,prompt:!1,tag:1104},res:{ttl:T.ONE_DAY,prompt:!1,tag:1105}},wc_sessionExtend:{req:{ttl:T.ONE_DAY,prompt:!1,tag:1106},res:{ttl:T.ONE_DAY,prompt:!1,tag:1107}},wc_sessionRequest:{req:{ttl:T.FIVE_MINUTES,prompt:!0,tag:1108},res:{ttl:T.FIVE_MINUTES,prompt:!1,tag:1109}},wc_sessionEvent:{req:{ttl:T.FIVE_MINUTES,prompt:!0,tag:1110},res:{ttl:T.FIVE_MINUTES,prompt:!1,tag:1111}},wc_sessionDelete:{req:{ttl:T.ONE_DAY,prompt:!1,tag:1112},res:{ttl:T.ONE_DAY,prompt:!1,tag:1113}},wc_sessionPing:{req:{ttl:T.ONE_DAY,prompt:!1,tag:1114},res:{ttl:T.ONE_DAY,prompt:!1,tag:1115}},wc_sessionAuthenticate:{req:{ttl:T.ONE_HOUR,prompt:!0,tag:1116},res:{ttl:T.ONE_HOUR,prompt:!1,tag:1117},reject:{ttl:T.FIVE_MINUTES,prompt:!1,tag:1118},autoReject:{ttl:T.FIVE_MINUTES,prompt:!1,tag:1119}}},kr={min:T.FIVE_MINUTES,max:T.SEVEN_DAYS},Fe={idle:"IDLE",active:"ACTIVE"},rg="request",ng=["wc_sessionPropose","wc_sessionRequest","wc_authRequest","wc_sessionAuthenticate"],ag="wc";var og="auth",cg="authKeys",hg="pairingTopics",lg="requests",oi=`${ag}@${1.5}:${og}:`,ri=`${oi}:PUB_KEY`,ug=Object.defineProperty,pg=Object.defineProperties,dg=Object.getOwnPropertyDescriptors,oc=Object.getOwnPropertySymbols,gg=Object.prototype.hasOwnProperty,yg=Object.prototype.propertyIsEnumerable,cc=(i,e,t)=>e in i?ug(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,K=(i,e)=>{for(var t in e||(e={}))gg.call(e,t)&&cc(i,t,e[t]);if(oc)for(var t of oc(e))yg.call(e,t)&&cc(i,t,e[t]);return i},Ie=(i,e)=>pg(i,dg(e)),jr=class extends Js{constructor(e){super(e),this.name=ig,this.events=new ai.default,this.initialized=!1,this.requestQueue={state:Fe.idle,queue:[]},this.sessionRequestQueue={state:Fe.idle,queue:[]},this.requestQueueDelay=T.ONE_SECOND,this.expectedPairingMethodMap=new Map,this.recentlyDeletedMap=new Map,this.recentlyDeletedLimit=200,this.relayMessageCache=[],this.init=async()=>{this.initialized||(await this.cleanup(),this.registerRelayerEvents(),this.registerExpirerEvents(),this.registerPairingEvents(),await this.registerLinkModeListeners(),this.client.core.pairing.register({methods:Object.keys(H)}),this.initialized=!0,setTimeout(()=>{this.sessionRequestQueue.queue=this.getPendingSessionRequests(),this.processSessionRequestQueue()},(0,T.toMiliseconds)(this.requestQueueDelay)))},this.connect=async t=>{this.isInitialized(),await this.confirmOnlineStateOrThrow();let s=Ie(K({},t),{requiredNamespaces:t.requiredNamespaces||{},optionalNamespaces:t.optionalNamespaces||{}});await this.isValidConnect(s);let{pairingTopic:r,requiredNamespaces:n,optionalNamespaces:a,sessionProperties:o,relays:c}=s,h=r,u,l=!1;try{h&&(l=this.client.core.pairing.pairings.get(h).active)}catch(E){throw this.client.logger.error(`connect() -> pairing.get(${h}) failed`),E}if(!h||!l){let{topic:E,uri:I}=await this.client.core.pairing.create();h=E,u=I}if(!h){let{message:E}=f("NO_MATCHING_KEY",`connect() pairing topic: ${h}`);throw new Error(E)}let g=await this.client.core.crypto.generateKeyPair(),d=H.wc_sessionPropose.req.ttl||T.FIVE_MINUTES,p=B(d),y=K({requiredNamespaces:n,optionalNamespaces:a,relays:c??[{protocol:qr}],proposer:{publicKey:g,metadata:this.client.metadata},expiryTimestamp:p,pairingTopic:h},o&&{sessionProperties:o}),{reject:w,resolve:m,done:b}=ke(d,tg);this.events.once(S("session_connect"),async({error:E,session:I})=>{if(E)w(E);else if(I){I.self.publicKey=g;let F=Ie(K({},I),{pairingTopic:y.pairingTopic,requiredNamespaces:y.requiredNamespaces,optionalNamespaces:y.optionalNamespaces,transportType:$.relay});await this.client.session.set(I.topic,F),await this.setExpiry(I.topic,I.expiry),h&&await this.client.core.pairing.updateMetadata({topic:h,metadata:I.peer.metadata}),this.cleanupDuplicatePairings(F),m(F)}});let P=await this.sendRequest({topic:h,method:"wc_sessionPropose",params:y,throwOnFailedPublish:!0});return await this.setProposal(P,K({id:P},y)),{uri:u,approval:b}},this.pair=async t=>{this.isInitialized(),await this.confirmOnlineStateOrThrow();try{return await this.client.core.pairing.pair(t)}catch(s){throw this.client.logger.error("pair() failed"),s}},this.approve=async t=>{var s,r,n;let a=this.client.core.eventClient.createEvent({properties:{topic:(s=t?.id)==null?void 0:s.toString(),trace:[ge.session_approve_started]}});try{this.isInitialized(),await this.confirmOnlineStateOrThrow()}catch(R){throw a.setError(Ze.no_internet_connection),R}try{await this.isValidProposalId(t?.id)}catch(R){throw this.client.logger.error(`approve() -> proposal.get(${t?.id}) failed`),a.setError(Ze.proposal_not_found),R}try{await this.isValidApprove(t)}catch(R){throw this.client.logger.error("approve() -> isValidApprove() failed"),a.setError(Ze.session_approve_namespace_validation_failure),R}let{id:o,relayProtocol:c,namespaces:h,sessionProperties:u,sessionConfig:l}=t,g=this.client.proposal.get(o);this.client.core.eventClient.deleteEvent({eventId:a.eventId});let{pairingTopic:d,proposer:p,requiredNamespaces:y,optionalNamespaces:w}=g,m=(r=this.client.core.eventClient)==null?void 0:r.getEvent({topic:d});m||(m=(n=this.client.core.eventClient)==null?void 0:n.createEvent({type:ge.session_approve_started,properties:{topic:d,trace:[ge.session_approve_started,ge.session_namespaces_validation_success]}}));let b=await this.client.core.crypto.generateKeyPair(),P=p.publicKey,E=await this.client.core.crypto.generateSharedKey(b,P),I=K(K({relay:{protocol:c??"irn"},namespaces:h,controller:{publicKey:b,metadata:this.client.metadata},expiry:B(Nt)},u&&{sessionProperties:u}),l&&{sessionConfig:l}),F=$.relay;m.addTrace(ge.subscribing_session_topic);try{await this.client.core.relayer.subscribe(E,{transportType:F})}catch(R){throw m.setError(Ze.subscribe_session_topic_failure),R}m.addTrace(ge.subscribe_session_topic_success);let C=Ie(K({},I),{topic:E,requiredNamespaces:y,optionalNamespaces:w,pairingTopic:d,acknowledged:!1,self:I.controller,peer:{publicKey:p.publicKey,metadata:p.metadata},controller:b,transportType:$.relay});await this.client.session.set(E,C),m.addTrace(ge.store_session);try{m.addTrace(ge.publishing_session_settle),await this.sendRequest({topic:E,method:"wc_sessionSettle",params:I,throwOnFailedPublish:!0}).catch(R=>{throw m?.setError(Ze.session_settle_publish_failure),R}),m.addTrace(ge.session_settle_publish_success),m.addTrace(ge.publishing_session_approve),await this.sendResult({id:o,topic:d,result:{relay:{protocol:c??"irn"},responderPublicKey:b},throwOnFailedPublish:!0}).catch(R=>{throw m?.setError(Ze.session_approve_publish_failure),R}),m.addTrace(ge.session_approve_publish_success)}catch(R){throw this.client.logger.error(R),this.client.session.delete(E,L("USER_DISCONNECTED")),await this.client.core.relayer.unsubscribe(E),R}return this.client.core.eventClient.deleteEvent({eventId:m.eventId}),await this.client.core.pairing.updateMetadata({topic:d,metadata:p.metadata}),await this.client.proposal.delete(o,L("USER_DISCONNECTED")),await this.client.core.pairing.activate({topic:d}),await this.setExpiry(E,B(Nt)),{topic:E,acknowledged:()=>Promise.resolve(this.client.session.get(E))}},this.reject=async t=>{this.isInitialized(),await this.confirmOnlineStateOrThrow();try{await this.isValidReject(t)}catch(a){throw this.client.logger.error("reject() -> isValidReject() failed"),a}let{id:s,reason:r}=t,n;try{n=this.client.proposal.get(s).pairingTopic}catch(a){throw this.client.logger.error(`reject() -> proposal.get(${s}) failed`),a}n&&(await this.sendError({id:s,topic:n,error:r,rpcOpts:H.wc_sessionPropose.reject}),await this.client.proposal.delete(s,L("USER_DISCONNECTED")))},this.update=async t=>{this.isInitialized(),await this.confirmOnlineStateOrThrow();try{await this.isValidUpdate(t)}catch(l){throw this.client.logger.error("update() -> isValidUpdate() failed"),l}let{topic:s,namespaces:r}=t,{done:n,resolve:a,reject:o}=ke(),c=at(),h=me().toString(),u=this.client.session.get(s).namespaces;return this.events.once(S("session_update",c),({error:l})=>{l?o(l):a()}),await this.client.session.update(s,{namespaces:r}),await this.sendRequest({topic:s,method:"wc_sessionUpdate",params:{namespaces:r},throwOnFailedPublish:!0,clientRpcId:c,relayRpcId:h}).catch(l=>{this.client.logger.error(l),this.client.session.update(s,{namespaces:u}),o(l)}),{acknowledged:n}},this.extend=async t=>{this.isInitialized(),await this.confirmOnlineStateOrThrow();try{await this.isValidExtend(t)}catch(c){throw this.client.logger.error("extend() -> isValidExtend() failed"),c}let{topic:s}=t,r=at(),{done:n,resolve:a,reject:o}=ke();return this.events.once(S("session_extend",r),({error:c})=>{c?o(c):a()}),await this.setExpiry(s,B(Nt)),this.sendRequest({topic:s,method:"wc_sessionExtend",params:{},clientRpcId:r,throwOnFailedPublish:!0}).catch(c=>{o(c)}),{acknowledged:n}},this.request=async t=>{this.isInitialized();try{await this.isValidRequest(t)}catch(p){throw this.client.logger.error("request() -> isValidRequest() failed"),p}let{chainId:s,request:r,topic:n,expiry:a=H.wc_sessionRequest.req.ttl}=t,o=this.client.session.get(n);o?.transportType===$.relay&&await this.confirmOnlineStateOrThrow();let c=at(),h=me().toString(),{done:u,resolve:l,reject:g}=ke(a,"Request expired. Please try again.");this.events.once(S("session_request",c),({error:p,result:y})=>{p?g(p):l(y)});let d=this.getAppLinkIfEnabled(o.peer.metadata,o.transportType);return d?(await this.sendRequest({clientRpcId:c,relayRpcId:h,topic:n,method:"wc_sessionRequest",params:{request:Ie(K({},r),{expiryTimestamp:B(a)}),chainId:s},expiry:a,throwOnFailedPublish:!0,appLink:d}).catch(p=>g(p)),this.client.events.emit("session_request_sent",{topic:n,request:r,chainId:s,id:c}),await u()):await Promise.all([new Promise(async p=>{await this.sendRequest({clientRpcId:c,relayRpcId:h,topic:n,method:"wc_sessionRequest",params:{request:Ie(K({},r),{expiryTimestamp:B(a)}),chainId:s},expiry:a,throwOnFailedPublish:!0}).catch(y=>g(y)),this.client.events.emit("session_request_sent",{topic:n,request:r,chainId:s,id:c}),p()}),new Promise(async p=>{var y;if(!((y=o.sessionConfig)!=null&&y.disableDeepLink)){let w=await Ma(this.client.core.storage,ac);await ja({id:c,topic:n,wcDeepLink:w})}p()}),u()]).then(p=>p[2])},this.respond=async t=>{this.isInitialized(),await this.isValidRespond(t);let{topic:s,response:r}=t,{id:n}=r,a=this.client.session.get(s);a.transportType===$.relay&&await this.confirmOnlineStateOrThrow();let o=this.getAppLinkIfEnabled(a.peer.metadata,a.transportType);ce(r)?await this.sendResult({id:n,topic:s,result:r.result,throwOnFailedPublish:!0,appLink:o}):se(r)&&await this.sendError({id:n,topic:s,error:r.error,appLink:o}),this.cleanupAfterResponse(t)},this.ping=async t=>{this.isInitialized(),await this.confirmOnlineStateOrThrow();try{await this.isValidPing(t)}catch(r){throw this.client.logger.error("ping() -> isValidPing() failed"),r}let{topic:s}=t;if(this.client.session.keys.includes(s)){let r=at(),n=me().toString(),{done:a,resolve:o,reject:c}=ke();this.events.once(S("session_ping",r),({error:h})=>{h?c(h):o()}),await Promise.all([this.sendRequest({topic:s,method:"wc_sessionPing",params:{},throwOnFailedPublish:!0,clientRpcId:r,relayRpcId:n}),a()])}else this.client.core.pairing.pairings.keys.includes(s)&&await this.client.core.pairing.ping({topic:s})},this.emit=async t=>{this.isInitialized(),await this.confirmOnlineStateOrThrow(),await this.isValidEmit(t);let{topic:s,event:r,chainId:n}=t,a=me().toString();await this.sendRequest({topic:s,method:"wc_sessionEvent",params:{event:r,chainId:n},throwOnFailedPublish:!0,relayRpcId:a})},this.disconnect=async t=>{this.isInitialized(),await this.confirmOnlineStateOrThrow(),await this.isValidDisconnect(t);let{topic:s}=t;if(this.client.session.keys.includes(s))await this.sendRequest({topic:s,method:"wc_sessionDelete",params:L("USER_DISCONNECTED"),throwOnFailedPublish:!0}),await this.deleteSession({topic:s,emitEvent:!1});else if(this.client.core.pairing.pairings.keys.includes(s))await this.client.core.pairing.disconnect({topic:s});else{let{message:r}=f("MISMATCHED_TOPIC",`Session or pairing topic not found: ${s}`);throw new Error(r)}},this.find=t=>(this.isInitialized(),this.client.session.getAll().filter(s=>ro(s,t))),this.getPendingSessionRequests=()=>this.client.pendingRequest.getAll(),this.authenticate=async(t,s)=>{var r;this.isInitialized(),this.isValidAuthenticate(t);let n=s&&this.client.core.linkModeSupportedApps.includes(s)&&((r=this.client.metadata.redirect)==null?void 0:r.linkMode),a=n?$.link_mode:$.relay;a===$.relay&&await this.confirmOnlineStateOrThrow();let{chains:o,statement:c="",uri:h,domain:u,nonce:l,type:g,exp:d,nbf:p,methods:y=[],expiry:w}=t,m=[...t.resources||[]],{topic:b,uri:P}=await this.client.core.pairing.create({methods:["wc_sessionAuthenticate"],transportType:a});this.client.logger.info({message:"Generated new pairing",pairing:{topic:b,uri:P}});let E=await this.client.core.crypto.generateKeyPair(),I=_t(E);if(await Promise.all([this.client.auth.authKeys.set(ri,{responseTopic:I,publicKey:E}),this.client.auth.pairingTopics.set(I,{topic:I,pairingTopic:b})]),await this.client.core.relayer.subscribe(I,{transportType:a}),this.client.logger.info(`sending request to new pairing topic: ${b}`),y.length>0){let{namespace:ie}=Gt(o[0]),J=za(ie,"request",y);Xt(m)&&(J=Ba(J,m.pop())),m.push(J)}let F=w&&w>H.wc_sessionAuthenticate.req.ttl?w:H.wc_sessionAuthenticate.req.ttl,C={authPayload:{type:g??"caip122",chains:o,statement:c,aud:h,domain:u,version:"1",nonce:l,iat:new Date().toISOString(),exp:d,nbf:p,resources:m},requester:{publicKey:E,metadata:this.client.metadata},expiryTimestamp:B(F)},R={eip155:{chains:o,methods:[...new Set(["personal_sign",...y])],events:["chainChanged","accountsChanged"]}},ue={requiredNamespaces:{},optionalNamespaces:R,relays:[{protocol:"irn"}],pairingTopic:b,proposer:{publicKey:E,metadata:this.client.metadata},expiryTimestamp:B(H.wc_sessionPropose.req.ttl)},{done:ll,resolve:Vn,reject:Ci}=ke(F,"Request expired"),vs=async({error:ie,session:J})=>{if(this.events.off(S("session_request",rt),Fi),ie)Ci(ie);else if(J){J.self.publicKey=E,await this.client.session.set(J.topic,J),await this.setExpiry(J.topic,J.expiry),b&&await this.client.core.pairing.updateMetadata({topic:b,metadata:J.peer.metadata});let _s=this.client.session.get(J.topic);await this.deleteProposal($t),Vn({session:_s})}},Fi=async ie=>{var J,_s,zn;if(await this.deletePendingAuthRequest(rt,{message:"fulfilled",code:0}),ie.error){let jt=L("WC_METHOD_UNSUPPORTED","wc_sessionAuthenticate");return ie.error.code===jt.code?void 0:(this.events.off(S("session_connect"),vs),Ci(ie.error.message))}await this.deleteProposal($t),this.events.off(S("session_connect"),vs);let{cacaos:Bn,responder:nt}=ie.result,Di=[],Gn=[];for(let jt of Bn){await Wi({cacao:jt,projectId:this.client.core.projectId})||(this.client.logger.error(jt,"Signature verification failed"),Ci(L("SESSION_SETTLEMENT_FAILED","Signature verification failed")));let{p:Li}=jt,Ui=Xt(Li.resources),Hn=[Zs(Li.iss)],ul=Wt(Li.iss);if(Ui){let qi=Qi(Ui),pl=Zi(Ui);Di.push(...qi),Hn.push(...pl)}for(let qi of Hn)Gn.push(`${qi}:${ul}`)}let kt=await this.client.core.crypto.generateSharedKey(E,nt.publicKey),Is;Di.length>0&&(Is={topic:kt,acknowledged:!0,self:{publicKey:E,metadata:this.client.metadata},peer:nt,controller:nt.publicKey,expiry:B(Nt),requiredNamespaces:{},optionalNamespaces:{},relay:{protocol:"irn"},pairingTopic:b,namespaces:ar([...new Set(Di)],[...new Set(Gn)]),transportType:a},await this.client.core.relayer.subscribe(kt,{transportType:a}),await this.client.session.set(kt,Is),b&&await this.client.core.pairing.updateMetadata({topic:b,metadata:nt.metadata}),Is=this.client.session.get(kt)),(J=this.client.metadata.redirect)!=null&&J.linkMode&&(_s=nt.metadata.redirect)!=null&&_s.linkMode&&(zn=nt.metadata.redirect)!=null&&zn.universal&&s&&(this.client.core.addLinkModeSupportedApp(nt.metadata.redirect.universal),this.client.session.update(kt,{transportType:$.link_mode})),Vn({auths:Bn,session:Is})},rt=at(),$t=at();this.events.once(S("session_connect"),vs),this.events.once(S("session_request",rt),Fi);let Kn;try{if(n){let ie=we("wc_sessionAuthenticate",C,rt);this.client.core.history.set(b,ie);let J=await this.client.core.crypto.encode("",ie,{type:vt,encoding:Et});Kn=Zt(s,b,J)}else await Promise.all([this.sendRequest({topic:b,method:"wc_sessionAuthenticate",params:C,expiry:t.expiry,throwOnFailedPublish:!0,clientRpcId:rt}),this.sendRequest({topic:b,method:"wc_sessionPropose",params:ue,expiry:H.wc_sessionPropose.req.ttl,throwOnFailedPublish:!0,clientRpcId:$t})])}catch(ie){throw this.events.off(S("session_connect"),vs),this.events.off(S("session_request",rt),Fi),ie}return await this.setProposal($t,K({id:$t},ue)),await this.setAuthRequest(rt,{request:Ie(K({},C),{verifyContext:{}}),pairingTopic:b,transportType:a}),{uri:Kn??P,response:ll}},this.approveSessionAuthenticate=async t=>{let{id:s,auths:r}=t,n=this.client.core.eventClient.createEvent({properties:{topic:s.toString(),trace:[et.authenticated_session_approve_started]}});try{this.isInitialized()}catch(w){throw n.setError(Pt.no_internet_connection),w}let a=this.getPendingAuthRequest(s);if(!a)throw n.setError(Pt.authenticated_session_pending_request_not_found),new Error(`Could not find pending auth request with id ${s}`);let o=a.transportType||$.relay;o===$.relay&&await this.confirmOnlineStateOrThrow();let c=a.requester.publicKey,h=await this.client.core.crypto.generateKeyPair(),u=_t(c),l={type:be,receiverPublicKey:c,senderPublicKey:h},g=[],d=[];for(let w of r){if(!await Wi({cacao:w,projectId:this.client.core.projectId})){n.setError(Pt.invalid_cacao);let I=L("SESSION_SETTLEMENT_FAILED","Signature verification failed");throw await this.sendError({id:s,topic:u,error:I,encodeOpts:l}),new Error(I.message)}n.addTrace(et.cacaos_verified);let{p:m}=w,b=Xt(m.resources),P=[Zs(m.iss)],E=Wt(m.iss);if(b){let I=Qi(b),F=Zi(b);g.push(...I),P.push(...F)}for(let I of P)d.push(`${I}:${E}`)}let p=await this.client.core.crypto.generateSharedKey(h,c);n.addTrace(et.create_authenticated_session_topic);let y;if(g?.length>0){y={topic:p,acknowledged:!0,self:{publicKey:h,metadata:this.client.metadata},peer:{publicKey:c,metadata:a.requester.metadata},controller:c,expiry:B(Nt),authentication:r,requiredNamespaces:{},optionalNamespaces:{},relay:{protocol:"irn"},pairingTopic:a.pairingTopic,namespaces:ar([...new Set(g)],[...new Set(d)]),transportType:o},n.addTrace(et.subscribing_authenticated_session_topic);try{await this.client.core.relayer.subscribe(p,{transportType:o})}catch(w){throw n.setError(Pt.subscribe_authenticated_session_topic_failure),w}n.addTrace(et.subscribe_authenticated_session_topic_success),await this.client.session.set(p,y),n.addTrace(et.store_authenticated_session),await this.client.core.pairing.updateMetadata({topic:a.pairingTopic,metadata:a.requester.metadata})}n.addTrace(et.publishing_authenticated_session_approve);try{await this.sendResult({topic:u,id:s,result:{cacaos:r,responder:{publicKey:h,metadata:this.client.metadata}},encodeOpts:l,throwOnFailedPublish:!0,appLink:this.getAppLinkIfEnabled(a.requester.metadata,o)})}catch(w){throw n.setError(Pt.authenticated_session_approve_publish_failure),w}return await this.client.auth.requests.delete(s,{message:"fulfilled",code:0}),await this.client.core.pairing.activate({topic:a.pairingTopic}),this.client.core.eventClient.deleteEvent({eventId:n.eventId}),{session:y}},this.rejectSessionAuthenticate=async t=>{this.isInitialized();let{id:s,reason:r}=t,n=this.getPendingAuthRequest(s);if(!n)throw new Error(`Could not find pending auth request with id ${s}`);n.transportType===$.relay&&await this.confirmOnlineStateOrThrow();let a=n.requester.publicKey,o=await this.client.core.crypto.generateKeyPair(),c=_t(a),h={type:be,receiverPublicKey:a,senderPublicKey:o};await this.sendError({id:s,topic:c,error:r,encodeOpts:h,rpcOpts:H.wc_sessionAuthenticate.reject,appLink:this.getAppLinkIfEnabled(n.requester.metadata,n.transportType)}),await this.client.auth.requests.delete(s,{message:"rejected",code:0}),await this.client.proposal.delete(s,L("USER_DISCONNECTED"))},this.formatAuthMessage=t=>{this.isInitialized();let{request:s,iss:r}=t;return Xi(s,r)},this.processRelayMessageCache=()=>{setTimeout(async()=>{if(this.relayMessageCache.length!==0)for(;this.relayMessageCache.length>0;)try{let t=this.relayMessageCache.shift();t&&await this.onRelayMessage(t)}catch(t){this.client.logger.error(t)}},50)},this.cleanupDuplicatePairings=async t=>{if(t.pairingTopic)try{let s=this.client.core.pairing.pairings.get(t.pairingTopic),r=this.client.core.pairing.pairings.getAll().filter(n=>{var a,o;return((a=n.peerMetadata)==null?void 0:a.url)&&((o=n.peerMetadata)==null?void 0:o.url)===t.peer.metadata.url&&n.topic&&n.topic!==s.topic});if(r.length===0)return;this.client.logger.info(`Cleaning up ${r.length} duplicate pairing(s)`),await Promise.all(r.map(n=>this.client.core.pairing.disconnect({topic:n.topic}))),this.client.logger.info("Duplicate pairings clean up finished")}catch(s){this.client.logger.error(s)}},this.deleteSession=async t=>{var s;let{topic:r,expirerHasDeleted:n=!1,emitEvent:a=!0,id:o=0}=t,{self:c}=this.client.session.get(r);await this.client.core.relayer.unsubscribe(r),await this.client.session.delete(r,L("USER_DISCONNECTED")),this.addToRecentlyDeleted(r,"session"),this.client.core.crypto.keychain.has(c.publicKey)&&await this.client.core.crypto.deleteKeyPair(c.publicKey),this.client.core.crypto.keychain.has(r)&&await this.client.core.crypto.deleteSymKey(r),n||this.client.core.expirer.del(r),this.client.core.storage.removeItem(ac).catch(h=>this.client.logger.warn(h)),this.getPendingSessionRequests().forEach(h=>{h.topic===r&&this.deletePendingSessionRequest(h.id,L("USER_DISCONNECTED"))}),r===((s=this.sessionRequestQueue.queue[0])==null?void 0:s.topic)&&(this.sessionRequestQueue.state=Fe.idle),a&&this.client.events.emit("session_delete",{id:o,topic:r})},this.deleteProposal=async(t,s)=>{if(s)try{let r=this.client.proposal.get(t);this.client.core.eventClient.getEvent({topic:r.pairingTopic})?.setError(Ze.proposal_expired)}catch{}await Promise.all([this.client.proposal.delete(t,L("USER_DISCONNECTED")),s?Promise.resolve():this.client.core.expirer.del(t)]),this.addToRecentlyDeleted(t,"proposal")},this.deletePendingSessionRequest=async(t,s,r=!1)=>{await Promise.all([this.client.pendingRequest.delete(t,s),r?Promise.resolve():this.client.core.expirer.del(t)]),this.addToRecentlyDeleted(t,"request"),this.sessionRequestQueue.queue=this.sessionRequestQueue.queue.filter(n=>n.id!==t),r&&(this.sessionRequestQueue.state=Fe.idle,this.client.events.emit("session_request_expire",{id:t}))},this.deletePendingAuthRequest=async(t,s,r=!1)=>{await Promise.all([this.client.auth.requests.delete(t,s),r?Promise.resolve():this.client.core.expirer.del(t)])},this.setExpiry=async(t,s)=>{this.client.session.keys.includes(t)&&(this.client.core.expirer.set(t,s),await this.client.session.update(t,{expiry:s}))},this.setProposal=async(t,s)=>{this.client.core.expirer.set(t,B(H.wc_sessionPropose.req.ttl)),await this.client.proposal.set(t,s)},this.setAuthRequest=async(t,s)=>{let{request:r,pairingTopic:n,transportType:a=$.relay}=s;this.client.core.expirer.set(t,r.expiryTimestamp),await this.client.auth.requests.set(t,{authPayload:r.authPayload,requester:r.requester,expiryTimestamp:r.expiryTimestamp,id:t,pairingTopic:n,verifyContext:r.verifyContext,transportType:a})},this.setPendingSessionRequest=async t=>{let{id:s,topic:r,params:n,verifyContext:a}=t,o=n.request.expiryTimestamp||B(H.wc_sessionRequest.req.ttl);this.client.core.expirer.set(s,o),await this.client.pendingRequest.set(s,{id:s,topic:r,params:n,verifyContext:a})},this.sendRequest=async t=>{let{topic:s,method:r,params:n,expiry:a,relayRpcId:o,clientRpcId:c,throwOnFailedPublish:h,appLink:u}=t,l=we(r,n,c),g,d=!!u;try{let w=d?Et:Pe;g=await this.client.core.crypto.encode(s,l,{encoding:w})}catch(w){throw await this.cleanup(),this.client.logger.error(`sendRequest() -> core.crypto.encode() for topic ${s} failed`),w}let p;if(ng.includes(r)){let w=Ee(JSON.stringify(l)),m=Ee(g);p=await this.client.core.verify.register({id:m,decryptedId:w})}let y=H[r].req;if(y.attestation=p,a&&(y.ttl=a),o&&(y.id=o),this.client.core.history.set(s,l),d){let w=Zt(u,s,g);await globalThis.Linking.openURL(w,this.client.name)}else{let w=H[r].req;a&&(w.ttl=a),o&&(w.id=o),h?(w.internal=Ie(K({},w.internal),{throwOnFailedPublish:!0}),await this.client.core.relayer.publish(s,g,w)):this.client.core.relayer.publish(s,g,w).catch(m=>this.client.logger.error(m))}return l.id},this.sendResult=async t=>{let{id:s,topic:r,result:n,throwOnFailedPublish:a,encodeOpts:o,appLink:c}=t,h=He(s,n),u,l=c&&typeof globalThis?.Linking<"u";try{let d=l?Et:Pe;u=await this.client.core.crypto.encode(r,h,Ie(K({},o||{}),{encoding:d}))}catch(d){throw await this.cleanup(),this.client.logger.error(`sendResult() -> core.crypto.encode() for topic ${r} failed`),d}let g;try{g=await this.client.core.history.get(r,s)}catch(d){throw this.client.logger.error(`sendResult() -> history.get(${r}, ${s}) failed`),d}if(l){let d=Zt(c,r,u);await globalThis.Linking.openURL(d,this.client.name)}else{let d=H[g.request.method].res;a?(d.internal=Ie(K({},d.internal),{throwOnFailedPublish:!0}),await this.client.core.relayer.publish(r,u,d)):this.client.core.relayer.publish(r,u,d).catch(p=>this.client.logger.error(p))}await this.client.core.history.resolve(h)},this.sendError=async t=>{let{id:s,topic:r,error:n,encodeOpts:a,rpcOpts:o,appLink:c}=t,h=ft(s,n),u,l=c&&typeof globalThis?.Linking<"u";try{let d=l?Et:Pe;u=await this.client.core.crypto.encode(r,h,Ie(K({},a||{}),{encoding:d}))}catch(d){throw await this.cleanup(),this.client.logger.error(`sendError() -> core.crypto.encode() for topic ${r} failed`),d}let g;try{g=await this.client.core.history.get(r,s)}catch(d){throw this.client.logger.error(`sendError() -> history.get(${r}, ${s}) failed`),d}if(l){let d=Zt(c,r,u);await globalThis.Linking.openURL(d,this.client.name)}else{let d=o||H[g.request.method].res;this.client.core.relayer.publish(r,u,d)}await this.client.core.history.resolve(h)},this.cleanup=async()=>{let t=[],s=[];this.client.session.getAll().forEach(r=>{let n=!1;Oe(r.expiry)&&(n=!0),this.client.core.crypto.keychain.has(r.topic)||(n=!0),n&&t.push(r.topic)}),this.client.proposal.getAll().forEach(r=>{Oe(r.expiryTimestamp)&&s.push(r.id)}),await Promise.all([...t.map(r=>this.deleteSession({topic:r})),...s.map(r=>this.deleteProposal(r))])},this.onRelayEventRequest=async t=>{this.requestQueue.queue.push(t),await this.processRequestsQueue()},this.processRequestsQueue=async()=>{if(this.requestQueue.state===Fe.active){this.client.logger.info("Request queue already active, skipping...");return}for(this.client.logger.info(`Request queue starting with ${this.requestQueue.queue.length} requests`);this.requestQueue.queue.length>0;){this.requestQueue.state=Fe.active;let t=this.requestQueue.queue.shift();if(t)try{await this.processRequest(t)}catch(s){this.client.logger.warn(s)}}this.requestQueue.state=Fe.idle},this.processRequest=async t=>{let{topic:s,payload:r,attestation:n,transportType:a,encryptedId:o}=t,c=r.method;if(!this.shouldIgnorePairingRequest({topic:s,requestMethod:c}))switch(c){case"wc_sessionPropose":return await this.onSessionProposeRequest({topic:s,payload:r,attestation:n,encryptedId:o});case"wc_sessionSettle":return await this.onSessionSettleRequest(s,r);case"wc_sessionUpdate":return await this.onSessionUpdateRequest(s,r);case"wc_sessionExtend":return await this.onSessionExtendRequest(s,r);case"wc_sessionPing":return await this.onSessionPingRequest(s,r);case"wc_sessionDelete":return await this.onSessionDeleteRequest(s,r);case"wc_sessionRequest":return await this.onSessionRequest({topic:s,payload:r,attestation:n,encryptedId:o,transportType:a});case"wc_sessionEvent":return await this.onSessionEventRequest(s,r);case"wc_sessionAuthenticate":return await this.onSessionAuthenticateRequest({topic:s,payload:r,attestation:n,encryptedId:o,transportType:a});default:return this.client.logger.info(`Unsupported request method ${c}`)}},this.onRelayEventResponse=async t=>{let{topic:s,payload:r,transportType:n}=t,a=(await this.client.core.history.get(s,r.id)).request.method;switch(a){case"wc_sessionPropose":return this.onSessionProposeResponse(s,r,n);case"wc_sessionSettle":return this.onSessionSettleResponse(s,r);case"wc_sessionUpdate":return this.onSessionUpdateResponse(s,r);case"wc_sessionExtend":return this.onSessionExtendResponse(s,r);case"wc_sessionPing":return this.onSessionPingResponse(s,r);case"wc_sessionRequest":return this.onSessionRequestResponse(s,r);case"wc_sessionAuthenticate":return this.onSessionAuthenticateResponse(s,r);default:return this.client.logger.info(`Unsupported response method ${a}`)}},this.onRelayEventUnknownPayload=t=>{let{topic:s}=t,{message:r}=f("MISSING_OR_INVALID",`Decoded payload on topic ${s} is not identifiable as a JSON-RPC request or a response.`);throw new Error(r)},this.shouldIgnorePairingRequest=t=>{let{topic:s,requestMethod:r}=t,n=this.expectedPairingMethodMap.get(s);return!n||n.includes(r)?!1:!!(n.includes("wc_sessionAuthenticate")&&this.client.events.listenerCount("session_authenticate")>0)},this.onSessionProposeRequest=async t=>{let{topic:s,payload:r,attestation:n,encryptedId:a}=t,{params:o,id:c}=r;try{let h=this.client.core.eventClient.getEvent({topic:s});this.isValidConnect(K({},r.params));let u=o.expiryTimestamp||B(H.wc_sessionPropose.req.ttl),l=K({id:c,pairingTopic:s,expiryTimestamp:u},o);await this.setProposal(c,l);let g=await this.getVerifyContext({attestationId:n,hash:Ee(JSON.stringify(r)),encryptedId:a,metadata:l.proposer.metadata});this.client.events.listenerCount("session_proposal")===0&&(console.warn("No listener for session_proposal event"),h?.setError(xe.proposal_listener_not_found)),h?.addTrace(_e.emit_session_proposal),this.client.events.emit("session_proposal",{id:c,params:l,verifyContext:g})}catch(h){await this.sendError({id:c,topic:s,error:h,rpcOpts:H.wc_sessionPropose.autoReject}),this.client.logger.error(h)}},this.onSessionProposeResponse=async(t,s,r)=>{let{id:n}=s;if(ce(s)){let{result:a}=s;this.client.logger.trace({type:"method",method:"onSessionProposeResponse",result:a});let o=this.client.proposal.get(n);this.client.logger.trace({type:"method",method:"onSessionProposeResponse",proposal:o});let c=o.proposer.publicKey;this.client.logger.trace({type:"method",method:"onSessionProposeResponse",selfPublicKey:c});let h=a.responderPublicKey;this.client.logger.trace({type:"method",method:"onSessionProposeResponse",peerPublicKey:h});let u=await this.client.core.crypto.generateSharedKey(c,h);this.client.logger.trace({type:"method",method:"onSessionProposeResponse",sessionTopic:u});let l=await this.client.core.relayer.subscribe(u,{transportType:r});this.client.logger.trace({type:"method",method:"onSessionProposeResponse",subscriptionId:l}),await this.client.core.pairing.activate({topic:t})}else if(se(s)){await this.client.proposal.delete(n,L("USER_DISCONNECTED"));let a=S("session_connect");if(this.events.listenerCount(a)===0)throw new Error(`emitting ${a} without any listeners, 954`);this.events.emit(S("session_connect"),{error:s.error})}},this.onSessionSettleRequest=async(t,s)=>{let{id:r,params:n}=s;try{this.isValidSessionSettleRequest(n);let{relay:a,controller:o,expiry:c,namespaces:h,sessionProperties:u,sessionConfig:l}=s.params,g=Ie(K(K({topic:t,relay:a,expiry:c,namespaces:h,acknowledged:!0,pairingTopic:"",requiredNamespaces:{},optionalNamespaces:{},controller:o.publicKey,self:{publicKey:"",metadata:this.client.metadata},peer:{publicKey:o.publicKey,metadata:o.metadata}},u&&{sessionProperties:u}),l&&{sessionConfig:l}),{transportType:$.relay}),d=S("session_connect");if(this.events.listenerCount(d)===0)throw new Error(`emitting ${d} without any listeners 997`);this.events.emit(S("session_connect"),{session:g}),await this.sendResult({id:s.id,topic:t,result:!0,throwOnFailedPublish:!0})}catch(a){await this.sendError({id:r,topic:t,error:a}),this.client.logger.error(a)}},this.onSessionSettleResponse=async(t,s)=>{let{id:r}=s;ce(s)?(await this.client.session.update(t,{acknowledged:!0}),this.events.emit(S("session_approve",r),{})):se(s)&&(await this.client.session.delete(t,L("USER_DISCONNECTED")),this.events.emit(S("session_approve",r),{error:s.error}))},this.onSessionUpdateRequest=async(t,s)=>{let{params:r,id:n}=s;try{let a=`${t}_session_update`,o=Xe.get(a);if(o&&this.isRequestOutOfSync(o,n)){this.client.logger.info(`Discarding out of sync request - ${n}`),this.sendError({id:n,topic:t,error:L("INVALID_UPDATE_REQUEST")});return}this.isValidUpdate(K({topic:t},r));try{Xe.set(a,n),await this.client.session.update(t,{namespaces:r.namespaces}),await this.sendResult({id:n,topic:t,result:!0,throwOnFailedPublish:!0})}catch(c){throw Xe.delete(a),c}this.client.events.emit("session_update",{id:n,topic:t,params:r})}catch(a){await this.sendError({id:n,topic:t,error:a}),this.client.logger.error(a)}},this.isRequestOutOfSync=(t,s)=>parseInt(s.toString().slice(0,-3))<=parseInt(t.toString().slice(0,-3)),this.onSessionUpdateResponse=(t,s)=>{let{id:r}=s,n=S("session_update",r);if(this.events.listenerCount(n)===0)throw new Error(`emitting ${n} without any listeners`);ce(s)?this.events.emit(S("session_update",r),{}):se(s)&&this.events.emit(S("session_update",r),{error:s.error})},this.onSessionExtendRequest=async(t,s)=>{let{id:r}=s;try{this.isValidExtend({topic:t}),await this.setExpiry(t,B(Nt)),await this.sendResult({id:r,topic:t,result:!0,throwOnFailedPublish:!0}),this.client.events.emit("session_extend",{id:r,topic:t})}catch(n){await this.sendError({id:r,topic:t,error:n}),this.client.logger.error(n)}},this.onSessionExtendResponse=(t,s)=>{let{id:r}=s,n=S("session_extend",r);if(this.events.listenerCount(n)===0)throw new Error(`emitting ${n} without any listeners`);ce(s)?this.events.emit(S("session_extend",r),{}):se(s)&&this.events.emit(S("session_extend",r),{error:s.error})},this.onSessionPingRequest=async(t,s)=>{let{id:r}=s;try{this.isValidPing({topic:t}),await this.sendResult({id:r,topic:t,result:!0,throwOnFailedPublish:!0}),this.client.events.emit("session_ping",{id:r,topic:t})}catch(n){await this.sendError({id:r,topic:t,error:n}),this.client.logger.error(n)}},this.onSessionPingResponse=(t,s)=>{let{id:r}=s,n=S("session_ping",r);if(this.events.listenerCount(n)===0)throw new Error(`emitting ${n} without any listeners`);setTimeout(()=>{ce(s)?this.events.emit(S("session_ping",r),{}):se(s)&&this.events.emit(S("session_ping",r),{error:s.error})},500)},this.onSessionDeleteRequest=async(t,s)=>{let{id:r}=s;try{this.isValidDisconnect({topic:t,reason:s.params}),Promise.all([new Promise(n=>{this.client.core.relayer.once(ee.publish,async()=>{n(await this.deleteSession({topic:t,id:r}))})}),this.sendResult({id:r,topic:t,result:!0,throwOnFailedPublish:!0}),this.cleanupPendingSentRequestsForTopic({topic:t,error:L("USER_DISCONNECTED")})]).catch(n=>this.client.logger.error(n))}catch(n){this.client.logger.error(n)}},this.onSessionRequest=async t=>{var s,r,n;let{topic:a,payload:o,attestation:c,encryptedId:h,transportType:u}=t,{id:l,params:g}=o;try{await this.isValidRequest(K({topic:a},g));let d=this.client.session.get(a),p=await this.getVerifyContext({attestationId:c,hash:Ee(JSON.stringify(we("wc_sessionRequest",g,l))),encryptedId:h,metadata:d.peer.metadata,transportType:u}),y={id:l,topic:a,params:g,verifyContext:p};await this.setPendingSessionRequest(y),u===$.link_mode&&(s=d.peer.metadata.redirect)!=null&&s.universal&&this.client.core.addLinkModeSupportedApp((r=d.peer.metadata.redirect)==null?void 0:r.universal),(n=this.client.signConfig)!=null&&n.disableRequestQueue?this.emitSessionRequest(y):(this.addSessionRequestToSessionRequestQueue(y),this.processSessionRequestQueue())}catch(d){await this.sendError({id:l,topic:a,error:d}),this.client.logger.error(d)}},this.onSessionRequestResponse=(t,s)=>{let{id:r}=s,n=S("session_request",r);if(this.events.listenerCount(n)===0)throw new Error(`emitting ${n} without any listeners`);ce(s)?this.events.emit(S("session_request",r),{result:s.result}):se(s)&&this.events.emit(S("session_request",r),{error:s.error})},this.onSessionEventRequest=async(t,s)=>{let{id:r,params:n}=s;try{let a=`${t}_session_event_${n.event.name}`,o=Xe.get(a);if(o&&this.isRequestOutOfSync(o,r)){this.client.logger.info(`Discarding out of sync request - ${r}`);return}this.isValidEmit(K({topic:t},n)),this.client.events.emit("session_event",{id:r,topic:t,params:n}),Xe.set(a,r)}catch(a){await this.sendError({id:r,topic:t,error:a}),this.client.logger.error(a)}},this.onSessionAuthenticateResponse=(t,s)=>{let{id:r}=s;this.client.logger.trace({type:"method",method:"onSessionAuthenticateResponse",topic:t,payload:s}),ce(s)?this.events.emit(S("session_request",r),{result:s.result}):se(s)&&this.events.emit(S("session_request",r),{error:s.error})},this.onSessionAuthenticateRequest=async t=>{var s;let{topic:r,payload:n,attestation:a,encryptedId:o,transportType:c}=t;try{let{requester:h,authPayload:u,expiryTimestamp:l}=n.params,g=await this.getVerifyContext({attestationId:a,hash:Ee(JSON.stringify(n)),encryptedId:o,metadata:h.metadata,transportType:c}),d={requester:h,pairingTopic:r,id:n.id,authPayload:u,verifyContext:g,expiryTimestamp:l};await this.setAuthRequest(n.id,{request:d,pairingTopic:r,transportType:c}),c===$.link_mode&&(s=h.metadata.redirect)!=null&&s.universal&&this.client.core.addLinkModeSupportedApp(h.metadata.redirect.universal),this.client.events.emit("session_authenticate",{topic:r,params:n.params,id:n.id,verifyContext:g})}catch(h){this.client.logger.error(h);let u=n.params.requester.publicKey,l=await this.client.core.crypto.generateKeyPair(),g=this.getAppLinkIfEnabled(n.params.requester.metadata,c),d={type:be,receiverPublicKey:u,senderPublicKey:l};await this.sendError({id:n.id,topic:r,error:h,encodeOpts:d,rpcOpts:H.wc_sessionAuthenticate.autoReject,appLink:g})}},this.addSessionRequestToSessionRequestQueue=t=>{this.sessionRequestQueue.queue.push(t)},this.cleanupAfterResponse=t=>{this.deletePendingSessionRequest(t.response.id,{message:"fulfilled",code:0}),setTimeout(()=>{this.sessionRequestQueue.state=Fe.idle,this.processSessionRequestQueue()},(0,T.toMiliseconds)(this.requestQueueDelay))},this.cleanupPendingSentRequestsForTopic=({topic:t,error:s})=>{let r=this.client.core.history.pending;r.length>0&&r.filter(n=>n.topic===t&&n.request.method==="wc_sessionRequest").forEach(n=>{let a=n.request.id,o=S("session_request",a);if(this.events.listenerCount(o)===0)throw new Error(`emitting ${o} without any listeners`);this.events.emit(S("session_request",n.request.id),{error:s})})},this.processSessionRequestQueue=()=>{if(this.sessionRequestQueue.state===Fe.active){this.client.logger.info("session request queue is already active.");return}let t=this.sessionRequestQueue.queue[0];if(!t){this.client.logger.info("session request queue is empty.");return}try{this.sessionRequestQueue.state=Fe.active,this.emitSessionRequest(t)}catch(s){this.client.logger.error(s)}},this.emitSessionRequest=t=>{this.client.events.emit("session_request",t)},this.onPairingCreated=t=>{if(t.methods&&this.expectedPairingMethodMap.set(t.topic,t.methods),t.active)return;let s=this.client.proposal.getAll().find(r=>r.pairingTopic===t.topic);s&&this.onSessionProposeRequest({topic:t.topic,payload:we("wc_sessionPropose",{requiredNamespaces:s.requiredNamespaces,optionalNamespaces:s.optionalNamespaces,relays:s.relays,proposer:s.proposer,sessionProperties:s.sessionProperties},s.id)})},this.isValidConnect=async t=>{if(!Z(t)){let{message:c}=f("MISSING_OR_INVALID",`connect() params: ${JSON.stringify(t)}`);throw new Error(c)}let{pairingTopic:s,requiredNamespaces:r,optionalNamespaces:n,sessionProperties:a,relays:o}=t;if(Y(s)||await this.isValidPairingTopic(s),!uo(o,!0)){let{message:c}=f("MISSING_OR_INVALID",`connect() relays: ${o}`);throw new Error(c)}!Y(r)&&es(r)!==0&&this.validateNamespaces(r,"requiredNamespaces"),!Y(n)&&es(n)!==0&&this.validateNamespaces(n,"optionalNamespaces"),Y(a)||this.validateSessionProps(a,"sessionProperties")},this.validateNamespaces=(t,s)=>{let r=lo(t,"connect()",s);if(r)throw new Error(r.message)},this.isValidApprove=async t=>{if(!Z(t))throw new Error(f("MISSING_OR_INVALID",`approve() params: ${t}`).message);let{id:s,namespaces:r,relayProtocol:n,sessionProperties:a}=t;this.checkRecentlyDeleted(s),await this.isValidProposalId(s);let o=this.client.proposal.get(s),c=si(r,"approve()");if(c)throw new Error(c.message);let h=lr(o.requiredNamespaces,r,"approve()");if(h)throw new Error(h.message);if(!V(n,!0)){let{message:u}=f("MISSING_OR_INVALID",`approve() relayProtocol: ${n}`);throw new Error(u)}Y(a)||this.validateSessionProps(a,"sessionProperties")},this.isValidReject=async t=>{if(!Z(t)){let{message:n}=f("MISSING_OR_INVALID",`reject() params: ${t}`);throw new Error(n)}let{id:s,reason:r}=t;if(this.checkRecentlyDeleted(s),await this.isValidProposalId(s),!go(r)){let{message:n}=f("MISSING_OR_INVALID",`reject() reason: ${JSON.stringify(r)}`);throw new Error(n)}},this.isValidSessionSettleRequest=t=>{if(!Z(t)){let{message:h}=f("MISSING_OR_INVALID",`onSessionSettleRequest() params: ${t}`);throw new Error(h)}let{relay:s,controller:r,namespaces:n,expiry:a}=t;if(!cr(s)){let{message:h}=f("MISSING_OR_INVALID","onSessionSettleRequest() relay protocol should be a string");throw new Error(h)}let o=co(r,"onSessionSettleRequest()");if(o)throw new Error(o.message);let c=si(n,"onSessionSettleRequest()");if(c)throw new Error(c.message);if(Oe(a)){let{message:h}=f("EXPIRED","onSessionSettleRequest()");throw new Error(h)}},this.isValidUpdate=async t=>{if(!Z(t)){let{message:c}=f("MISSING_OR_INVALID",`update() params: ${t}`);throw new Error(c)}let{topic:s,namespaces:r}=t;this.checkRecentlyDeleted(s),await this.isValidSessionTopic(s);let n=this.client.session.get(s),a=si(r,"update()");if(a)throw new Error(a.message);let o=lr(n.requiredNamespaces,r,"update()");if(o)throw new Error(o.message)},this.isValidExtend=async t=>{if(!Z(t)){let{message:r}=f("MISSING_OR_INVALID",`extend() params: ${t}`);throw new Error(r)}let{topic:s}=t;this.checkRecentlyDeleted(s),await this.isValidSessionTopic(s)},this.isValidRequest=async t=>{if(!Z(t)){let{message:c}=f("MISSING_OR_INVALID",`request() params: ${t}`);throw new Error(c)}let{topic:s,request:r,chainId:n,expiry:a}=t;this.checkRecentlyDeleted(s),await this.isValidSessionTopic(s);let{namespaces:o}=this.client.session.get(s);if(!hr(o,n)){let{message:c}=f("MISSING_OR_INVALID",`request() chainId: ${n}`);throw new Error(c)}if(!yo(r)){let{message:c}=f("MISSING_OR_INVALID",`request() ${JSON.stringify(r)}`);throw new Error(c)}if(!wo(o,n,r.method)){let{message:c}=f("MISSING_OR_INVALID",`request() method: ${r.method}`);throw new Error(c)}if(a&&!Eo(a,kr)){let{message:c}=f("MISSING_OR_INVALID",`request() expiry: ${a}. Expiry must be a number (in seconds) between ${kr.min} and ${kr.max}`);throw new Error(c)}},this.isValidRespond=async t=>{var s;if(!Z(t)){let{message:a}=f("MISSING_OR_INVALID",`respond() params: ${t}`);throw new Error(a)}let{topic:r,response:n}=t;try{await this.isValidSessionTopic(r)}catch(a){throw(s=t?.response)!=null&&s.id&&this.cleanupAfterResponse(t),a}if(!fo(n)){let{message:a}=f("MISSING_OR_INVALID",`respond() response: ${JSON.stringify(n)}`);throw new Error(a)}},this.isValidPing=async t=>{if(!Z(t)){let{message:r}=f("MISSING_OR_INVALID",`ping() params: ${t}`);throw new Error(r)}let{topic:s}=t;await this.isValidSessionOrPairingTopic(s)},this.isValidEmit=async t=>{if(!Z(t)){let{message:o}=f("MISSING_OR_INVALID",`emit() params: ${t}`);throw new Error(o)}let{topic:s,event:r,chainId:n}=t;await this.isValidSessionTopic(s);let{namespaces:a}=this.client.session.get(s);if(!hr(a,n)){let{message:o}=f("MISSING_OR_INVALID",`emit() chainId: ${n}`);throw new Error(o)}if(!mo(r)){let{message:o}=f("MISSING_OR_INVALID",`emit() event: ${JSON.stringify(r)}`);throw new Error(o)}if(!bo(a,n,r.name)){let{message:o}=f("MISSING_OR_INVALID",`emit() event: ${JSON.stringify(r)}`);throw new Error(o)}},this.isValidDisconnect=async t=>{if(!Z(t)){let{message:r}=f("MISSING_OR_INVALID",`disconnect() params: ${t}`);throw new Error(r)}let{topic:s}=t;await this.isValidSessionOrPairingTopic(s)},this.isValidAuthenticate=t=>{let{chains:s,uri:r,domain:n,nonce:a}=t;if(!Array.isArray(s)||s.length===0)throw new Error("chains is required and must be a non-empty array");if(!V(r,!1))throw new Error("uri is required parameter");if(!V(n,!1))throw new Error("domain is required parameter");if(!V(a,!1))throw new Error("nonce is required parameter");if([...new Set(s.map(c=>Gt(c).namespace))].length>1)throw new Error("Multi-namespace requests are not supported. Please request single namespace only.");let{namespace:o}=Gt(s[0]);if(o!=="eip155")throw new Error("Only eip155 namespace is supported for authenticated sessions. Please use .connect() for non-eip155 chains.")},this.getVerifyContext=async t=>{let{attestationId:s,hash:r,encryptedId:n,metadata:a,transportType:o}=t,c={verified:{verifyUrl:a.verifyUrl||Ot,validation:"UNKNOWN",origin:a.url||""}};try{if(o===$.link_mode){let u=this.getAppLinkIfEnabled(a,o);return c.verified.validation=u&&new URL(u).origin===new URL(a.url).origin?"VALID":"INVALID",c}let h=await this.client.core.verify.resolve({attestationId:s,hash:r,encryptedId:n,verifyUrl:a.verifyUrl});h&&(c.verified.origin=h.origin,c.verified.isScam=h.isScam,c.verified.validation=h.origin===new URL(a.url).origin?"VALID":"INVALID")}catch(h){this.client.logger.warn(h)}return this.client.logger.debug(`Verify context: ${JSON.stringify(c)}`),c},this.validateSessionProps=(t,s)=>{Object.values(t).forEach(r=>{if(!V(r,!1)){let{message:n}=f("MISSING_OR_INVALID",`${s} must be in Record<string, string> format. Received: ${JSON.stringify(r)}`);throw new Error(n)}})},this.getPendingAuthRequest=t=>{let s=this.client.auth.requests.get(t);return typeof s=="object"?s:void 0},this.addToRecentlyDeleted=(t,s)=>{if(this.recentlyDeletedMap.set(t,s),this.recentlyDeletedMap.size>=this.recentlyDeletedLimit){let r=0,n=this.recentlyDeletedLimit/2;for(let a of this.recentlyDeletedMap.keys()){if(r++>=n)break;this.recentlyDeletedMap.delete(a)}}},this.checkRecentlyDeleted=t=>{let s=this.recentlyDeletedMap.get(t);if(s){let{message:r}=f("MISSING_OR_INVALID",`Record was recently deleted - ${s}: ${t}`);throw new Error(r)}},this.isLinkModeEnabled=(t,s)=>{var r,n,a,o,c,h,u,l,g;return!t||s!==$.link_mode?!1:((n=(r=this.client.metadata)==null?void 0:r.redirect)==null?void 0:n.linkMode)===!0&&((o=(a=this.client.metadata)==null?void 0:a.redirect)==null?void 0:o.universal)!==void 0&&((h=(c=this.client.metadata)==null?void 0:c.redirect)==null?void 0:h.universal)!==""&&((u=t?.redirect)==null?void 0:u.universal)!==void 0&&((l=t?.redirect)==null?void 0:l.universal)!==""&&((g=t?.redirect)==null?void 0:g.linkMode)===!0&&this.client.core.linkModeSupportedApps.includes(t.redirect.universal)&&typeof globalThis?.Linking<"u"},this.getAppLinkIfEnabled=(t,s)=>{var r;return this.isLinkModeEnabled(t,s)?(r=t?.redirect)==null?void 0:r.universal:void 0},this.handleLinkModeMessage=({url:t})=>{if(!t||!t.includes("wc_ev")||!t.includes("topic"))return;let s=Hi(t,"topic")||"",r=decodeURIComponent(Hi(t,"wc_ev")||""),n=this.client.session.keys.includes(s);n&&this.client.session.update(s,{transportType:$.link_mode}),this.client.core.dispatchEnvelope({topic:s,message:r,sessionExists:n})},this.registerLinkModeListeners=async()=>{var t;if(Yt()||ht()&&(t=this.client.metadata.redirect)!=null&&t.linkMode){let s=globalThis?.Linking;if(typeof s<"u"){s.addEventListener("url",this.handleLinkModeMessage,this.client.name);let r=await s.getInitialURL();r&&setTimeout(()=>{this.handleLinkModeMessage({url:r})},50)}}}}isInitialized(){if(!this.initialized){let{message:e}=f("NOT_INITIALIZED",this.name);throw new Error(e)}}async confirmOnlineStateOrThrow(){await this.client.core.relayer.confirmOnlineStateOrThrow()}registerRelayerEvents(){this.client.core.relayer.on(ee.message,e=>{!this.initialized||this.relayMessageCache.length>0?this.relayMessageCache.push(e):this.onRelayMessage(e)})}async onRelayMessage(e){let{topic:t,message:s,attestation:r,transportType:n}=e,{publicKey:a}=this.client.auth.authKeys.keys.includes(ri)?this.client.auth.authKeys.get(ri):{responseTopic:void 0,publicKey:void 0},o=await this.client.core.crypto.decode(t,s,{receiverPublicKey:a,encoding:n===$.link_mode?Et:Pe});try{Je(o)?(this.client.core.history.set(t,o),this.onRelayEventRequest({topic:t,payload:o,attestation:r,transportType:n,encryptedId:Ee(s)})):Ye(o)?(await this.client.core.history.resolve(o),await this.onRelayEventResponse({topic:t,payload:o,transportType:n}),this.client.core.history.delete(t,o.id)):this.onRelayEventUnknownPayload({topic:t,payload:o,transportType:n})}catch(c){this.client.logger.error(c)}}registerExpirerEvents(){this.client.core.expirer.on(he.expired,async e=>{let{topic:t,id:s}=Qs(e.target);if(s&&this.client.pendingRequest.keys.includes(s))return await this.deletePendingSessionRequest(s,f("EXPIRED"),!0);if(s&&this.client.auth.requests.keys.includes(s))return await this.deletePendingAuthRequest(s,f("EXPIRED"),!0);t?this.client.session.keys.includes(t)&&(await this.deleteSession({topic:t,expirerHasDeleted:!0}),this.client.events.emit("session_expire",{topic:t})):s&&(await this.deleteProposal(s,!0),this.client.events.emit("proposal_expire",{id:s}))})}registerPairingEvents(){this.client.core.pairing.events.on(Qe.create,e=>this.onPairingCreated(e)),this.client.core.pairing.events.on(Qe.delete,e=>{this.addToRecentlyDeleted(e.topic,"pairing")})}isValidPairingTopic(e){if(!V(e,!1)){let{message:t}=f("MISSING_OR_INVALID",`pairing topic should be a string: ${e}`);throw new Error(t)}if(!this.client.core.pairing.pairings.keys.includes(e)){let{message:t}=f("NO_MATCHING_KEY",`pairing topic doesn't exist: ${e}`);throw new Error(t)}if(Oe(this.client.core.pairing.pairings.get(e).expiry)){let{message:t}=f("EXPIRED",`pairing topic: ${e}`);throw new Error(t)}}async isValidSessionTopic(e){if(!V(e,!1)){let{message:t}=f("MISSING_OR_INVALID",`session topic should be a string: ${e}`);throw new Error(t)}if(this.checkRecentlyDeleted(e),!this.client.session.keys.includes(e)){let{message:t}=f("NO_MATCHING_KEY",`session topic doesn't exist: ${e}`);throw new Error(t)}if(Oe(this.client.session.get(e).expiry)){await this.deleteSession({topic:e});let{message:t}=f("EXPIRED",`session topic: ${e}`);throw new Error(t)}if(!this.client.core.crypto.keychain.has(e)){let{message:t}=f("MISSING_OR_INVALID",`session topic does not exist in keychain: ${e}`);throw await this.deleteSession({topic:e}),new Error(t)}}async isValidSessionOrPairingTopic(e){if(this.checkRecentlyDeleted(e),this.client.session.keys.includes(e))await this.isValidSessionTopic(e);else if(this.client.core.pairing.pairings.keys.includes(e))this.isValidPairingTopic(e);else if(V(e,!1)){let{message:t}=f("NO_MATCHING_KEY",`session or pairing topic doesn't exist: ${e}`);throw new Error(t)}else{let{message:t}=f("MISSING_OR_INVALID",`session or pairing topic should be a string: ${e}`);throw new Error(t)}}async isValidProposalId(e){if(!po(e)){let{message:t}=f("MISSING_OR_INVALID",`proposal id should be a number: ${e}`);throw new Error(t)}if(!this.client.proposal.keys.includes(e)){let{message:t}=f("NO_MATCHING_KEY",`proposal id doesn't exist: ${e}`);throw new Error(t)}if(Oe(this.client.proposal.get(e).expiryTimestamp)){await this.deleteProposal(e);let{message:t}=f("EXPIRED",`proposal id: ${e}`);throw new Error(t)}}},Mr=class extends Ce{constructor(e,t){super(e,t,eg,Hr),this.core=e,this.logger=t}},ni=class extends Ce{constructor(e,t){super(e,t,sg,Hr),this.core=e,this.logger=t}},Vr=class extends Ce{constructor(e,t){super(e,t,rg,Hr,s=>s.id),this.core=e,this.logger=t}},Kr=class extends Ce{constructor(e,t){super(e,t,cg,oi,()=>ri),this.core=e,this.logger=t}},zr=class extends Ce{constructor(e,t){super(e,t,hg,oi),this.core=e,this.logger=t}},Br=class extends Ce{constructor(e,t){super(e,t,lg,oi,s=>s.id),this.core=e,this.logger=t}},Gr=class{constructor(e,t){this.core=e,this.logger=t,this.authKeys=new Kr(this.core,this.logger),this.pairingTopics=new zr(this.core,this.logger),this.requests=new Br(this.core,this.logger)}async init(){await this.authKeys.init(),await this.pairingTopics.init(),await this.requests.init()}},as=class extends Hs{constructor(e){super(e),this.protocol=hc,this.version=lc,this.name=$r.name,this.events=new ai.EventEmitter,this.on=(s,r)=>this.events.on(s,r),this.once=(s,r)=>this.events.once(s,r),this.off=(s,r)=>this.events.off(s,r),this.removeListener=(s,r)=>this.events.removeListener(s,r),this.removeAllListeners=s=>this.events.removeAllListeners(s),this.connect=async s=>{try{return await this.engine.connect(s)}catch(r){throw this.logger.error(r.message),r}},this.pair=async s=>{try{return await this.engine.pair(s)}catch(r){throw this.logger.error(r.message),r}},this.approve=async s=>{try{return await this.engine.approve(s)}catch(r){throw this.logger.error(r.message),r}},this.reject=async s=>{try{return await this.engine.reject(s)}catch(r){throw this.logger.error(r.message),r}},this.update=async s=>{try{return await this.engine.update(s)}catch(r){throw this.logger.error(r.message),r}},this.extend=async s=>{try{return await this.engine.extend(s)}catch(r){throw this.logger.error(r.message),r}},this.request=async s=>{try{return await this.engine.request(s)}catch(r){throw this.logger.error(r.message),r}},this.respond=async s=>{try{return await this.engine.respond(s)}catch(r){throw this.logger.error(r.message),r}},this.ping=async s=>{try{return await this.engine.ping(s)}catch(r){throw this.logger.error(r.message),r}},this.emit=async s=>{try{return await this.engine.emit(s)}catch(r){throw this.logger.error(r.message),r}},this.disconnect=async s=>{try{return await this.engine.disconnect(s)}catch(r){throw this.logger.error(r.message),r}},this.find=s=>{try{return this.engine.find(s)}catch(r){throw this.logger.error(r.message),r}},this.getPendingSessionRequests=()=>{try{return this.engine.getPendingSessionRequests()}catch(s){throw this.logger.error(s.message),s}},this.authenticate=async(s,r)=>{try{return await this.engine.authenticate(s,r)}catch(n){throw this.logger.error(n.message),n}},this.formatAuthMessage=s=>{try{return this.engine.formatAuthMessage(s)}catch(r){throw this.logger.error(r.message),r}},this.approveSessionAuthenticate=async s=>{try{return await this.engine.approveSessionAuthenticate(s)}catch(r){throw this.logger.error(r.message),r}},this.rejectSessionAuthenticate=async s=>{try{return await this.engine.rejectSessionAuthenticate(s)}catch(r){throw this.logger.error(r.message),r}},this.name=e?.name||$r.name,this.metadata=e?.metadata||Xs(),this.signConfig=e?.signConfig;let t=typeof e?.logger<"u"&&typeof e?.logger!="string"?e.logger:(0,gt.default)(Be({level:e?.logger||$r.logger}));this.core=e?.core||new nc(e),this.logger=N(t,this.name),this.session=new ni(this.core,this.logger),this.proposal=new Mr(this.core,this.logger),this.pendingRequest=new Vr(this.core,this.logger),this.engine=new jr(this),this.auth=new Gr(this.core,this.logger)}static async init(e){let t=new as(e);return await t.initialize(),t}get context(){return D(this.logger)}get pairing(){return this.core.pairing.pairings}async initialize(){this.logger.trace("Initialized");try{await this.core.start(),await this.session.init(),await this.proposal.init(),await this.pendingRequest.init(),await this.auth.init(),await this.engine.init(),this.logger.info("SignClient Initialization Success"),this.engine.processRelayMessageCache()}catch(e){throw this.logger.info("SignClient Initialization Failure"),this.logger.error(e.message),e}}},pc=ni,dc=as;j();M();var ze=O(Mt());j();M();var gc=O(Mt()),ci=class extends re{constructor(e){super(),this.opts=e,this.protocol="wc",this.version=2}};var hi=class extends re{constructor(e,t){super(),this.core=e,this.logger=t,this.records=new Map}},li=class{constructor(e,t){this.logger=e,this.core=t}},ui=class extends re{constructor(e,t){super(),this.relayer=e,this.logger=t}},pi=class extends re{constructor(e){super()}},di=class{constructor(e,t,s,r){this.core=e,this.logger=t,this.name=s}};var gi=class extends re{constructor(e,t){super(),this.relayer=e,this.logger=t}};var yi=class extends re{constructor(e,t){super(),this.core=e,this.logger=t}};var fi=class{constructor(e,t,s){this.core=e,this.logger=t,this.store=s}},mi=class{constructor(e,t){this.projectId=e,this.logger=t}},wi=class{constructor(e,t,s){this.core=e,this.logger=t,this.telemetryEnabled=s}};var _=O(Vt());j();M();var Ve=O(Vt()),st=O(Cs()),Lc=O(Wn()),xt=O(Oc());var Wr=O(ea()),Uc=O(ta()),cs=O(Yn()),At=O(sa()),bi=O(ia());var qc=O(Jn());var Rg=Object.defineProperty,Pc=Object.getOwnPropertySymbols,Tg=Object.prototype.hasOwnProperty,Og=Object.prototype.propertyIsEnumerable,Nc=(i,e,t)=>e in i?Rg(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,xc=(i,e)=>{for(var t in e||(e={}))Tg.call(e,t)&&Nc(i,t,e[t]);if(Pc)for(var t of Pc(e))Og.call(e,t)&&Nc(i,t,e[t]);return i},Pg="ReactNative",ye={reactNative:"react-native",node:"node",browser:"browser",unknown:"unknown"};var Ng="js";function hs(){return typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"}function ls(){return!(0,st.getDocument)()&&!!(0,st.getNavigator)()&&navigator.product===Pg}function us(){return!hs()&&!!(0,st.getNavigator)()&&!!(0,st.getDocument)()}function Ei(){return ls()?ye.reactNative:hs()?ye.node:us()?ye.browser:ye.unknown}function $c(){var i;try{return ls()&&typeof globalThis<"u"&&typeof globalThis?.Application<"u"?(i=globalThis.Application)==null?void 0:i.applicationId:void 0}catch{return}}function xg(i,e){let t=xt.parse(i);return t=xc(xc({},t),e),i=xt.stringify(t),i}function kc(){return(0,Lc.getWindowMetadata)()||{name:"",description:"",url:"",icons:[""]}}function Ag(){if(Ei()===ye.reactNative&&typeof globalThis<"u"&&typeof globalThis?.Platform<"u"){let{OS:t,Version:s}=globalThis.Platform;return[t,s].join("-")}let i=As();if(i===null)return"unknown";let e=i.os?i.os.replace(" ","").toLowerCase():"unknown";return i.type==="browser"?[e,i.name,i.version].join("-"):[e,i.version].join("-")}function Cg(){var i;let e=Ei();return e===ye.browser?[e,((i=(0,st.getLocation)())==null?void 0:i.host)||"unknown"].join(":"):e}function Xr(i,e,t){let s=Ag(),r=Cg();return[[i,e].join("-"),[Ng,t].join("-"),s,r].join("/")}function jc({protocol:i,version:e,relayUrl:t,sdkVersion:s,auth:r,projectId:n,useOnCloseEvent:a,bundleId:o}){let c=t.split("?"),h=Xr(i,e,s),u={auth:r,ua:h,projectId:n,useOnCloseEvent:a||void 0,origin:o||void 0},l=xg(c[1]||"",u);return c[0]+"?"+l}function Qr(i){return Object.fromEntries(i.entries())}function Zr(i){return new Map(Object.entries(i))}function Mc(i=Ve.FIVE_MINUTES,e){let t=(0,Ve.toMiliseconds)(i||Ve.FIVE_MINUTES),s,r,n;return{resolve:a=>{n&&s&&(clearTimeout(n),s(a))},reject:a=>{n&&r&&(clearTimeout(n),r(a))},done:()=>new Promise((a,o)=>{n=setTimeout(()=>{o(new Error(e))},t),s=a,r=o})}}function ut(i,e,t){return new Promise(async(s,r)=>{let n=setTimeout(()=>r(new Error(t)),e);try{let a=await i;s(a)}catch(a){r(a)}clearTimeout(n)})}function Vc(i,e){if(typeof e=="string"&&e.startsWith(`${i}:`))return e;if(i.toLowerCase()==="topic"){if(typeof e!="string")throw new Error('Value must be "string" for expirer target type: topic');return`topic:${e}`}else if(i.toLowerCase()==="id"){if(typeof e!="number")throw new Error('Value must be "number" for expirer target type: id');return`id:${e}`}throw new Error(`Unknown expirer target type: ${i}`)}function Kc(i){return Vc("topic",i)}function zc(i){return Vc("id",i)}function Bc(i){let[e,t]=i.split(":"),s={id:void 0,topic:void 0};if(e==="topic"&&typeof t=="string")s.topic=t;else if(e==="id"&&Number.isInteger(Number(t)))s.id=Number(t);else throw new Error(`Invalid target, expected id:number or topic:string, got ${e}:${t}`);return s}function Ct(i,e){return(0,Ve.fromMiliseconds)((e||Date.now())+(0,Ve.toMiliseconds)(i))}function en(i){return Date.now()>=(0,Ve.toMiliseconds)(i)}function vi(i,e){return`${i}${e?`:${e}`:""}`}function tn(){return typeof crypto<"u"&&crypto!=null&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/gu,i=>{let e=Math.random()*16|0;return(i==="x"?e:e&3|8).toString(16)})}function sn(){return typeof process<"u"&&process.env.IS_VITEST==="true"}function Gc(i){return q.Buffer.from(i,"base64").toString("utf-8")}var Hc="base10",te="base16",ps="base64pad";var ds="utf8",Jc=0,pt=1,_i=2,Fg=0,Ac=1,os=12,rn=32;function Yc(){let i=bi.generateKeyPair();return{privateKey:x(i.secretKey,te),publicKey:x(i.publicKey,te)}}function Ii(){let i=(0,cs.randomBytes)(rn);return x(i,te)}function Wc(i,e){let t=bi.sharedKey(k(i,te),k(e,te),!0),s=new Uc.HKDF(At.SHA256,t).expand(rn);return x(s,te)}function Xc(i){let e=(0,At.hash)(k(i,te));return x(e,te)}function Si(i){let e=(0,At.hash)(k(i,ds));return x(e,te)}function Qc(i){return k(`${i}`,Hc)}function tt(i){return Number(x(i,Hc))}function Zc(i){let e=Qc(typeof i.type<"u"?i.type:Jc);if(tt(e)===pt&&typeof i.senderPublicKey>"u")throw new Error("Missing sender public key for type 1 envelope");let t=typeof i.senderPublicKey<"u"?k(i.senderPublicKey,te):void 0,s=typeof i.iv<"u"?k(i.iv,te):(0,cs.randomBytes)(os),r=new Wr.ChaCha20Poly1305(k(i.symKey,te)).seal(s,k(i.message,ds));return ih({type:e,sealed:r,iv:s,senderPublicKey:t,encoding:i.encoding})}function eh(i,e){let t=Qc(_i),s=(0,cs.randomBytes)(os),r=k(i,ds);return ih({type:t,sealed:r,iv:s,encoding:e})}function th(i){let e=new Wr.ChaCha20Poly1305(k(i.symKey,te)),{sealed:t,iv:s}=Ft({encoded:i.encoded,encoding:i?.encoding}),r=e.open(s,t);if(r===null)throw new Error("Failed to decrypt");return x(r,ds)}function sh(i,e){let{sealed:t}=Ft({encoded:i,encoding:e});return x(t,ds)}function ih(i){let{encoding:e=ps}=i;if(tt(i.type)===_i)return x(Ge([i.type,i.sealed]),e);if(tt(i.type)===pt){if(typeof i.senderPublicKey>"u")throw new Error("Missing sender public key for type 1 envelope");return x(Ge([i.type,i.senderPublicKey,i.iv,i.sealed]),e)}return x(Ge([i.type,i.iv,i.sealed]),e)}function Ft(i){let{encoded:e,encoding:t=ps}=i,s=k(e,t),r=s.slice(Fg,Ac),n=Ac;if(tt(r)===pt){let h=n+rn,u=h+os,l=s.slice(n,h),g=s.slice(h,u),d=s.slice(u);return{type:r,sealed:d,iv:g,senderPublicKey:l}}if(tt(r)===_i){let h=s.slice(n),u=(0,cs.randomBytes)(os);return{type:r,sealed:h,iv:u}}let a=n+os,o=s.slice(n,a),c=s.slice(a);return{type:r,sealed:c,iv:o}}function rh(i,e){let t=Ft({encoded:i,encoding:e?.encoding});return nn({type:tt(t.type),senderPublicKey:typeof t.senderPublicKey<"u"?x(t.senderPublicKey,te):void 0,receiverPublicKey:e?.receiverPublicKey})}function nn(i){let e=i?.type||Jc;if(e===pt){if(typeof i?.senderPublicKey>"u")throw new Error("missing sender public key");if(typeof i?.receiverPublicKey>"u")throw new Error("missing receiver public key")}return{type:e,senderPublicKey:i?.senderPublicKey,receiverPublicKey:i?.receiverPublicKey}}function an(i){return i.type===pt&&typeof i.senderPublicKey=="string"&&typeof i.receiverPublicKey=="string"}function on(i){return i.type===_i}function Dg(i){return new qc.ec("p256").keyFromPublic({x:q.Buffer.from(i.x,"base64").toString("hex"),y:q.Buffer.from(i.y,"base64").toString("hex")},"hex")}function Lg(i){let e=i.replace(/-/g,"+").replace(/_/g,"/"),t=e.length%4;return t>0&&(e+="=".repeat(4-t)),e}function Ug(i){return q.Buffer.from(Lg(i),"base64")}function nh(i,e){let[t,s,r]=i.split("."),n=Ug(r);if(n.length!==64)throw new Error("Invalid signature length");let a=n.slice(0,32).toString("hex"),o=n.slice(32,64).toString("hex"),c=`${t}.${s}`,h=new At.SHA256().update(q.Buffer.from(c)).digest(),u=Dg(e),l=q.Buffer.from(h).toString("hex");if(!u.verify(l,{r:a,s:o}))throw new Error("Invalid signature");return Te(i).payload}var qg="irn";function Ri(i){return i?.relay||{protocol:qg}}function Dt(i){let e=Fs[i];if(typeof e>"u")throw new Error(`Relay Protocol not supported: ${i}`);return e}var $g=Object.defineProperty,kg=Object.defineProperties,jg=Object.getOwnPropertyDescriptors,Cc=Object.getOwnPropertySymbols,Mg=Object.prototype.hasOwnProperty,Vg=Object.prototype.propertyIsEnumerable,Fc=(i,e,t)=>e in i?$g(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,Dc=(i,e)=>{for(var t in e||(e={}))Mg.call(e,t)&&Fc(i,t,e[t]);if(Cc)for(var t of Cc(e))Vg.call(e,t)&&Fc(i,t,e[t]);return i},Kg=(i,e)=>kg(i,jg(e));function zg(i,e="-"){let t={},s="relay"+e;return Object.keys(i).forEach(r=>{if(r.startsWith(s)){let n=r.replace(s,""),a=i[r];t[n]=a}}),t}function cn(i){if(!i.includes("wc:")){let c=Gc(i);c!=null&&c.includes("wc:")&&(i=c)}i=i.includes("wc://")?i.replace("wc://",""):i,i=i.includes("wc:")?i.replace("wc:",""):i;let e=i.indexOf(":"),t=i.indexOf("?")!==-1?i.indexOf("?"):void 0,s=i.substring(0,e),r=i.substring(e+1,t).split("@"),n=typeof t<"u"?i.substring(t):"",a=xt.parse(n),o=typeof a.methods=="string"?a.methods.split(","):void 0;return{protocol:s,topic:Bg(r[0]),version:parseInt(r[1],10),symKey:a.symKey,relay:zg(a),methods:o,expiryTimestamp:a.expiryTimestamp?parseInt(a.expiryTimestamp,10):void 0}}function Bg(i){return i.startsWith("//")?i.substring(2):i}function Gg(i,e="-"){let t="relay",s={};return Object.keys(i).forEach(r=>{let n=t+e+r;i[r]&&(s[n]=i[r])}),s}function hn(i){return`${i.protocol}:${i.topic}@${i.version}?`+xt.stringify(Dc(Kg(Dc({symKey:i.symKey},Gg(i.relay)),{expiryTimestamp:i.expiryTimestamp}),i.methods?{methods:i.methods.join(",")}:{}))}var Hg={INVALID_METHOD:{message:"Invalid method.",code:1001},INVALID_EVENT:{message:"Invalid event.",code:1002},INVALID_UPDATE_REQUEST:{message:"Invalid update request.",code:1003},INVALID_EXTEND_REQUEST:{message:"Invalid extend request.",code:1004},INVALID_SESSION_SETTLE_REQUEST:{message:"Invalid session settle request.",code:1005},UNAUTHORIZED_METHOD:{message:"Unauthorized method.",code:3001},UNAUTHORIZED_EVENT:{message:"Unauthorized event.",code:3002},UNAUTHORIZED_UPDATE_REQUEST:{message:"Unauthorized update request.",code:3003},UNAUTHORIZED_EXTEND_REQUEST:{message:"Unauthorized extend request.",code:3004},USER_REJECTED:{message:"User rejected.",code:5e3},USER_REJECTED_CHAINS:{message:"User rejected chains.",code:5001},USER_REJECTED_METHODS:{message:"User rejected methods.",code:5002},USER_REJECTED_EVENTS:{message:"User rejected events.",code:5003},UNSUPPORTED_CHAINS:{message:"Unsupported chains.",code:5100},UNSUPPORTED_METHODS:{message:"Unsupported methods.",code:5101},UNSUPPORTED_EVENTS:{message:"Unsupported events.",code:5102},UNSUPPORTED_ACCOUNTS:{message:"Unsupported accounts.",code:5103},UNSUPPORTED_NAMESPACE_KEY:{message:"Unsupported namespace key.",code:5104},USER_DISCONNECTED:{message:"User disconnected.",code:6e3},SESSION_SETTLEMENT_FAILED:{message:"Session settlement failed.",code:7e3},WC_METHOD_UNSUPPORTED:{message:"Unsupported wc_ method.",code:10001}},Jg={NOT_INITIALIZED:{message:"Not initialized.",code:1},NO_MATCHING_KEY:{message:"No matching key.",code:2},RESTORE_WILL_OVERRIDE:{message:"Restore will override.",code:3},RESUBSCRIBED:{message:"Resubscribed.",code:4},MISSING_OR_INVALID:{message:"Missing or invalid.",code:5},EXPIRED:{message:"Expired.",code:6},UNKNOWN_TYPE:{message:"Unknown type.",code:7},MISMATCHED_TOPIC:{message:"Mismatched topic.",code:8},NON_CONFORMING_NAMESPACES:{message:"Non conforming namespaces.",code:9}};function A(i,e){let{message:t,code:s}=Jg[i];return{message:e?`${t} ${e}`:t,code:s}}function Lt(i,e){let{message:t,code:s}=Hg[i];return{message:e?`${t} ${e}`:t,code:s}}function ah(i,e){return Array.isArray(i)?typeof e<"u"&&i.length?i.every(e):!0:!1}function gs(i){return typeof i>"u"}function ln(i,e){return e&&gs(i)?!0:typeof i=="string"&&!!i.trim().length}function oh(i){function e(t){try{return typeof new URL(t)<"u"}catch{return!1}}try{if(ln(i,!1)){if(e(i))return!0;let t=Gc(i);return e(t)}}catch{}return!1}function ch(i){var e;return(e=i?.proposer)==null?void 0:e.publicKey}function hh(i){return i?.topic}function Ti(i){return typeof i<"u"&&typeof i!==null}function un(){let i=Ei();return new Promise(e=>{switch(i){case ye.browser:e(Yg());break;case ye.reactNative:e(Wg());break;case ye.node:e(Xg());break;default:e(!0)}})}function Yg(){return us()&&navigator?.onLine}async function Wg(){return ls()&&typeof globalThis<"u"&&globalThis!=null&&globalThis.NetInfo?(await globalThis?.NetInfo.fetch())?.isConnected:!0}function Xg(){return!0}function lh(i){switch(Ei()){case ye.browser:Qg(i);break;case ye.reactNative:Zg(i);break;case ye.node:break}}function Qg(i){!ls()&&us()&&(window.addEventListener("online",()=>i(!0)),window.addEventListener("offline",()=>i(!1)))}function Zg(i){ls()&&typeof globalThis<"u"&&globalThis!=null&&globalThis.NetInfo&&globalThis?.NetInfo.addEventListener(e=>i(e?.isConnected))}var Ch=O(ra()),Fh=O(Cs()),Dh="wc",Lh=2,qn="core",Le=`${Dh}@2:${qn}:`,ey={name:qn,logger:"error"},ty={database:":memory:"},sy="crypto",uh="client_ed25519_seed",iy=_.ONE_DAY,ry="keychain",ny="0.3",ay="messages",oy="0.3",cy=_.SIX_HOURS,hy="publisher",ly="irn",uy="error",Uh="wss://relay.walletconnect.org",py="relayer",le={message:"relayer_message",message_ack:"relayer_message_ack",connect:"relayer_connect",disconnect:"relayer_disconnect",error:"relayer_error",connection_stalled:"relayer_connection_stalled",transport_closed:"relayer_transport_closed",publish:"relayer_publish"},dy="_subscription",fe={payload:"payload",connect:"connect",disconnect:"disconnect",error:"error"},gy=.1;var gn="2.17.1";var Ut={link_mode:"link_mode",relay:"relay"},yy="0.3",fy="WALLETCONNECT_CLIENT_ID",ph="WALLETCONNECT_LINK_MODE_APPS",De={created:"subscription_created",deleted:"subscription_deleted",expired:"subscription_expired",disabled:"subscription_disabled",sync:"subscription_sync",resubscribed:"subscription_resubscribed"};var my="subscription",wy="0.3",by=_.FIVE_SECONDS*1e3,Ey="pairing",vy="0.3";var ys={wc_pairingDelete:{req:{ttl:_.ONE_DAY,prompt:!1,tag:1e3},res:{ttl:_.ONE_DAY,prompt:!1,tag:1001}},wc_pairingPing:{req:{ttl:_.THIRTY_SECONDS,prompt:!1,tag:1002},res:{ttl:_.THIRTY_SECONDS,prompt:!1,tag:1003}},unregistered_method:{req:{ttl:_.ONE_DAY,prompt:!1,tag:0},res:{ttl:_.ONE_DAY,prompt:!1,tag:0}}},fs={create:"pairing_create",expire:"pairing_expire",delete:"pairing_delete",ping:"pairing_ping"},Se={created:"history_created",updated:"history_updated",deleted:"history_deleted",sync:"history_sync"},_y="history",Iy="0.3",Sy="expirer",Re={created:"expirer_created",deleted:"expirer_deleted",expired:"expirer_expired",sync:"expirer_sync"},Ry="0.3";var Ty="verify-api",Oy="https://verify.walletconnect.com",qh="https://verify.walletconnect.org",Oi=qh,Py=`${Oi}/v3`,Ny=[Oy,qh],xy="echo",Ay="https://echo.walletconnect.com";var Ke={pairing_started:"pairing_started",pairing_uri_validation_success:"pairing_uri_validation_success",pairing_uri_not_expired:"pairing_uri_not_expired",store_new_pairing:"store_new_pairing",subscribing_pairing_topic:"subscribing_pairing_topic",subscribe_pairing_topic_success:"subscribe_pairing_topic_success",existing_pairing:"existing_pairing",pairing_not_expired:"pairing_not_expired",emit_inactive_pairing:"emit_inactive_pairing",emit_session_proposal:"emit_session_proposal",subscribing_to_pairing_topic:"subscribing_to_pairing_topic"},it={no_wss_connection:"no_wss_connection",no_internet_connection:"no_internet_connection",malformed_pairing_uri:"malformed_pairing_uri",active_pairing_already_exists:"active_pairing_already_exists",subscribe_pairing_topic_failure:"subscribe_pairing_topic_failure",pairing_expired:"pairing_expired",proposal_expired:"proposal_expired",proposal_listener_not_found:"proposal_listener_not_found"};var Cy=.1,Fy="event-client",Dy=86400,Ly="https://pulse.walletconnect.org/batch";function Uy(i,e){if(i.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),s=0;s<t.length;s++)t[s]=255;for(var r=0;r<i.length;r++){var n=i.charAt(r),a=n.charCodeAt(0);if(t[a]!==255)throw new TypeError(n+" is ambiguous");t[a]=r}var o=i.length,c=i.charAt(0),h=Math.log(o)/Math.log(256),u=Math.log(256)/Math.log(o);function l(p){if(p instanceof Uint8Array||(ArrayBuffer.isView(p)?p=new Uint8Array(p.buffer,p.byteOffset,p.byteLength):Array.isArray(p)&&(p=Uint8Array.from(p))),!(p instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(p.length===0)return"";for(var y=0,w=0,m=0,b=p.length;m!==b&&p[m]===0;)m++,y++;for(var P=(b-m)*u+1>>>0,E=new Uint8Array(P);m!==b;){for(var I=p[m],F=0,C=P-1;(I!==0||F<w)&&C!==-1;C--,F++)I+=256*E[C]>>>0,E[C]=I%o>>>0,I=I/o>>>0;if(I!==0)throw new Error("Non-zero carry");w=F,m++}for(var R=P-w;R!==P&&E[R]===0;)R++;for(var ue=c.repeat(y);R<P;++R)ue+=i.charAt(E[R]);return ue}function g(p){if(typeof p!="string")throw new TypeError("Expected String");if(p.length===0)return new Uint8Array;var y=0;if(p[y]!==" "){for(var w=0,m=0;p[y]===c;)w++,y++;for(var b=(p.length-y)*h+1>>>0,P=new Uint8Array(b);p[y];){var E=t[p.charCodeAt(y)];if(E===255)return;for(var I=0,F=b-1;(E!==0||I<m)&&F!==-1;F--,I++)E+=o*P[F]>>>0,P[F]=E%256>>>0,E=E/256>>>0;if(E!==0)throw new Error("Non-zero carry");m=I,y++}if(p[y]!==" "){for(var C=b-m;C!==b&&P[C]===0;)C++;for(var R=new Uint8Array(w+(b-C)),ue=w;C!==b;)R[ue++]=P[C++];return R}}}function d(p){var y=g(p);if(y)return y;throw new Error(`Non-${e} character`)}return{encode:l,decodeUnsafe:g,decode:d}}var qy=Uy,$y=qy,$h=i=>{if(i instanceof Uint8Array&&i.constructor.name==="Uint8Array")return i;if(i instanceof ArrayBuffer)return new Uint8Array(i);if(ArrayBuffer.isView(i))return new Uint8Array(i.buffer,i.byteOffset,i.byteLength);throw new Error("Unknown type, must be binary type")},ky=i=>new TextEncoder().encode(i),jy=i=>new TextDecoder().decode(i),yn=class{constructor(e,t,s){this.name=e,this.prefix=t,this.baseEncode=s}encode(e){if(e instanceof Uint8Array)return`${this.prefix}${this.baseEncode(e)}`;throw Error("Unknown type, must be binary type")}},fn=class{constructor(e,t,s){if(this.name=e,this.prefix=t,t.codePointAt(0)===void 0)throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=s}decode(e){if(typeof e=="string"){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error(`Unable to decode multibase string ${JSON.stringify(e)}, ${this.name} decoder only supports inputs prefixed with ${this.prefix}`);return this.baseDecode(e.slice(this.prefix.length))}else throw Error("Can only multibase decode strings")}or(e){return kh(this,e)}},mn=class{constructor(e){this.decoders=e}or(e){return kh(this,e)}decode(e){let t=e[0],s=this.decoders[t];if(s)return s.decode(e);throw RangeError(`Unable to decode multibase string ${JSON.stringify(e)}, only inputs prefixed with ${Object.keys(this.decoders)} are supported`)}},kh=(i,e)=>new mn({...i.decoders||{[i.prefix]:i},...e.decoders||{[e.prefix]:e}}),wn=class{constructor(e,t,s,r){this.name=e,this.prefix=t,this.baseEncode=s,this.baseDecode=r,this.encoder=new yn(e,t,s),this.decoder=new fn(e,t,r)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}},Pi=({name:i,prefix:e,encode:t,decode:s})=>new wn(i,e,t,s),Es=({prefix:i,name:e,alphabet:t})=>{let{encode:s,decode:r}=$y(t,e);return Pi({prefix:i,name:e,encode:s,decode:n=>$h(r(n))})},My=(i,e,t,s)=>{let r={};for(let u=0;u<e.length;++u)r[e[u]]=u;let n=i.length;for(;i[n-1]==="=";)--n;let a=new Uint8Array(n*t/8|0),o=0,c=0,h=0;for(let u=0;u<n;++u){let l=r[i[u]];if(l===void 0)throw new SyntaxError(`Non-${s} character`);c=c<<t|l,o+=t,o>=8&&(o-=8,a[h++]=255&c>>o)}if(o>=t||255&c<<8-o)throw new SyntaxError("Unexpected end of data");return a},Vy=(i,e,t)=>{let s=e[e.length-1]==="=",r=(1<<t)-1,n="",a=0,o=0;for(let c=0;c<i.length;++c)for(o=o<<8|i[c],a+=8;a>t;)a-=t,n+=e[r&o>>a];if(a&&(n+=e[r&o<<t-a]),s)for(;n.length*t&7;)n+="=";return n},X=({name:i,prefix:e,bitsPerChar:t,alphabet:s})=>Pi({prefix:e,name:i,encode(r){return Vy(r,s,t)},decode(r){return My(r,s,t,i)}}),Ky=Pi({prefix:"\0",name:"identity",encode:i=>jy(i),decode:i=>ky(i)}),zy=Object.freeze({__proto__:null,identity:Ky}),By=X({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),Gy=Object.freeze({__proto__:null,base2:By}),Hy=X({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),Jy=Object.freeze({__proto__:null,base8:Hy}),Yy=Es({prefix:"9",name:"base10",alphabet:"0123456789"}),Wy=Object.freeze({__proto__:null,base10:Yy}),Xy=X({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),Qy=X({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),Zy=Object.freeze({__proto__:null,base16:Xy,base16upper:Qy}),ef=X({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),tf=X({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),sf=X({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),rf=X({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),nf=X({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),af=X({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),of=X({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),cf=X({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),hf=X({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),lf=Object.freeze({__proto__:null,base32:ef,base32upper:tf,base32pad:sf,base32padupper:rf,base32hex:nf,base32hexupper:af,base32hexpad:of,base32hexpadupper:cf,base32z:hf}),uf=Es({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),pf=Es({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),df=Object.freeze({__proto__:null,base36:uf,base36upper:pf}),gf=Es({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),yf=Es({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),ff=Object.freeze({__proto__:null,base58btc:gf,base58flickr:yf}),mf=X({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),wf=X({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),bf=X({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),Ef=X({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),vf=Object.freeze({__proto__:null,base64:mf,base64pad:wf,base64url:bf,base64urlpad:Ef}),jh=Array.from("\u{1F680}\u{1FA90}\u2604\u{1F6F0}\u{1F30C}\u{1F311}\u{1F312}\u{1F313}\u{1F314}\u{1F315}\u{1F316}\u{1F317}\u{1F318}\u{1F30D}\u{1F30F}\u{1F30E}\u{1F409}\u2600\u{1F4BB}\u{1F5A5}\u{1F4BE}\u{1F4BF}\u{1F602}\u2764\u{1F60D}\u{1F923}\u{1F60A}\u{1F64F}\u{1F495}\u{1F62D}\u{1F618}\u{1F44D}\u{1F605}\u{1F44F}\u{1F601}\u{1F525}\u{1F970}\u{1F494}\u{1F496}\u{1F499}\u{1F622}\u{1F914}\u{1F606}\u{1F644}\u{1F4AA}\u{1F609}\u263A\u{1F44C}\u{1F917}\u{1F49C}\u{1F614}\u{1F60E}\u{1F607}\u{1F339}\u{1F926}\u{1F389}\u{1F49E}\u270C\u2728\u{1F937}\u{1F631}\u{1F60C}\u{1F338}\u{1F64C}\u{1F60B}\u{1F497}\u{1F49A}\u{1F60F}\u{1F49B}\u{1F642}\u{1F493}\u{1F929}\u{1F604}\u{1F600}\u{1F5A4}\u{1F603}\u{1F4AF}\u{1F648}\u{1F447}\u{1F3B6}\u{1F612}\u{1F92D}\u2763\u{1F61C}\u{1F48B}\u{1F440}\u{1F62A}\u{1F611}\u{1F4A5}\u{1F64B}\u{1F61E}\u{1F629}\u{1F621}\u{1F92A}\u{1F44A}\u{1F973}\u{1F625}\u{1F924}\u{1F449}\u{1F483}\u{1F633}\u270B\u{1F61A}\u{1F61D}\u{1F634}\u{1F31F}\u{1F62C}\u{1F643}\u{1F340}\u{1F337}\u{1F63B}\u{1F613}\u2B50\u2705\u{1F97A}\u{1F308}\u{1F608}\u{1F918}\u{1F4A6}\u2714\u{1F623}\u{1F3C3}\u{1F490}\u2639\u{1F38A}\u{1F498}\u{1F620}\u261D\u{1F615}\u{1F33A}\u{1F382}\u{1F33B}\u{1F610}\u{1F595}\u{1F49D}\u{1F64A}\u{1F639}\u{1F5E3}\u{1F4AB}\u{1F480}\u{1F451}\u{1F3B5}\u{1F91E}\u{1F61B}\u{1F534}\u{1F624}\u{1F33C}\u{1F62B}\u26BD\u{1F919}\u2615\u{1F3C6}\u{1F92B}\u{1F448}\u{1F62E}\u{1F646}\u{1F37B}\u{1F343}\u{1F436}\u{1F481}\u{1F632}\u{1F33F}\u{1F9E1}\u{1F381}\u26A1\u{1F31E}\u{1F388}\u274C\u270A\u{1F44B}\u{1F630}\u{1F928}\u{1F636}\u{1F91D}\u{1F6B6}\u{1F4B0}\u{1F353}\u{1F4A2}\u{1F91F}\u{1F641}\u{1F6A8}\u{1F4A8}\u{1F92C}\u2708\u{1F380}\u{1F37A}\u{1F913}\u{1F619}\u{1F49F}\u{1F331}\u{1F616}\u{1F476}\u{1F974}\u25B6\u27A1\u2753\u{1F48E}\u{1F4B8}\u2B07\u{1F628}\u{1F31A}\u{1F98B}\u{1F637}\u{1F57A}\u26A0\u{1F645}\u{1F61F}\u{1F635}\u{1F44E}\u{1F932}\u{1F920}\u{1F927}\u{1F4CC}\u{1F535}\u{1F485}\u{1F9D0}\u{1F43E}\u{1F352}\u{1F617}\u{1F911}\u{1F30A}\u{1F92F}\u{1F437}\u260E\u{1F4A7}\u{1F62F}\u{1F486}\u{1F446}\u{1F3A4}\u{1F647}\u{1F351}\u2744\u{1F334}\u{1F4A3}\u{1F438}\u{1F48C}\u{1F4CD}\u{1F940}\u{1F922}\u{1F445}\u{1F4A1}\u{1F4A9}\u{1F450}\u{1F4F8}\u{1F47B}\u{1F910}\u{1F92E}\u{1F3BC}\u{1F975}\u{1F6A9}\u{1F34E}\u{1F34A}\u{1F47C}\u{1F48D}\u{1F4E3}\u{1F942}"),_f=jh.reduce((i,e,t)=>(i[t]=e,i),[]),If=jh.reduce((i,e,t)=>(i[e.codePointAt(0)]=t,i),[]);function Sf(i){return i.reduce((e,t)=>(e+=_f[t],e),"")}function Rf(i){let e=[];for(let t of i){let s=If[t.codePointAt(0)];if(s===void 0)throw new Error(`Non-base256emoji character: ${t}`);e.push(s)}return new Uint8Array(e)}var Tf=Pi({prefix:"\u{1F680}",name:"base256emoji",encode:Sf,decode:Rf}),Of=Object.freeze({__proto__:null,base256emoji:Tf}),Pf=Mh,dh=128,Nf=127,xf=~Nf,Af=Math.pow(2,31);function Mh(i,e,t){e=e||[],t=t||0;for(var s=t;i>=Af;)e[t++]=i&255|dh,i/=128;for(;i&xf;)e[t++]=i&255|dh,i>>>=7;return e[t]=i|0,Mh.bytes=t-s+1,e}var Cf=bn,Ff=128,gh=127;function bn(i,s){var t=0,s=s||0,r=0,n=s,a,o=i.length;do{if(n>=o)throw bn.bytes=0,new RangeError("Could not decode varint");a=i[n++],t+=r<28?(a&gh)<<r:(a&gh)*Math.pow(2,r),r+=7}while(a>=Ff);return bn.bytes=n-s,t}var Df=Math.pow(2,7),Lf=Math.pow(2,14),Uf=Math.pow(2,21),qf=Math.pow(2,28),$f=Math.pow(2,35),kf=Math.pow(2,42),jf=Math.pow(2,49),Mf=Math.pow(2,56),Vf=Math.pow(2,63),Kf=function(i){return i<Df?1:i<Lf?2:i<Uf?3:i<qf?4:i<$f?5:i<kf?6:i<jf?7:i<Mf?8:i<Vf?9:10},zf={encode:Pf,decode:Cf,encodingLength:Kf},Vh=zf,yh=(i,e,t=0)=>(Vh.encode(i,e,t),e),fh=i=>Vh.encodingLength(i),En=(i,e)=>{let t=e.byteLength,s=fh(i),r=s+fh(t),n=new Uint8Array(r+t);return yh(i,n,0),yh(t,n,s),n.set(e,r),new vn(i,t,e,n)},vn=class{constructor(e,t,s,r){this.code=e,this.size=t,this.digest=s,this.bytes=r}},Kh=({name:i,code:e,encode:t})=>new _n(i,e,t),_n=class{constructor(e,t,s){this.name=e,this.code=t,this.encode=s}digest(e){if(e instanceof Uint8Array){let t=this.encode(e);return t instanceof Uint8Array?En(this.code,t):t.then(s=>En(this.code,s))}else throw Error("Unknown type, must be binary type")}},zh=i=>async e=>new Uint8Array(await crypto.subtle.digest(i,e)),Bf=Kh({name:"sha2-256",code:18,encode:zh("SHA-256")}),Gf=Kh({name:"sha2-512",code:19,encode:zh("SHA-512")}),Hf=Object.freeze({__proto__:null,sha256:Bf,sha512:Gf}),Bh=0,Jf="identity",Gh=$h,Yf=i=>En(Bh,Gh(i)),Wf={code:Bh,name:Jf,encode:Gh,digest:Yf},Xf=Object.freeze({__proto__:null,identity:Wf});new TextEncoder,new TextDecoder;var mh={...zy,...Gy,...Jy,...Wy,...Zy,...lf,...df,...ff,...vf,...Of};({...Hf,...Xf});function Qf(i=0){return globalThis.Buffer!=null&&globalThis.Buffer.allocUnsafe!=null?globalThis.Buffer.allocUnsafe(i):new Uint8Array(i)}function Hh(i,e,t,s){return{name:i,prefix:e,encoder:{name:i,prefix:e,encode:t},decoder:{decode:s}}}var wh=Hh("utf8","u",i=>"u"+new TextDecoder("utf8").decode(i),i=>new TextEncoder().encode(i.substring(1))),pn=Hh("ascii","a",i=>{let e="a";for(let t=0;t<i.length;t++)e+=String.fromCharCode(i[t]);return e},i=>{i=i.substring(1);let e=Qf(i.length);for(let t=0;t<i.length;t++)e[t]=i.charCodeAt(t);return e}),Zf={utf8:wh,"utf-8":wh,hex:mh.base16,latin1:pn,ascii:pn,binary:pn,...mh};function em(i,e="utf8"){let t=Zf[e];if(!t)throw new Error(`Unsupported encoding "${e}"`);return(e==="utf8"||e==="utf-8")&&globalThis.Buffer!=null&&globalThis.Buffer.from!=null?globalThis.Buffer.from(i,"utf8"):t.decoder.decode(`${t.prefix}${i}`)}var In=class{constructor(e,t){this.core=e,this.logger=t,this.keychain=new Map,this.name=ry,this.version=ny,this.initialized=!1,this.storagePrefix=Le,this.init=async()=>{if(!this.initialized){let s=await this.getKeyChain();typeof s<"u"&&(this.keychain=s),this.initialized=!0}},this.has=s=>(this.isInitialized(),this.keychain.has(s)),this.set=async(s,r)=>{this.isInitialized(),this.keychain.set(s,r),await this.persist()},this.get=s=>{this.isInitialized();let r=this.keychain.get(s);if(typeof r>"u"){let{message:n}=A("NO_MATCHING_KEY",`${this.name}: ${s}`);throw new Error(n)}return r},this.del=async s=>{this.isInitialized(),this.keychain.delete(s),await this.persist()},this.core=e,this.logger=N(t,this.name)}get context(){return D(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name}async setKeyChain(e){await this.core.storage.setItem(this.storageKey,Qr(e))}async getKeyChain(){let e=await this.core.storage.getItem(this.storageKey);return typeof e<"u"?Zr(e):void 0}async persist(){await this.setKeyChain(this.keychain)}isInitialized(){if(!this.initialized){let{message:e}=A("NOT_INITIALIZED",this.name);throw new Error(e)}}},Sn=class{constructor(e,t,s){this.core=e,this.logger=t,this.name=sy,this.randomSessionIdentifier=Ii(),this.initialized=!1,this.init=async()=>{this.initialized||(await this.keychain.init(),this.initialized=!0)},this.hasKeys=r=>(this.isInitialized(),this.keychain.has(r)),this.getClientId=async()=>{this.isInitialized();let r=await this.getClientSeed(),n=yt(r);return Ns(n.publicKey)},this.generateKeyPair=()=>{this.isInitialized();let r=Yc();return this.setPrivateKey(r.publicKey,r.privateKey)},this.signJWT=async r=>{this.isInitialized();let n=await this.getClientSeed(),a=yt(n),o=this.randomSessionIdentifier;return await xs(o,r,iy,a)},this.generateSharedKey=(r,n,a)=>{this.isInitialized();let o=this.getPrivateKey(r),c=Wc(o,n);return this.setSymKey(c,a)},this.setSymKey=async(r,n)=>{this.isInitialized();let a=n||Xc(r);return await this.keychain.set(a,r),a},this.deleteKeyPair=async r=>{this.isInitialized(),await this.keychain.del(r)},this.deleteSymKey=async r=>{this.isInitialized(),await this.keychain.del(r)},this.encode=async(r,n,a)=>{this.isInitialized();let o=nn(a),c=Ts(n);if(on(o))return eh(c,a?.encoding);if(an(o)){let g=o.senderPublicKey,d=o.receiverPublicKey;r=await this.generateSharedKey(g,d)}let h=this.getSymKey(r),{type:u,senderPublicKey:l}=o;return Zc({type:u,symKey:h,message:c,senderPublicKey:l,encoding:a?.encoding})},this.decode=async(r,n,a)=>{this.isInitialized();let o=rh(n,a);if(on(o)){let c=sh(n,a?.encoding);return dt(c)}if(an(o)){let c=o.receiverPublicKey,h=o.senderPublicKey;r=await this.generateSharedKey(c,h)}try{let c=this.getSymKey(r),h=th({symKey:c,encoded:n,encoding:a?.encoding});return dt(h)}catch(c){this.logger.error(`Failed to decode message from topic: '${r}', clientId: '${await this.getClientId()}'`),this.logger.error(c)}},this.getPayloadType=(r,n=ps)=>{let a=Ft({encoded:r,encoding:n});return tt(a.type)},this.getPayloadSenderPublicKey=(r,n=ps)=>{let a=Ft({encoded:r,encoding:n});return a.senderPublicKey?x(a.senderPublicKey,te):void 0},this.core=e,this.logger=N(t,this.name),this.keychain=s||new In(this.core,this.logger)}get context(){return D(this.logger)}async setPrivateKey(e,t){return await this.keychain.set(e,t),e}getPrivateKey(e){return this.keychain.get(e)}async getClientSeed(){let e="";try{e=this.keychain.get(uh)}catch{e=Ii(),await this.keychain.set(uh,e)}return em(e,"base16")}getSymKey(e){return this.keychain.get(e)}isInitialized(){if(!this.initialized){let{message:e}=A("NOT_INITIALIZED",this.name);throw new Error(e)}}},Rn=class extends li{constructor(e,t){super(e,t),this.logger=e,this.core=t,this.messages=new Map,this.name=ay,this.version=oy,this.initialized=!1,this.storagePrefix=Le,this.init=async()=>{if(!this.initialized){this.logger.trace("Initialized");try{let s=await this.getRelayerMessages();typeof s<"u"&&(this.messages=s),this.logger.debug(`Successfully Restored records for ${this.name}`),this.logger.trace({type:"method",method:"restore",size:this.messages.size})}catch(s){this.logger.debug(`Failed to Restore records for ${this.name}`),this.logger.error(s)}finally{this.initialized=!0}}},this.set=async(s,r)=>{this.isInitialized();let n=Si(r),a=this.messages.get(s);return typeof a>"u"&&(a={}),typeof a[n]<"u"||(a[n]=r,this.messages.set(s,a),await this.persist()),n},this.get=s=>{this.isInitialized();let r=this.messages.get(s);return typeof r>"u"&&(r={}),r},this.has=(s,r)=>{this.isInitialized();let n=this.get(s),a=Si(r);return typeof n[a]<"u"},this.del=async s=>{this.isInitialized(),this.messages.delete(s),await this.persist()},this.logger=N(e,this.name),this.core=t}get context(){return D(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name}async setRelayerMessages(e){await this.core.storage.setItem(this.storageKey,Qr(e))}async getRelayerMessages(){let e=await this.core.storage.getItem(this.storageKey);return typeof e<"u"?Zr(e):void 0}async persist(){await this.setRelayerMessages(this.messages)}isInitialized(){if(!this.initialized){let{message:e}=A("NOT_INITIALIZED",this.name);throw new Error(e)}}},Tn=class extends ui{constructor(e,t){super(e,t),this.relayer=e,this.logger=t,this.events=new ze.EventEmitter,this.name=hy,this.queue=new Map,this.publishTimeout=(0,_.toMiliseconds)(_.ONE_MINUTE),this.failedPublishTimeout=(0,_.toMiliseconds)(_.ONE_SECOND),this.needsTransportRestart=!1,this.publish=async(s,r,n)=>{var a;this.logger.debug("Publishing Payload"),this.logger.trace({type:"method",method:"publish",params:{topic:s,message:r,opts:n}});let o=n?.ttl||cy,c=Ri(n),h=n?.prompt||!1,u=n?.tag||0,l=n?.id||me().toString(),g={topic:s,message:r,opts:{ttl:o,relay:c,prompt:h,tag:u,id:l,attestation:n?.attestation}},d=`Failed to publish payload, please try again. id:${l} tag:${u}`,p=Date.now(),y,w=1;try{for(;y===void 0;){if(Date.now()-p>this.publishTimeout)throw new Error(d);this.logger.trace({id:l,attempts:w},`publisher.publish - attempt ${w}`),y=await await ut(this.rpcPublish(s,r,o,c,h,u,l,n?.attestation).catch(m=>this.logger.warn(m)),this.publishTimeout,d),w++,y||await new Promise(m=>setTimeout(m,this.failedPublishTimeout))}this.relayer.events.emit(le.publish,g),this.logger.debug("Successfully Published Payload"),this.logger.trace({type:"method",method:"publish",params:{id:l,topic:s,message:r,opts:n}})}catch(m){if(this.logger.debug("Failed to Publish Payload"),this.logger.error(m),(a=n?.internal)!=null&&a.throwOnFailedPublish)throw m;this.queue.set(l,g)}},this.on=(s,r)=>{this.events.on(s,r)},this.once=(s,r)=>{this.events.once(s,r)},this.off=(s,r)=>{this.events.off(s,r)},this.removeListener=(s,r)=>{this.events.removeListener(s,r)},this.relayer=e,this.logger=N(t,this.name),this.registerEventListeners()}get context(){return D(this.logger)}rpcPublish(e,t,s,r,n,a,o,c){var h,u,l,g;let d={method:Dt(r.protocol).publish,params:{topic:e,message:t,ttl:s,prompt:n,tag:a,attestation:c},id:o};return gs((h=d.params)==null?void 0:h.prompt)&&((u=d.params)==null||delete u.prompt),gs((l=d.params)==null?void 0:l.tag)&&((g=d.params)==null||delete g.tag),this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"message",direction:"outgoing",request:d}),this.relayer.request(d)}removeRequestFromQueue(e){this.queue.delete(e)}checkQueue(){this.queue.forEach(async e=>{let{topic:t,message:s,opts:r}=e;await this.publish(t,s,r)})}registerEventListeners(){this.relayer.core.heartbeat.on(pe.pulse,()=>{if(this.needsTransportRestart){this.needsTransportRestart=!1,this.relayer.events.emit(le.connection_stalled);return}this.checkQueue()}),this.relayer.on(le.message_ack,e=>{this.removeRequestFromQueue(e.id.toString())})}},On=class{constructor(){this.map=new Map,this.set=(e,t)=>{let s=this.get(e);this.exists(e,t)||this.map.set(e,[...s,t])},this.get=e=>this.map.get(e)||[],this.exists=(e,t)=>this.get(e).includes(t),this.delete=(e,t)=>{if(typeof t>"u"){this.map.delete(e);return}if(!this.map.has(e))return;let s=this.get(e);if(!this.exists(e,t))return;let r=s.filter(n=>n!==t);if(!r.length){this.map.delete(e);return}this.map.set(e,r)},this.clear=()=>{this.map.clear()}}get topics(){return Array.from(this.map.keys())}},tm=Object.defineProperty,sm=Object.defineProperties,im=Object.getOwnPropertyDescriptors,bh=Object.getOwnPropertySymbols,rm=Object.prototype.hasOwnProperty,nm=Object.prototype.propertyIsEnumerable,Eh=(i,e,t)=>e in i?tm(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,ms=(i,e)=>{for(var t in e||(e={}))rm.call(e,t)&&Eh(i,t,e[t]);if(bh)for(var t of bh(e))nm.call(e,t)&&Eh(i,t,e[t]);return i},dn=(i,e)=>sm(i,im(e)),Pn=class extends gi{constructor(e,t){super(e,t),this.relayer=e,this.logger=t,this.subscriptions=new Map,this.topicMap=new On,this.events=new ze.EventEmitter,this.name=my,this.version=wy,this.pending=new Map,this.cached=[],this.initialized=!1,this.pendingSubscriptionWatchLabel="pending_sub_watch_label",this.pollingInterval=20,this.storagePrefix=Le,this.subscribeTimeout=(0,_.toMiliseconds)(_.ONE_MINUTE),this.restartInProgress=!1,this.batchSubscribeTopicsLimit=500,this.pendingBatchMessages=[],this.init=async()=>{this.initialized||(this.logger.trace("Initialized"),this.registerEventListeners(),this.clientId=await this.relayer.core.crypto.getClientId(),await this.restore()),this.initialized=!0},this.subscribe=async(s,r)=>{this.isInitialized(),this.logger.debug("Subscribing Topic"),this.logger.trace({type:"method",method:"subscribe",params:{topic:s,opts:r}});try{let n=Ri(r),a={topic:s,relay:n,transportType:r?.transportType};this.pending.set(s,a);let o=await this.rpcSubscribe(s,n,r);return typeof o=="string"&&(this.onSubscribe(o,a),this.logger.debug("Successfully Subscribed Topic"),this.logger.trace({type:"method",method:"subscribe",params:{topic:s,opts:r}})),o}catch(n){throw this.logger.debug("Failed to Subscribe Topic"),this.logger.error(n),n}},this.unsubscribe=async(s,r)=>{await this.restartToComplete(),this.isInitialized(),typeof r?.id<"u"?await this.unsubscribeById(s,r.id,r):await this.unsubscribeByTopic(s,r)},this.isSubscribed=async s=>{if(this.topics.includes(s))return!0;let r=`${this.pendingSubscriptionWatchLabel}_${s}`;return await new Promise((n,a)=>{let o=new _.Watch;o.start(r);let c=setInterval(()=>{!this.pending.has(s)&&this.topics.includes(s)&&(clearInterval(c),o.stop(r),n(!0)),o.elapsed(r)>=by&&(clearInterval(c),o.stop(r),a(new Error("Subscription resolution timeout")))},this.pollingInterval)}).catch(()=>!1)},this.on=(s,r)=>{this.events.on(s,r)},this.once=(s,r)=>{this.events.once(s,r)},this.off=(s,r)=>{this.events.off(s,r)},this.removeListener=(s,r)=>{this.events.removeListener(s,r)},this.start=async()=>{await this.onConnect()},this.stop=async()=>{await this.onDisconnect()},this.restart=async()=>{this.restartInProgress=!0,await this.restore(),await this.reset(),this.restartInProgress=!1},this.relayer=e,this.logger=N(t,this.name),this.clientId=""}get context(){return D(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.relayer.core.customStoragePrefix+"//"+this.name}get length(){return this.subscriptions.size}get ids(){return Array.from(this.subscriptions.keys())}get values(){return Array.from(this.subscriptions.values())}get topics(){return this.topicMap.topics}hasSubscription(e,t){let s=!1;try{s=this.getSubscription(e).topic===t}catch{}return s}onEnable(){this.cached=[],this.initialized=!0}onDisable(){this.cached=this.values,this.subscriptions.clear(),this.topicMap.clear()}async unsubscribeByTopic(e,t){let s=this.topicMap.get(e);await Promise.all(s.map(async r=>await this.unsubscribeById(e,r,t)))}async unsubscribeById(e,t,s){this.logger.debug("Unsubscribing Topic"),this.logger.trace({type:"method",method:"unsubscribe",params:{topic:e,id:t,opts:s}});try{let r=Ri(s);await this.rpcUnsubscribe(e,t,r);let n=Lt("USER_DISCONNECTED",`${this.name}, ${e}`);await this.onUnsubscribe(e,t,n),this.logger.debug("Successfully Unsubscribed Topic"),this.logger.trace({type:"method",method:"unsubscribe",params:{topic:e,id:t,opts:s}})}catch(r){throw this.logger.debug("Failed to Unsubscribe Topic"),this.logger.error(r),r}}async rpcSubscribe(e,t,s){var r;s?.transportType===Ut.relay&&await this.restartToComplete();let n={method:Dt(t.protocol).subscribe,params:{topic:e}};this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"payload",direction:"outgoing",request:n});let a=(r=s?.internal)==null?void 0:r.throwOnFailedPublish;try{let o=Si(e+this.clientId);if(s?.transportType===Ut.link_mode)return setTimeout(()=>{(this.relayer.connected||this.relayer.connecting)&&this.relayer.request(n).catch(h=>this.logger.warn(h))},(0,_.toMiliseconds)(_.ONE_SECOND)),o;let c=await ut(this.relayer.request(n).catch(h=>this.logger.warn(h)),this.subscribeTimeout,`Subscribing to ${e} failed, please try again`);if(!c&&a)throw new Error(`Subscribing to ${e} failed, please try again`);return c?o:null}catch(o){if(this.logger.debug("Outgoing Relay Subscribe Payload stalled"),this.relayer.events.emit(le.connection_stalled),a)throw o}return null}async rpcBatchSubscribe(e){if(!e.length)return;let t=e[0].relay,s={method:Dt(t.protocol).batchSubscribe,params:{topics:e.map(r=>r.topic)}};this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"payload",direction:"outgoing",request:s});try{return await await ut(this.relayer.request(s).catch(r=>this.logger.warn(r)),this.subscribeTimeout)}catch{this.relayer.events.emit(le.connection_stalled)}}async rpcBatchFetchMessages(e){if(!e.length)return;let t=e[0].relay,s={method:Dt(t.protocol).batchFetchMessages,params:{topics:e.map(n=>n.topic)}};this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"payload",direction:"outgoing",request:s});let r;try{r=await await ut(this.relayer.request(s).catch(n=>this.logger.warn(n)),this.subscribeTimeout)}catch{this.relayer.events.emit(le.connection_stalled)}return r}rpcUnsubscribe(e,t,s){let r={method:Dt(s.protocol).unsubscribe,params:{topic:e,id:t}};return this.logger.debug("Outgoing Relay Payload"),this.logger.trace({type:"payload",direction:"outgoing",request:r}),this.relayer.request(r)}onSubscribe(e,t){this.setSubscription(e,dn(ms({},t),{id:e})),this.pending.delete(t.topic)}onBatchSubscribe(e){e.length&&e.forEach(t=>{this.setSubscription(t.id,ms({},t)),this.pending.delete(t.topic)})}async onUnsubscribe(e,t,s){this.events.removeAllListeners(t),this.hasSubscription(t,e)&&this.deleteSubscription(t,s),await this.relayer.messages.del(e)}async setRelayerSubscriptions(e){await this.relayer.core.storage.setItem(this.storageKey,e)}async getRelayerSubscriptions(){return await this.relayer.core.storage.getItem(this.storageKey)}setSubscription(e,t){this.logger.debug("Setting subscription"),this.logger.trace({type:"method",method:"setSubscription",id:e,subscription:t}),this.addSubscription(e,t)}addSubscription(e,t){this.subscriptions.set(e,ms({},t)),this.topicMap.set(t.topic,e),this.events.emit(De.created,t)}getSubscription(e){this.logger.debug("Getting subscription"),this.logger.trace({type:"method",method:"getSubscription",id:e});let t=this.subscriptions.get(e);if(!t){let{message:s}=A("NO_MATCHING_KEY",`${this.name}: ${e}`);throw new Error(s)}return t}deleteSubscription(e,t){this.logger.debug("Deleting subscription"),this.logger.trace({type:"method",method:"deleteSubscription",id:e,reason:t});let s=this.getSubscription(e);this.subscriptions.delete(e),this.topicMap.delete(s.topic,e),this.events.emit(De.deleted,dn(ms({},s),{reason:t}))}async persist(){await this.setRelayerSubscriptions(this.values),this.events.emit(De.sync)}async reset(){if(this.cached.length){let e=Math.ceil(this.cached.length/this.batchSubscribeTopicsLimit);for(let t=0;t<e;t++){let s=this.cached.splice(0,this.batchSubscribeTopicsLimit);await this.batchFetchMessages(s),await this.batchSubscribe(s)}}this.events.emit(De.resubscribed)}async restore(){try{let e=await this.getRelayerSubscriptions();if(typeof e>"u"||!e.length)return;if(this.subscriptions.size){let{message:t}=A("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(t),this.logger.error(`${this.name}: ${JSON.stringify(this.values)}`),new Error(t)}this.cached=e,this.logger.debug(`Successfully Restored subscriptions for ${this.name}`),this.logger.trace({type:"method",method:"restore",subscriptions:this.values})}catch(e){this.logger.debug(`Failed to Restore subscriptions for ${this.name}`),this.logger.error(e)}}async batchSubscribe(e){if(!e.length)return;let t=await this.rpcBatchSubscribe(e);ah(t)&&this.onBatchSubscribe(t.map((s,r)=>dn(ms({},e[r]),{id:s})))}async batchFetchMessages(e){if(!e.length)return;this.logger.trace(`Fetching batch messages for ${e.length} subscriptions`);let t=await this.rpcBatchFetchMessages(e);t&&t.messages&&(this.pendingBatchMessages=this.pendingBatchMessages.concat(t.messages))}async onConnect(){await this.restart(),this.onEnable()}onDisconnect(){this.onDisable()}async checkPending(){if(!this.initialized||!this.relayer.connected)return;let e=[];this.pending.forEach(t=>{e.push(t)}),await this.batchSubscribe(e),this.pendingBatchMessages.length&&(await this.relayer.handleBatchMessageEvents(this.pendingBatchMessages),this.pendingBatchMessages=[])}registerEventListeners(){this.relayer.core.heartbeat.on(pe.pulse,async()=>{await this.checkPending()}),this.events.on(De.created,async e=>{let t=De.created;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,data:e}),await this.persist()}),this.events.on(De.deleted,async e=>{let t=De.deleted;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,data:e}),await this.persist()})}isInitialized(){if(!this.initialized){let{message:e}=A("NOT_INITIALIZED",this.name);throw new Error(e)}}async restartToComplete(){!this.relayer.connected&&!this.relayer.connecting&&await this.relayer.transportOpen(),this.restartInProgress&&await new Promise(e=>{let t=setInterval(()=>{this.restartInProgress||(clearInterval(t),e())},this.pollingInterval)})}},am=Object.defineProperty,vh=Object.getOwnPropertySymbols,om=Object.prototype.hasOwnProperty,cm=Object.prototype.propertyIsEnumerable,_h=(i,e,t)=>e in i?am(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,Ih=(i,e)=>{for(var t in e||(e={}))om.call(e,t)&&_h(i,t,e[t]);if(vh)for(var t of vh(e))cm.call(e,t)&&_h(i,t,e[t]);return i},Nn=class extends pi{constructor(e){super(e),this.protocol="wc",this.version=2,this.events=new ze.EventEmitter,this.name=py,this.transportExplicitlyClosed=!1,this.initialized=!1,this.connectionAttemptInProgress=!1,this.connectionStatusPollingInterval=20,this.staleConnectionErrors=["socket hang up","stalled","interrupted"],this.hasExperiencedNetworkDisruption=!1,this.requestsInFlight=new Map,this.heartBeatTimeout=(0,_.toMiliseconds)(_.THIRTY_SECONDS+_.ONE_SECOND),this.request=async t=>{var s,r;this.logger.debug("Publishing Request Payload");let n=t.id||me().toString();await this.toEstablishConnection();try{let a=this.provider.request(t);this.requestsInFlight.set(n,{promise:a,request:t}),this.logger.trace({id:n,method:t.method,topic:(s=t.params)==null?void 0:s.topic},"relayer.request - attempt to publish...");let o=await new Promise(async(c,h)=>{let u=()=>{h(new Error(`relayer.request - publish interrupted, id: ${n}`))};this.provider.on(fe.disconnect,u);let l=await a;this.provider.off(fe.disconnect,u),c(l)});return this.logger.trace({id:n,method:t.method,topic:(r=t.params)==null?void 0:r.topic},"relayer.request - published"),o}catch(a){throw this.logger.debug(`Failed to Publish Request: ${n}`),a}finally{this.requestsInFlight.delete(n)}},this.resetPingTimeout=()=>{if(hs())try{clearTimeout(this.pingTimeout),this.pingTimeout=setTimeout(()=>{var t,s,r;(r=(s=(t=this.provider)==null?void 0:t.connection)==null?void 0:s.socket)==null||r.terminate()},this.heartBeatTimeout)}catch(t){this.logger.warn(t)}},this.onPayloadHandler=t=>{this.onProviderPayload(t),this.resetPingTimeout()},this.onConnectHandler=()=>{this.logger.trace("relayer connected"),this.startPingTimeout(),this.events.emit(le.connect)},this.onDisconnectHandler=()=>{this.logger.trace("relayer disconnected"),this.onProviderDisconnect()},this.onProviderErrorHandler=t=>{this.logger.error(t),this.events.emit(le.error,t),this.logger.info("Fatal socket error received, closing transport"),this.transportClose()},this.registerProviderListeners=()=>{this.provider.on(fe.payload,this.onPayloadHandler),this.provider.on(fe.connect,this.onConnectHandler),this.provider.on(fe.disconnect,this.onDisconnectHandler),this.provider.on(fe.error,this.onProviderErrorHandler)},this.core=e.core,this.logger=typeof e.logger<"u"&&typeof e.logger!="string"?N(e.logger,this.name):(0,gt.default)(Be({level:e.logger||uy})),this.messages=new Rn(this.logger,e.core),this.subscriber=new Pn(this,this.logger),this.publisher=new Tn(this,this.logger),this.relayUrl=e?.relayUrl||Uh,this.projectId=e.projectId,this.bundleId=$c(),this.provider={}}async init(){if(this.logger.trace("Initialized"),this.registerEventListeners(),await Promise.all([this.messages.init(),this.subscriber.init()]),this.initialized=!0,this.subscriber.cached.length>0)try{await this.transportOpen()}catch(e){this.logger.warn(e)}}get context(){return D(this.logger)}get connected(){var e,t,s;return((s=(t=(e=this.provider)==null?void 0:e.connection)==null?void 0:t.socket)==null?void 0:s.readyState)===1}get connecting(){var e,t,s;return((s=(t=(e=this.provider)==null?void 0:e.connection)==null?void 0:t.socket)==null?void 0:s.readyState)===0}async publish(e,t,s){this.isInitialized(),await this.publisher.publish(e,t,s),await this.recordMessageEvent({topic:e,message:t,publishedAt:Date.now(),transportType:Ut.relay})}async subscribe(e,t){var s,r,n;this.isInitialized(),t?.transportType==="relay"&&await this.toEstablishConnection();let a=typeof((s=t?.internal)==null?void 0:s.throwOnFailedPublish)>"u"?!0:(r=t?.internal)==null?void 0:r.throwOnFailedPublish,o=((n=this.subscriber.topicMap.get(e))==null?void 0:n[0])||"",c,h=u=>{u.topic===e&&(this.subscriber.off(De.created,h),c())};return await Promise.all([new Promise(u=>{c=u,this.subscriber.on(De.created,h)}),new Promise(async(u,l)=>{o=await this.subscriber.subscribe(e,Ih({internal:{throwOnFailedPublish:a}},t)).catch(g=>{a&&l(g)})||o,u()})]),o}async unsubscribe(e,t){this.isInitialized(),await this.subscriber.unsubscribe(e,t)}on(e,t){this.events.on(e,t)}once(e,t){this.events.once(e,t)}off(e,t){this.events.off(e,t)}removeListener(e,t){this.events.removeListener(e,t)}async transportDisconnect(){if(!this.hasExperiencedNetworkDisruption&&this.connected&&this.requestsInFlight.size>0)try{await Promise.all(Array.from(this.requestsInFlight.values()).map(e=>e.promise))}catch(e){this.logger.warn(e)}this.hasExperiencedNetworkDisruption||this.connected?await ut(this.provider.disconnect(),2e3,"provider.disconnect()").catch(()=>this.onProviderDisconnect()):this.onProviderDisconnect()}async transportClose(){this.transportExplicitlyClosed=!0,await this.transportDisconnect()}async transportOpen(e){await this.confirmOnlineStateOrThrow(),e&&e!==this.relayUrl&&(this.relayUrl=e,await this.transportDisconnect()),await this.createProvider(),this.connectionAttemptInProgress=!0,this.transportExplicitlyClosed=!1;try{await new Promise(async(t,s)=>{let r=()=>{this.provider.off(fe.disconnect,r),s(new Error("Connection interrupted while trying to subscribe"))};this.provider.on(fe.disconnect,r),await ut(this.provider.connect(),(0,_.toMiliseconds)(_.ONE_MINUTE),`Socket stalled when trying to connect to ${this.relayUrl}`).catch(n=>{s(n)}).finally(()=>{clearTimeout(this.reconnectTimeout),this.reconnectTimeout=void 0}),this.subscriber.start().catch(n=>{this.logger.error(n),this.onDisconnectHandler()}),this.hasExperiencedNetworkDisruption=!1,t()})}catch(t){this.logger.error(t);let s=t;if(this.hasExperiencedNetworkDisruption=!0,!this.isConnectionStalled(s.message))throw t}finally{this.connectionAttemptInProgress=!1}}async restartTransport(e){this.connectionAttemptInProgress||(this.relayUrl=e||this.relayUrl,await this.confirmOnlineStateOrThrow(),await this.transportClose(),await this.transportOpen())}async confirmOnlineStateOrThrow(){if(!await un())throw new Error("No internet connection detected. Please restart your network and try again.")}async handleBatchMessageEvents(e){if(e?.length===0){this.logger.trace("Batch message events is empty. Ignoring...");return}let t=e.sort((s,r)=>s.publishedAt-r.publishedAt);this.logger.trace(`Batch of ${t.length} message events sorted`);for(let s of t)try{await this.onMessageEvent(s)}catch(r){this.logger.warn(r)}this.logger.trace(`Batch of ${t.length} message events processed`)}async onLinkMessageEvent(e,t){let{topic:s}=e;if(!t.sessionExists){let r=Ct(_.FIVE_MINUTES),n={topic:s,expiry:r,relay:{protocol:"irn"},active:!1};await this.core.pairing.pairings.set(s,n)}this.events.emit(le.message,e),await this.recordMessageEvent(e)}startPingTimeout(){var e,t,s,r,n;if(hs())try{(t=(e=this.provider)==null?void 0:e.connection)!=null&&t.socket&&((n=(r=(s=this.provider)==null?void 0:s.connection)==null?void 0:r.socket)==null||n.once("ping",()=>{this.resetPingTimeout()})),this.resetPingTimeout()}catch(a){this.logger.warn(a)}}isConnectionStalled(e){return this.staleConnectionErrors.some(t=>e.includes(t))}async createProvider(){this.provider.connection&&this.unregisterProviderListeners();let e=await this.core.crypto.signJWT(this.relayUrl);this.provider=new Ds(new Ls(jc({sdkVersion:gn,protocol:this.protocol,version:this.version,relayUrl:this.relayUrl,projectId:this.projectId,auth:e,useOnCloseEvent:!0,bundleId:this.bundleId}))),this.registerProviderListeners()}async recordMessageEvent(e){let{topic:t,message:s}=e;await this.messages.set(t,s)}async shouldIgnoreMessageEvent(e){let{topic:t,message:s}=e;if(!s||s.length===0)return this.logger.debug(`Ignoring invalid/empty message: ${s}`),!0;if(!await this.subscriber.isSubscribed(t))return this.logger.debug(`Ignoring message for non-subscribed topic ${t}`),!0;let r=this.messages.has(t,s);return r&&this.logger.debug(`Ignoring duplicate message: ${s}`),r}async onProviderPayload(e){if(this.logger.debug("Incoming Relay Payload"),this.logger.trace({type:"payload",direction:"incoming",payload:e}),Je(e)){if(!e.method.endsWith(dy))return;let t=e.params,{topic:s,message:r,publishedAt:n,attestation:a}=t.data,o={topic:s,message:r,publishedAt:n,transportType:Ut.relay,attestation:a};this.logger.debug("Emitting Relayer Payload"),this.logger.trace(Ih({type:"event",event:t.id},o)),this.events.emit(t.id,o),await this.acknowledgePayload(e),await this.onMessageEvent(o)}else Ye(e)&&this.events.emit(le.message_ack,e)}async onMessageEvent(e){await this.shouldIgnoreMessageEvent(e)||(this.events.emit(le.message,e),await this.recordMessageEvent(e))}async acknowledgePayload(e){let t=He(e.id,!0);await this.provider.connection.send(t)}unregisterProviderListeners(){this.provider.off(fe.payload,this.onPayloadHandler),this.provider.off(fe.connect,this.onConnectHandler),this.provider.off(fe.disconnect,this.onDisconnectHandler),this.provider.off(fe.error,this.onProviderErrorHandler),clearTimeout(this.pingTimeout)}async registerEventListeners(){let e=await un();lh(async t=>{e!==t&&(e=t,t?await this.restartTransport().catch(s=>this.logger.error(s)):(this.hasExperiencedNetworkDisruption=!0,await this.transportDisconnect(),this.transportExplicitlyClosed=!1))})}async onProviderDisconnect(){await this.subscriber.stop(),this.requestsInFlight.clear(),clearTimeout(this.pingTimeout),this.events.emit(le.disconnect),this.connectionAttemptInProgress=!1,!this.transportExplicitlyClosed&&(this.reconnectTimeout||(this.reconnectTimeout=setTimeout(async()=>{await this.transportOpen().catch(e=>this.logger.error(e))},(0,_.toMiliseconds)(gy))))}isInitialized(){if(!this.initialized){let{message:e}=A("NOT_INITIALIZED",this.name);throw new Error(e)}}async toEstablishConnection(){await this.confirmOnlineStateOrThrow(),!this.connected&&(this.connectionAttemptInProgress&&await new Promise(e=>{let t=setInterval(()=>{this.connected&&(clearInterval(t),e())},this.connectionStatusPollingInterval)}),await this.transportOpen())}},hm=Object.defineProperty,Sh=Object.getOwnPropertySymbols,lm=Object.prototype.hasOwnProperty,um=Object.prototype.propertyIsEnumerable,Rh=(i,e,t)=>e in i?hm(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,Th=(i,e)=>{for(var t in e||(e={}))lm.call(e,t)&&Rh(i,t,e[t]);if(Sh)for(var t of Sh(e))um.call(e,t)&&Rh(i,t,e[t]);return i},xn=class extends di{constructor(e,t,s,r=Le,n=void 0){super(e,t,s,r),this.core=e,this.logger=t,this.name=s,this.map=new Map,this.version=yy,this.cached=[],this.initialized=!1,this.storagePrefix=Le,this.recentlyDeleted=[],this.recentlyDeletedLimit=200,this.init=async()=>{this.initialized||(this.logger.trace("Initialized"),await this.restore(),this.cached.forEach(a=>{this.getKey&&a!==null&&!gs(a)?this.map.set(this.getKey(a),a):ch(a)?this.map.set(a.id,a):hh(a)&&this.map.set(a.topic,a)}),this.cached=[],this.initialized=!0)},this.set=async(a,o)=>{this.isInitialized(),this.map.has(a)?await this.update(a,o):(this.logger.debug("Setting value"),this.logger.trace({type:"method",method:"set",key:a,value:o}),this.map.set(a,o),await this.persist())},this.get=a=>(this.isInitialized(),this.logger.debug("Getting value"),this.logger.trace({type:"method",method:"get",key:a}),this.getData(a)),this.getAll=a=>(this.isInitialized(),a?this.values.filter(o=>Object.keys(a).every(c=>(0,Ch.default)(o[c],a[c]))):this.values),this.update=async(a,o)=>{this.isInitialized(),this.logger.debug("Updating value"),this.logger.trace({type:"method",method:"update",key:a,update:o});let c=Th(Th({},this.getData(a)),o);this.map.set(a,c),await this.persist()},this.delete=async(a,o)=>{this.isInitialized(),this.map.has(a)&&(this.logger.debug("Deleting value"),this.logger.trace({type:"method",method:"delete",key:a,reason:o}),this.map.delete(a),this.addToRecentlyDeleted(a),await this.persist())},this.logger=N(t,this.name),this.storagePrefix=r,this.getKey=n}get context(){return D(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name}get length(){return this.map.size}get keys(){return Array.from(this.map.keys())}get values(){return Array.from(this.map.values())}addToRecentlyDeleted(e){this.recentlyDeleted.push(e),this.recentlyDeleted.length>=this.recentlyDeletedLimit&&this.recentlyDeleted.splice(0,this.recentlyDeletedLimit/2)}async setDataStore(e){await this.core.storage.setItem(this.storageKey,e)}async getDataStore(){return await this.core.storage.getItem(this.storageKey)}getData(e){let t=this.map.get(e);if(!t){if(this.recentlyDeleted.includes(e)){let{message:r}=A("MISSING_OR_INVALID",`Record was recently deleted - ${this.name}: ${e}`);throw this.logger.error(r),new Error(r)}let{message:s}=A("NO_MATCHING_KEY",`${this.name}: ${e}`);throw this.logger.error(s),new Error(s)}return t}async persist(){await this.setDataStore(this.values)}async restore(){try{let e=await this.getDataStore();if(typeof e>"u"||!e.length)return;if(this.map.size){let{message:t}=A("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(t),new Error(t)}this.cached=e,this.logger.debug(`Successfully Restored value for ${this.name}`),this.logger.trace({type:"method",method:"restore",value:this.values})}catch(e){this.logger.debug(`Failed to Restore value for ${this.name}`),this.logger.error(e)}}isInitialized(){if(!this.initialized){let{message:e}=A("NOT_INITIALIZED",this.name);throw new Error(e)}}},An=class{constructor(e,t){this.core=e,this.logger=t,this.name=Ey,this.version=vy,this.events=new ze.default,this.initialized=!1,this.storagePrefix=Le,this.ignoredPayloadTypes=[pt],this.registeredMethods=[],this.init=async()=>{this.initialized||(await this.pairings.init(),await this.cleanup(),this.registerRelayerEvents(),this.registerExpirerEvents(),this.initialized=!0,this.logger.trace("Initialized"))},this.register=({methods:s})=>{this.isInitialized(),this.registeredMethods=[...new Set([...this.registeredMethods,...s])]},this.create=async s=>{this.isInitialized();let r=Ii(),n=await this.core.crypto.setSymKey(r),a=Ct(_.FIVE_MINUTES),o={protocol:ly},c={topic:n,expiry:a,relay:o,active:!1,methods:s?.methods},h=hn({protocol:this.core.protocol,version:this.core.version,topic:n,symKey:r,relay:o,expiryTimestamp:a,methods:s?.methods});return this.events.emit(fs.create,c),this.core.expirer.set(n,a),await this.pairings.set(n,c),await this.core.relayer.subscribe(n,{transportType:s?.transportType}),{topic:n,uri:h}},this.pair=async s=>{this.isInitialized();let r=this.core.eventClient.createEvent({properties:{topic:s?.uri,trace:[Ke.pairing_started]}});this.isValidPair(s,r);let{topic:n,symKey:a,relay:o,expiryTimestamp:c,methods:h}=cn(s.uri);r.props.properties.topic=n,r.addTrace(Ke.pairing_uri_validation_success),r.addTrace(Ke.pairing_uri_not_expired);let u;if(this.pairings.keys.includes(n)){if(u=this.pairings.get(n),r.addTrace(Ke.existing_pairing),u.active)throw r.setError(it.active_pairing_already_exists),new Error(`Pairing already exists: ${n}. Please try again with a new connection URI.`);r.addTrace(Ke.pairing_not_expired)}let l=c||Ct(_.FIVE_MINUTES),g={topic:n,relay:o,expiry:l,active:!1,methods:h};this.core.expirer.set(n,l),await this.pairings.set(n,g),r.addTrace(Ke.store_new_pairing),s.activatePairing&&await this.activate({topic:n}),this.events.emit(fs.create,g),r.addTrace(Ke.emit_inactive_pairing),this.core.crypto.keychain.has(n)||await this.core.crypto.setSymKey(a,n),r.addTrace(Ke.subscribing_pairing_topic);try{await this.core.relayer.confirmOnlineStateOrThrow()}catch{r.setError(it.no_internet_connection)}try{await this.core.relayer.subscribe(n,{relay:o})}catch(d){throw r.setError(it.subscribe_pairing_topic_failure),d}return r.addTrace(Ke.subscribe_pairing_topic_success),g},this.activate=async({topic:s})=>{this.isInitialized();let r=Ct(_.THIRTY_DAYS);this.core.expirer.set(s,r),await this.pairings.update(s,{active:!0,expiry:r})},this.ping=async s=>{this.isInitialized(),await this.isValidPing(s);let{topic:r}=s;if(this.pairings.keys.includes(r)){let n=await this.sendRequest(r,"wc_pairingPing",{}),{done:a,resolve:o,reject:c}=Mc();this.events.once(vi("pairing_ping",n),({error:h})=>{h?c(h):o()}),await a()}},this.updateExpiry=async({topic:s,expiry:r})=>{this.isInitialized(),await this.pairings.update(s,{expiry:r})},this.updateMetadata=async({topic:s,metadata:r})=>{this.isInitialized(),await this.pairings.update(s,{peerMetadata:r})},this.getPairings=()=>(this.isInitialized(),this.pairings.values),this.disconnect=async s=>{this.isInitialized(),await this.isValidDisconnect(s);let{topic:r}=s;this.pairings.keys.includes(r)&&(await this.sendRequest(r,"wc_pairingDelete",Lt("USER_DISCONNECTED")),await this.deletePairing(r))},this.formatUriFromPairing=s=>{this.isInitialized();let{topic:r,relay:n,expiry:a,methods:o}=s,c=this.core.crypto.keychain.get(r);return hn({protocol:this.core.protocol,version:this.core.version,topic:r,symKey:c,relay:n,expiryTimestamp:a,methods:o})},this.sendRequest=async(s,r,n)=>{let a=we(r,n),o=await this.core.crypto.encode(s,a),c=ys[r].req;return this.core.history.set(s,a),this.core.relayer.publish(s,o,c),a.id},this.sendResult=async(s,r,n)=>{let a=He(s,n),o=await this.core.crypto.encode(r,a),c=await this.core.history.get(r,s),h=ys[c.request.method].res;await this.core.relayer.publish(r,o,h),await this.core.history.resolve(a)},this.sendError=async(s,r,n)=>{let a=ft(s,n),o=await this.core.crypto.encode(r,a),c=await this.core.history.get(r,s),h=ys[c.request.method]?ys[c.request.method].res:ys.unregistered_method.res;await this.core.relayer.publish(r,o,h),await this.core.history.resolve(a)},this.deletePairing=async(s,r)=>{await this.core.relayer.unsubscribe(s),await Promise.all([this.pairings.delete(s,Lt("USER_DISCONNECTED")),this.core.crypto.deleteSymKey(s),r?Promise.resolve():this.core.expirer.del(s)])},this.cleanup=async()=>{let s=this.pairings.getAll().filter(r=>en(r.expiry));await Promise.all(s.map(r=>this.deletePairing(r.topic)))},this.onRelayEventRequest=s=>{let{topic:r,payload:n}=s;switch(n.method){case"wc_pairingPing":return this.onPairingPingRequest(r,n);case"wc_pairingDelete":return this.onPairingDeleteRequest(r,n);default:return this.onUnknownRpcMethodRequest(r,n)}},this.onRelayEventResponse=async s=>{let{topic:r,payload:n}=s,a=(await this.core.history.get(r,n.id)).request.method;switch(a){case"wc_pairingPing":return this.onPairingPingResponse(r,n);default:return this.onUnknownRpcMethodResponse(a)}},this.onPairingPingRequest=async(s,r)=>{let{id:n}=r;try{this.isValidPing({topic:s}),await this.sendResult(n,s,!0),this.events.emit(fs.ping,{id:n,topic:s})}catch(a){await this.sendError(n,s,a),this.logger.error(a)}},this.onPairingPingResponse=(s,r)=>{let{id:n}=r;setTimeout(()=>{ce(r)?this.events.emit(vi("pairing_ping",n),{}):se(r)&&this.events.emit(vi("pairing_ping",n),{error:r.error})},500)},this.onPairingDeleteRequest=async(s,r)=>{let{id:n}=r;try{this.isValidDisconnect({topic:s}),await this.deletePairing(s),this.events.emit(fs.delete,{id:n,topic:s})}catch(a){await this.sendError(n,s,a),this.logger.error(a)}},this.onUnknownRpcMethodRequest=async(s,r)=>{let{id:n,method:a}=r;try{if(this.registeredMethods.includes(a))return;let o=Lt("WC_METHOD_UNSUPPORTED",a);await this.sendError(n,s,o),this.logger.error(o)}catch(o){await this.sendError(n,s,o),this.logger.error(o)}},this.onUnknownRpcMethodResponse=s=>{this.registeredMethods.includes(s)||this.logger.error(Lt("WC_METHOD_UNSUPPORTED",s))},this.isValidPair=(s,r)=>{var n;if(!Ti(s)){let{message:o}=A("MISSING_OR_INVALID",`pair() params: ${s}`);throw r.setError(it.malformed_pairing_uri),new Error(o)}if(!oh(s.uri)){let{message:o}=A("MISSING_OR_INVALID",`pair() uri: ${s.uri}`);throw r.setError(it.malformed_pairing_uri),new Error(o)}let a=cn(s?.uri);if(!((n=a?.relay)!=null&&n.protocol)){let{message:o}=A("MISSING_OR_INVALID","pair() uri#relay-protocol");throw r.setError(it.malformed_pairing_uri),new Error(o)}if(!(a!=null&&a.symKey)){let{message:o}=A("MISSING_OR_INVALID","pair() uri#symKey");throw r.setError(it.malformed_pairing_uri),new Error(o)}if(a!=null&&a.expiryTimestamp&&(0,_.toMiliseconds)(a?.expiryTimestamp)<Date.now()){r.setError(it.pairing_expired);let{message:o}=A("EXPIRED","pair() URI has expired. Please try again with a new connection URI.");throw new Error(o)}},this.isValidPing=async s=>{if(!Ti(s)){let{message:n}=A("MISSING_OR_INVALID",`ping() params: ${s}`);throw new Error(n)}let{topic:r}=s;await this.isValidPairingTopic(r)},this.isValidDisconnect=async s=>{if(!Ti(s)){let{message:n}=A("MISSING_OR_INVALID",`disconnect() params: ${s}`);throw new Error(n)}let{topic:r}=s;await this.isValidPairingTopic(r)},this.isValidPairingTopic=async s=>{if(!ln(s,!1)){let{message:r}=A("MISSING_OR_INVALID",`pairing topic should be a string: ${s}`);throw new Error(r)}if(!this.pairings.keys.includes(s)){let{message:r}=A("NO_MATCHING_KEY",`pairing topic doesn't exist: ${s}`);throw new Error(r)}if(en(this.pairings.get(s).expiry)){await this.deletePairing(s);let{message:r}=A("EXPIRED",`pairing topic: ${s}`);throw new Error(r)}},this.core=e,this.logger=N(t,this.name),this.pairings=new xn(this.core,this.logger,this.name,this.storagePrefix)}get context(){return D(this.logger)}isInitialized(){if(!this.initialized){let{message:e}=A("NOT_INITIALIZED",this.name);throw new Error(e)}}registerRelayerEvents(){this.core.relayer.on(le.message,async e=>{let{topic:t,message:s,transportType:r}=e;if(!this.pairings.keys.includes(t)||r===Ut.link_mode||this.ignoredPayloadTypes.includes(this.core.crypto.getPayloadType(s)))return;let n=await this.core.crypto.decode(t,s);try{Je(n)?(this.core.history.set(t,n),this.onRelayEventRequest({topic:t,payload:n})):Ye(n)&&(await this.core.history.resolve(n),await this.onRelayEventResponse({topic:t,payload:n}),this.core.history.delete(t,n.id))}catch(a){this.logger.error(a)}})}registerExpirerEvents(){this.core.expirer.on(Re.expired,async e=>{let{topic:t}=Bc(e.target);t&&this.pairings.keys.includes(t)&&(await this.deletePairing(t,!0),this.events.emit(fs.expire,{topic:t}))})}},Cn=class extends hi{constructor(e,t){super(e,t),this.core=e,this.logger=t,this.records=new Map,this.events=new ze.EventEmitter,this.name=_y,this.version=Iy,this.cached=[],this.initialized=!1,this.storagePrefix=Le,this.init=async()=>{this.initialized||(this.logger.trace("Initialized"),await this.restore(),this.cached.forEach(s=>this.records.set(s.id,s)),this.cached=[],this.registerEventListeners(),this.initialized=!0)},this.set=(s,r,n)=>{if(this.isInitialized(),this.logger.debug("Setting JSON-RPC request history record"),this.logger.trace({type:"method",method:"set",topic:s,request:r,chainId:n}),this.records.has(r.id))return;let a={id:r.id,topic:s,request:{method:r.method,params:r.params||null},chainId:n,expiry:Ct(_.THIRTY_DAYS)};this.records.set(a.id,a),this.persist(),this.events.emit(Se.created,a)},this.resolve=async s=>{if(this.isInitialized(),this.logger.debug("Updating JSON-RPC response history record"),this.logger.trace({type:"method",method:"update",response:s}),!this.records.has(s.id))return;let r=await this.getRecord(s.id);typeof r.response>"u"&&(r.response=se(s)?{error:s.error}:{result:s.result},this.records.set(r.id,r),this.persist(),this.events.emit(Se.updated,r))},this.get=async(s,r)=>(this.isInitialized(),this.logger.debug("Getting record"),this.logger.trace({type:"method",method:"get",topic:s,id:r}),await this.getRecord(r)),this.delete=(s,r)=>{this.isInitialized(),this.logger.debug("Deleting record"),this.logger.trace({type:"method",method:"delete",id:r}),this.values.forEach(n=>{if(n.topic===s){if(typeof r<"u"&&n.id!==r)return;this.records.delete(n.id),this.events.emit(Se.deleted,n)}}),this.persist()},this.exists=async(s,r)=>(this.isInitialized(),this.records.has(r)?(await this.getRecord(r)).topic===s:!1),this.on=(s,r)=>{this.events.on(s,r)},this.once=(s,r)=>{this.events.once(s,r)},this.off=(s,r)=>{this.events.off(s,r)},this.removeListener=(s,r)=>{this.events.removeListener(s,r)},this.logger=N(t,this.name)}get context(){return D(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name}get size(){return this.records.size}get keys(){return Array.from(this.records.keys())}get values(){return Array.from(this.records.values())}get pending(){let e=[];return this.values.forEach(t=>{if(typeof t.response<"u")return;let s={topic:t.topic,request:we(t.request.method,t.request.params,t.id),chainId:t.chainId};return e.push(s)}),e}async setJsonRpcRecords(e){await this.core.storage.setItem(this.storageKey,e)}async getJsonRpcRecords(){return await this.core.storage.getItem(this.storageKey)}getRecord(e){this.isInitialized();let t=this.records.get(e);if(!t){let{message:s}=A("NO_MATCHING_KEY",`${this.name}: ${e}`);throw new Error(s)}return t}async persist(){await this.setJsonRpcRecords(this.values),this.events.emit(Se.sync)}async restore(){try{let e=await this.getJsonRpcRecords();if(typeof e>"u"||!e.length)return;if(this.records.size){let{message:t}=A("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(t),new Error(t)}this.cached=e,this.logger.debug(`Successfully Restored records for ${this.name}`),this.logger.trace({type:"method",method:"restore",records:this.values})}catch(e){this.logger.debug(`Failed to Restore records for ${this.name}`),this.logger.error(e)}}registerEventListeners(){this.events.on(Se.created,e=>{let t=Se.created;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,record:e})}),this.events.on(Se.updated,e=>{let t=Se.updated;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,record:e})}),this.events.on(Se.deleted,e=>{let t=Se.deleted;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,record:e})}),this.core.heartbeat.on(pe.pulse,()=>{this.cleanup()})}cleanup(){try{this.isInitialized();let e=!1;this.records.forEach(t=>{(0,_.toMiliseconds)(t.expiry||0)-Date.now()<=0&&(this.logger.info(`Deleting expired history log: ${t.id}`),this.records.delete(t.id),this.events.emit(Se.deleted,t,!1),e=!0)}),e&&this.persist()}catch(e){this.logger.warn(e)}}isInitialized(){if(!this.initialized){let{message:e}=A("NOT_INITIALIZED",this.name);throw new Error(e)}}},Fn=class extends yi{constructor(e,t){super(e,t),this.core=e,this.logger=t,this.expirations=new Map,this.events=new ze.EventEmitter,this.name=Sy,this.version=Ry,this.cached=[],this.initialized=!1,this.storagePrefix=Le,this.init=async()=>{this.initialized||(this.logger.trace("Initialized"),await this.restore(),this.cached.forEach(s=>this.expirations.set(s.target,s)),this.cached=[],this.registerEventListeners(),this.initialized=!0)},this.has=s=>{try{let r=this.formatTarget(s);return typeof this.getExpiration(r)<"u"}catch{return!1}},this.set=(s,r)=>{this.isInitialized();let n=this.formatTarget(s),a={target:n,expiry:r};this.expirations.set(n,a),this.checkExpiry(n,a),this.events.emit(Re.created,{target:n,expiration:a})},this.get=s=>{this.isInitialized();let r=this.formatTarget(s);return this.getExpiration(r)},this.del=s=>{if(this.isInitialized(),this.has(s)){let r=this.formatTarget(s),n=this.getExpiration(r);this.expirations.delete(r),this.events.emit(Re.deleted,{target:r,expiration:n})}},this.on=(s,r)=>{this.events.on(s,r)},this.once=(s,r)=>{this.events.once(s,r)},this.off=(s,r)=>{this.events.off(s,r)},this.removeListener=(s,r)=>{this.events.removeListener(s,r)},this.logger=N(t,this.name)}get context(){return D(this.logger)}get storageKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//"+this.name}get length(){return this.expirations.size}get keys(){return Array.from(this.expirations.keys())}get values(){return Array.from(this.expirations.values())}formatTarget(e){if(typeof e=="string")return Kc(e);if(typeof e=="number")return zc(e);let{message:t}=A("UNKNOWN_TYPE",`Target type: ${typeof e}`);throw new Error(t)}async setExpirations(e){await this.core.storage.setItem(this.storageKey,e)}async getExpirations(){return await this.core.storage.getItem(this.storageKey)}async persist(){await this.setExpirations(this.values),this.events.emit(Re.sync)}async restore(){try{let e=await this.getExpirations();if(typeof e>"u"||!e.length)return;if(this.expirations.size){let{message:t}=A("RESTORE_WILL_OVERRIDE",this.name);throw this.logger.error(t),new Error(t)}this.cached=e,this.logger.debug(`Successfully Restored expirations for ${this.name}`),this.logger.trace({type:"method",method:"restore",expirations:this.values})}catch(e){this.logger.debug(`Failed to Restore expirations for ${this.name}`),this.logger.error(e)}}getExpiration(e){let t=this.expirations.get(e);if(!t){let{message:s}=A("NO_MATCHING_KEY",`${this.name}: ${e}`);throw this.logger.warn(s),new Error(s)}return t}checkExpiry(e,t){let{expiry:s}=t;(0,_.toMiliseconds)(s)-Date.now()<=0&&this.expire(e,t)}expire(e,t){this.expirations.delete(e),this.events.emit(Re.expired,{target:e,expiration:t})}checkExpirations(){this.core.relayer.connected&&this.expirations.forEach((e,t)=>this.checkExpiry(t,e))}registerEventListeners(){this.core.heartbeat.on(pe.pulse,()=>this.checkExpirations()),this.events.on(Re.created,e=>{let t=Re.created;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,data:e}),this.persist()}),this.events.on(Re.expired,e=>{let t=Re.expired;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,data:e}),this.persist()}),this.events.on(Re.deleted,e=>{let t=Re.deleted;this.logger.info(`Emitting ${t}`),this.logger.debug({type:"event",event:t,data:e}),this.persist()})}isInitialized(){if(!this.initialized){let{message:e}=A("NOT_INITIALIZED",this.name);throw new Error(e)}}},Dn=class extends fi{constructor(e,t,s){super(e,t,s),this.core=e,this.logger=t,this.store=s,this.name=Ty,this.verifyUrlV3=Py,this.storagePrefix=Le,this.version=Lh,this.init=async()=>{var r;this.isDevEnv||(this.publicKey=await this.store.getItem(this.storeKey),this.publicKey&&(0,_.toMiliseconds)((r=this.publicKey)==null?void 0:r.expiresAt)<Date.now()&&(this.logger.debug("verify v2 public key expired"),await this.removePublicKey()))},this.register=async r=>{if(!us()||this.isDevEnv)return;let n=window.location.origin,{id:a,decryptedId:o}=r,c=`${this.verifyUrlV3}/attestation?projectId=${this.core.projectId}&origin=${n}&id=${a}&decryptedId=${o}`;try{let h=(0,Fh.getDocument)(),u=this.startAbortTimer(_.ONE_SECOND*5),l=await new Promise((g,d)=>{let p=()=>{window.removeEventListener("message",w),h.body.removeChild(y),d("attestation aborted")};this.abortController.signal.addEventListener("abort",p);let y=h.createElement("iframe");y.src=c,y.style.display="none",y.addEventListener("error",p,{signal:this.abortController.signal});let w=m=>{if(m.data&&typeof m.data=="string")try{let b=JSON.parse(m.data);if(b.type==="verify_attestation"){if(Te(b.attestation).payload.id!==a)return;clearInterval(u),h.body.removeChild(y),this.abortController.signal.removeEventListener("abort",p),window.removeEventListener("message",w),g(b.attestation===null?"":b.attestation)}}catch(b){this.logger.warn(b)}};h.body.appendChild(y),window.addEventListener("message",w,{signal:this.abortController.signal})});return this.logger.debug("jwt attestation",l),l}catch(h){this.logger.warn(h)}return""},this.resolve=async r=>{if(this.isDevEnv)return"";let{attestationId:n,hash:a,encryptedId:o}=r;if(n===""){this.logger.debug("resolve: attestationId is empty, skipping");return}if(n){if(Te(n).payload.id!==o)return;let h=await this.isValidJwtAttestation(n);if(h){if(!h.isVerified){this.logger.warn("resolve: jwt attestation: origin url not verified");return}return h}}if(!a)return;let c=this.getVerifyUrl(r?.verifyUrl);return this.fetchAttestation(a,c)},this.fetchAttestation=async(r,n)=>{this.logger.debug(`resolving attestation: ${r} from url: ${n}`);let a=this.startAbortTimer(_.ONE_SECOND*5),o=await fetch(`${n}/attestation/${r}?v2Supported=true`,{signal:this.abortController.signal});return clearTimeout(a),o.status===200?await o.json():void 0},this.getVerifyUrl=r=>{let n=r||Oi;return Ny.includes(n)||(this.logger.info(`verify url: ${n}, not included in trusted list, assigning default: ${Oi}`),n=Oi),n},this.fetchPublicKey=async()=>{try{this.logger.debug(`fetching public key from: ${this.verifyUrlV3}`);let r=this.startAbortTimer(_.FIVE_SECONDS),n=await fetch(`${this.verifyUrlV3}/public-key`,{signal:this.abortController.signal});return clearTimeout(r),await n.json()}catch(r){this.logger.warn(r)}},this.persistPublicKey=async r=>{this.logger.debug("persisting public key to local storage",r),await this.store.setItem(this.storeKey,r),this.publicKey=r},this.removePublicKey=async()=>{this.logger.debug("removing verify v2 public key from storage"),await this.store.removeItem(this.storeKey),this.publicKey=void 0},this.isValidJwtAttestation=async r=>{let n=await this.getPublicKey();try{if(n)return this.validateAttestation(r,n)}catch(o){this.logger.error(o),this.logger.warn("error validating attestation")}let a=await this.fetchAndPersistPublicKey();try{if(a)return this.validateAttestation(r,a)}catch(o){this.logger.error(o),this.logger.warn("error validating attestation")}},this.getPublicKey=async()=>this.publicKey?this.publicKey:await this.fetchAndPersistPublicKey(),this.fetchAndPersistPublicKey=async()=>{if(this.fetchPromise)return await this.fetchPromise,this.publicKey;this.fetchPromise=new Promise(async n=>{let a=await this.fetchPublicKey();a&&(await this.persistPublicKey(a),n(a))});let r=await this.fetchPromise;return this.fetchPromise=void 0,r},this.validateAttestation=(r,n)=>{let a=nh(r,n.publicKey),o={hasExpired:(0,_.toMiliseconds)(a.exp)<Date.now(),payload:a};if(o.hasExpired)throw this.logger.warn("resolve: jwt attestation expired"),new Error("JWT attestation expired");return{origin:o.payload.origin,isScam:o.payload.isScam,isVerified:o.payload.isVerified}},this.logger=N(t,this.name),this.abortController=new AbortController,this.isDevEnv=sn(),this.init()}get storeKey(){return this.storagePrefix+this.version+this.core.customStoragePrefix+"//verify:public:key"}get context(){return D(this.logger)}startAbortTimer(e){return this.abortController=new AbortController,setTimeout(()=>this.abortController.abort(),(0,_.toMiliseconds)(e))}},Ln=class extends mi{constructor(e,t){super(e,t),this.projectId=e,this.logger=t,this.context=xy,this.registerDeviceToken=async s=>{let{clientId:r,token:n,notificationType:a,enableEncrypted:o=!1}=s,c=`${Ay}/${this.projectId}/clients`;await fetch(c,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({client_id:r,type:a,token:n,always_raw:o})})},this.logger=N(t,this.context)}},pm=Object.defineProperty,Oh=Object.getOwnPropertySymbols,dm=Object.prototype.hasOwnProperty,gm=Object.prototype.propertyIsEnumerable,Ph=(i,e,t)=>e in i?pm(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,ws=(i,e)=>{for(var t in e||(e={}))dm.call(e,t)&&Ph(i,t,e[t]);if(Oh)for(var t of Oh(e))gm.call(e,t)&&Ph(i,t,e[t]);return i},Un=class extends wi{constructor(e,t,s=!0){super(e,t,s),this.core=e,this.logger=t,this.context=Fy,this.storagePrefix=Le,this.storageVersion=Cy,this.events=new Map,this.shouldPersist=!1,this.init=async()=>{if(!sn())try{let r={eventId:tn(),timestamp:Date.now(),domain:this.getAppDomain(),props:{event:"INIT",type:"",properties:{client_id:await this.core.crypto.getClientId(),user_agent:Xr(this.core.relayer.protocol,this.core.relayer.version,gn)}}};await this.sendEvent([r])}catch(r){this.logger.warn(r)}},this.createEvent=r=>{let{event:n="ERROR",type:a="",properties:{topic:o,trace:c}}=r,h=tn(),u=this.core.projectId||"",l=Date.now(),g=ws({eventId:h,timestamp:l,props:{event:n,type:a,properties:{topic:o,trace:c}},bundleId:u,domain:this.getAppDomain()},this.setMethods(h));return this.telemetryEnabled&&(this.events.set(h,g),this.shouldPersist=!0),g},this.getEvent=r=>{let{eventId:n,topic:a}=r;if(n)return this.events.get(n);let o=Array.from(this.events.values()).find(c=>c.props.properties.topic===a);if(o)return ws(ws({},o),this.setMethods(o.eventId))},this.deleteEvent=r=>{let{eventId:n}=r;this.events.delete(n),this.shouldPersist=!0},this.setEventListeners=()=>{this.core.heartbeat.on(pe.pulse,async()=>{this.shouldPersist&&await this.persist(),this.events.forEach(r=>{(0,_.fromMiliseconds)(Date.now())-(0,_.fromMiliseconds)(r.timestamp)>Dy&&(this.events.delete(r.eventId),this.shouldPersist=!0)})})},this.setMethods=r=>({addTrace:n=>this.addTrace(r,n),setError:n=>this.setError(r,n)}),this.addTrace=(r,n)=>{let a=this.events.get(r);a&&(a.props.properties.trace.push(n),this.events.set(r,a),this.shouldPersist=!0)},this.setError=(r,n)=>{let a=this.events.get(r);a&&(a.props.type=n,a.timestamp=Date.now(),this.events.set(r,a),this.shouldPersist=!0)},this.persist=async()=>{await this.core.storage.setItem(this.storageKey,Array.from(this.events.values())),this.shouldPersist=!1},this.restore=async()=>{try{let r=await this.core.storage.getItem(this.storageKey)||[];if(!r.length)return;r.forEach(n=>{this.events.set(n.eventId,ws(ws({},n),this.setMethods(n.eventId)))})}catch(r){this.logger.warn(r)}},this.submit=async()=>{if(!this.telemetryEnabled||this.events.size===0)return;let r=[];for(let[n,a]of this.events)a.props.type&&r.push(a);if(r.length!==0)try{if((await this.sendEvent(r)).ok)for(let n of r)this.events.delete(n.eventId),this.shouldPersist=!0}catch(n){this.logger.warn(n)}},this.sendEvent=async r=>{let n=this.getAppDomain()?"":"&sp=desktop";return await fetch(`${Ly}?projectId=${this.core.projectId}&st=events_sdk&sv=js-${gn}${n}`,{method:"POST",body:JSON.stringify(r)})},this.getAppDomain=()=>kc().url,this.logger=N(t,this.context),this.telemetryEnabled=s,s?this.restore().then(async()=>{await this.submit(),this.setEventListeners()}):this.persist()}get storageKey(){return this.storagePrefix+this.storageVersion+this.core.customStoragePrefix+"//"+this.context}},ym=Object.defineProperty,Nh=Object.getOwnPropertySymbols,fm=Object.prototype.hasOwnProperty,mm=Object.prototype.propertyIsEnumerable,xh=(i,e,t)=>e in i?ym(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,Ah=(i,e)=>{for(var t in e||(e={}))fm.call(e,t)&&xh(i,t,e[t]);if(Nh)for(var t of Nh(e))mm.call(e,t)&&xh(i,t,e[t]);return i},bs=class extends ci{constructor(e){var t;super(e),this.protocol=Dh,this.version=Lh,this.name=qn,this.events=new ze.EventEmitter,this.initialized=!1,this.on=(a,o)=>this.events.on(a,o),this.once=(a,o)=>this.events.once(a,o),this.off=(a,o)=>this.events.off(a,o),this.removeListener=(a,o)=>this.events.removeListener(a,o),this.dispatchEnvelope=({topic:a,message:o,sessionExists:c})=>{if(!a||!o)return;let h={topic:a,message:o,publishedAt:Date.now(),transportType:Ut.link_mode};this.relayer.onLinkMessageEvent(h,{sessionExists:c})},this.projectId=e?.projectId,this.relayUrl=e?.relayUrl||Uh,this.customStoragePrefix=e!=null&&e.customStoragePrefix?`:${e.customStoragePrefix}`:"";let s=Be({level:typeof e?.logger=="string"&&e.logger?e.logger:ey.logger}),{logger:r,chunkLoggerController:n}=Ps({opts:s,maxSizeInBytes:e?.maxLogBlobSizeInBytes,loggerOverride:e?.logger});this.logChunkController=n,(t=this.logChunkController)!=null&&t.downloadLogsBlobInBrowser&&(window.downloadLogsBlobInBrowser=async()=>{var a,o;(a=this.logChunkController)!=null&&a.downloadLogsBlobInBrowser&&((o=this.logChunkController)==null||o.downloadLogsBlobInBrowser({clientId:await this.crypto.getClientId()}))}),this.logger=N(r,this.name),this.heartbeat=new Rs,this.crypto=new Sn(this,this.logger,e?.keychain),this.history=new Cn(this,this.logger),this.expirer=new Fn(this,this.logger),this.storage=e!=null&&e.storage?e.storage:new Os(Ah(Ah({},ty),e?.storageOptions)),this.relayer=new Nn({core:this,logger:this.logger,relayUrl:this.relayUrl,projectId:this.projectId}),this.pairing=new An(this,this.logger),this.verify=new Dn(this,this.logger,this.storage),this.echoClient=new Ln(this.projectId||"",this.logger),this.linkModeSupportedApps=[],this.eventClient=new Un(this,this.logger,e?.telemetryEnabled)}static async init(e){let t=new bs(e);await t.initialize();let s=await t.crypto.getClientId();return await t.storage.setItem(fy,s),t}get context(){return D(this.logger)}async start(){this.initialized||await this.initialize()}async getLogsBlob(){var e;return(e=this.logChunkController)==null?void 0:e.logsToBlob({clientId:await this.crypto.getClientId()})}async addLinkModeSupportedApp(e){this.linkModeSupportedApps.includes(e)||(this.linkModeSupportedApps.push(e),await this.storage.setItem(ph,this.linkModeSupportedApps))}async initialize(){this.logger.trace("Initialized");try{await this.crypto.init(),await this.history.init(),await this.expirer.init(),await this.relayer.init(),await this.heartbeat.init(),await this.pairing.init(),this.eventClient.init(),this.linkModeSupportedApps=await this.storage.getItem(ph)||[],this.initialized=!0,this.logger.info("Core Initialization Success")}catch(e){throw this.logger.warn(`Core Initialization Failure at epoch ${Date.now()}`,e),this.logger.error(e.message),e}}},$n=bs;var Ai={exports:{}},qt=typeof Reflect=="object"?Reflect:null,Jh=qt&&typeof qt.apply=="function"?qt.apply:function(i,e,t){return Function.prototype.apply.call(i,e,t)},Ni;qt&&typeof qt.ownKeys=="function"?Ni=qt.ownKeys:Object.getOwnPropertySymbols?Ni=function(i){return Object.getOwnPropertyNames(i).concat(Object.getOwnPropertySymbols(i))}:Ni=function(i){return Object.getOwnPropertyNames(i)};function wm(i){console&&console.warn&&console.warn(i)}var Yh=Number.isNaN||function(i){return i!==i};function U(){U.init.call(this)}Ai.exports=U,Ai.exports.once=_m,U.EventEmitter=U,U.prototype._events=void 0,U.prototype._eventsCount=0,U.prototype._maxListeners=void 0;var Wh=10;function xi(i){if(typeof i!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof i)}Object.defineProperty(U,"defaultMaxListeners",{enumerable:!0,get:function(){return Wh},set:function(i){if(typeof i!="number"||i<0||Yh(i))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+i+".");Wh=i}}),U.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},U.prototype.setMaxListeners=function(i){if(typeof i!="number"||i<0||Yh(i))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+i+".");return this._maxListeners=i,this};function rl(i){return i._maxListeners===void 0?U.defaultMaxListeners:i._maxListeners}U.prototype.getMaxListeners=function(){return rl(this)},U.prototype.emit=function(i){for(var e=[],t=1;t<arguments.length;t++)e.push(arguments[t]);var s=i==="error",r=this._events;if(r!==void 0)s=s&&r.error===void 0;else if(!s)return!1;if(s){var n;if(e.length>0&&(n=e[0]),n instanceof Error)throw n;var a=new Error("Unhandled error."+(n?" ("+n.message+")":""));throw a.context=n,a}var o=r[i];if(o===void 0)return!1;if(typeof o=="function")Jh(o,this,e);else for(var c=o.length,h=nl(o,c),t=0;t<c;++t)Jh(h[t],this,e);return!0};function Xh(i,e,t,s){var r,n,a;if(xi(t),n=i._events,n===void 0?(n=i._events=Object.create(null),i._eventsCount=0):(n.newListener!==void 0&&(i.emit("newListener",e,t.listener?t.listener:t),n=i._events),a=n[e]),a===void 0)a=n[e]=t,++i._eventsCount;else if(typeof a=="function"?a=n[e]=s?[t,a]:[a,t]:s?a.unshift(t):a.push(t),r=rl(i),r>0&&a.length>r&&!a.warned){a.warned=!0;var o=new Error("Possible EventEmitter memory leak detected. "+a.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");o.name="MaxListenersExceededWarning",o.emitter=i,o.type=e,o.count=a.length,wm(o)}return i}U.prototype.addListener=function(i,e){return Xh(this,i,e,!1)},U.prototype.on=U.prototype.addListener,U.prototype.prependListener=function(i,e){return Xh(this,i,e,!0)};function bm(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function Qh(i,e,t){var s={fired:!1,wrapFn:void 0,target:i,type:e,listener:t},r=bm.bind(s);return r.listener=t,s.wrapFn=r,r}U.prototype.once=function(i,e){return xi(e),this.on(i,Qh(this,i,e)),this},U.prototype.prependOnceListener=function(i,e){return xi(e),this.prependListener(i,Qh(this,i,e)),this},U.prototype.removeListener=function(i,e){var t,s,r,n,a;if(xi(e),s=this._events,s===void 0)return this;if(t=s[i],t===void 0)return this;if(t===e||t.listener===e)--this._eventsCount===0?this._events=Object.create(null):(delete s[i],s.removeListener&&this.emit("removeListener",i,t.listener||e));else if(typeof t!="function"){for(r=-1,n=t.length-1;n>=0;n--)if(t[n]===e||t[n].listener===e){a=t[n].listener,r=n;break}if(r<0)return this;r===0?t.shift():Em(t,r),t.length===1&&(s[i]=t[0]),s.removeListener!==void 0&&this.emit("removeListener",i,a||e)}return this},U.prototype.off=U.prototype.removeListener,U.prototype.removeAllListeners=function(i){var e,t,s;if(t=this._events,t===void 0)return this;if(t.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):t[i]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete t[i]),this;if(arguments.length===0){var r=Object.keys(t),n;for(s=0;s<r.length;++s)n=r[s],n!=="removeListener"&&this.removeAllListeners(n);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(e=t[i],typeof e=="function")this.removeListener(i,e);else if(e!==void 0)for(s=e.length-1;s>=0;s--)this.removeListener(i,e[s]);return this};function Zh(i,e,t){var s=i._events;if(s===void 0)return[];var r=s[e];return r===void 0?[]:typeof r=="function"?t?[r.listener||r]:[r]:t?vm(r):nl(r,r.length)}U.prototype.listeners=function(i){return Zh(this,i,!0)},U.prototype.rawListeners=function(i){return Zh(this,i,!1)},U.listenerCount=function(i,e){return typeof i.listenerCount=="function"?i.listenerCount(e):el.call(i,e)},U.prototype.listenerCount=el;function el(i){var e=this._events;if(e!==void 0){var t=e[i];if(typeof t=="function")return 1;if(t!==void 0)return t.length}return 0}U.prototype.eventNames=function(){return this._eventsCount>0?Ni(this._events):[]};function nl(i,e){for(var t=new Array(e),s=0;s<e;++s)t[s]=i[s];return t}function Em(i,e){for(;e+1<i.length;e++)i[e]=i[e+1];i.pop()}function vm(i){for(var e=new Array(i.length),t=0;t<e.length;++t)e[t]=i[t].listener||i[t];return e}function _m(i,e){return new Promise(function(t,s){function r(a){i.removeListener(e,n),s(a)}function n(){typeof i.removeListener=="function"&&i.removeListener("error",r),t([].slice.call(arguments))}al(i,e,n,{once:!0}),e!=="error"&&Im(i,r,{once:!0})})}function Im(i,e,t){typeof i.on=="function"&&al(i,"error",e,t)}function al(i,e,t,s){if(typeof i.on=="function")s.once?i.once(e,t):i.on(e,t);else if(typeof i.addEventListener=="function")i.addEventListener(e,function r(n){s.once&&i.removeEventListener(e,r),t(n)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof i)}var Sm="wc",Xw=2,ol="WalletKit",Qw=`${Sm}@2:${ol}:`,Zw={database:":memory:"},eb="request",tl=class extends Ai.exports{constructor(){super()}},kn=class{constructor(e){this.opts=e}},jn=class{constructor(e){this.client=e}},Rm=Object.defineProperty,Tm=Object.defineProperties,Om=Object.getOwnPropertyDescriptors,sl=Object.getOwnPropertySymbols,Pm=Object.prototype.hasOwnProperty,Nm=Object.prototype.propertyIsEnumerable,il=(i,e,t)=>e in i?Rm(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,xm=(i,e)=>{for(var t in e||(e={}))Pm.call(e,t)&&il(i,t,e[t]);if(sl)for(var t of sl(e))Nm.call(e,t)&&il(i,t,e[t]);return i},Am=(i,e)=>Tm(i,Om(e)),Mn=class extends jn{constructor(e){super(e),this.init=async()=>{this.signClient=await dc.init({core:this.client.core,metadata:this.client.metadata,signConfig:this.client.signConfig})},this.pair=async t=>{await this.client.core.pairing.pair(t)},this.approveSession=async t=>{let{topic:s,acknowledged:r}=await this.signClient.approve(Am(xm({},t),{id:t.id,namespaces:t.namespaces,sessionProperties:t.sessionProperties,sessionConfig:t.sessionConfig}));return await r(),this.signClient.session.get(s)},this.rejectSession=async t=>await this.signClient.reject(t),this.updateSession=async t=>await this.signClient.update(t),this.extendSession=async t=>await this.signClient.extend(t),this.respondSessionRequest=async t=>await this.signClient.respond(t),this.disconnectSession=async t=>await this.signClient.disconnect(t),this.emitSessionEvent=async t=>await this.signClient.emit(t),this.getActiveSessions=()=>this.signClient.session.getAll().reduce((t,s)=>(t[s.topic]=s,t),{}),this.getPendingSessionProposals=()=>this.signClient.proposal.getAll(),this.getPendingSessionRequests=()=>this.signClient.getPendingSessionRequests(),this.approveSessionAuthenticate=async t=>await this.signClient.approveSessionAuthenticate(t),this.rejectSessionAuthenticate=async t=>await this.signClient.rejectSessionAuthenticate(t),this.formatAuthMessage=t=>this.signClient.formatAuthMessage(t),this.registerDeviceToken=t=>this.client.core.echoClient.registerDeviceToken(t),this.on=(t,s)=>(this.setEvent(t,"off"),this.setEvent(t,"on"),this.client.events.on(t,s)),this.once=(t,s)=>(this.setEvent(t,"off"),this.setEvent(t,"once"),this.client.events.once(t,s)),this.off=(t,s)=>(this.setEvent(t,"off"),this.client.events.off(t,s)),this.removeListener=(t,s)=>(this.setEvent(t,"removeListener"),this.client.events.removeListener(t,s)),this.onSessionRequest=t=>{this.client.events.emit("session_request",t)},this.onSessionProposal=t=>{this.client.events.emit("session_proposal",t)},this.onSessionDelete=t=>{this.client.events.emit("session_delete",t)},this.onProposalExpire=t=>{this.client.events.emit("proposal_expire",t)},this.onSessionRequestExpire=t=>{this.client.events.emit("session_request_expire",t)},this.onSessionRequestAuthenticate=t=>{this.client.events.emit("session_authenticate",t)},this.setEvent=(t,s)=>{switch(t){case"session_request":this.signClient.events[s]("session_request",this.onSessionRequest);break;case"session_proposal":this.signClient.events[s]("session_proposal",this.onSessionProposal);break;case"session_delete":this.signClient.events[s]("session_delete",this.onSessionDelete);break;case"proposal_expire":this.signClient.events[s]("proposal_expire",this.onProposalExpire);break;case"session_request_expire":this.signClient.events[s]("session_request_expire",this.onSessionRequestExpire);break;case"session_authenticate":this.signClient.events[s]("session_authenticate",this.onSessionRequestAuthenticate);break}},this.signClient={}}},Cm={decryptMessage:async i=>{let e={core:new $n({storageOptions:i.storageOptions,storage:i.storage})};await e.core.crypto.init();let t=e.core.crypto.decode(i.topic,i.encryptedMessage);return e.core=null,t},getMetadata:async i=>{let e={core:new $n({storageOptions:i.storageOptions,storage:i.storage}),sessionStore:null};e.sessionStore=new pc(e.core,e.core.logger),await e.sessionStore.init();let t=e.sessionStore.get(i.topic),s=t?.peer.metadata;return e.core=null,e.sessionStore=null,s}},cl=class extends kn{constructor(i){super(i),this.events=new Ai.exports,this.on=(e,t)=>this.engine.on(e,t),this.once=(e,t)=>this.engine.once(e,t),this.off=(e,t)=>this.engine.off(e,t),this.removeListener=(e,t)=>this.engine.removeListener(e,t),this.pair=async e=>{try{return await this.engine.pair(e)}catch(t){throw this.logger.error(t.message),t}},this.approveSession=async e=>{try{return await this.engine.approveSession(e)}catch(t){throw this.logger.error(t.message),t}},this.rejectSession=async e=>{try{return await this.engine.rejectSession(e)}catch(t){throw this.logger.error(t.message),t}},this.updateSession=async e=>{try{return await this.engine.updateSession(e)}catch(t){throw this.logger.error(t.message),t}},this.extendSession=async e=>{try{return await this.engine.extendSession(e)}catch(t){throw this.logger.error(t.message),t}},this.respondSessionRequest=async e=>{try{return await this.engine.respondSessionRequest(e)}catch(t){throw this.logger.error(t.message),t}},this.disconnectSession=async e=>{try{return await this.engine.disconnectSession(e)}catch(t){throw this.logger.error(t.message),t}},this.emitSessionEvent=async e=>{try{return await this.engine.emitSessionEvent(e)}catch(t){throw this.logger.error(t.message),t}},this.getActiveSessions=()=>{try{return this.engine.getActiveSessions()}catch(e){throw this.logger.error(e.message),e}},this.getPendingSessionProposals=()=>{try{return this.engine.getPendingSessionProposals()}catch(e){throw this.logger.error(e.message),e}},this.getPendingSessionRequests=()=>{try{return this.engine.getPendingSessionRequests()}catch(e){throw this.logger.error(e.message),e}},this.registerDeviceToken=e=>{try{return this.engine.registerDeviceToken(e)}catch(t){throw this.logger.error(t.message),t}},this.approveSessionAuthenticate=e=>{try{return this.engine.approveSessionAuthenticate(e)}catch(t){throw this.logger.error(t.message),t}},this.rejectSessionAuthenticate=e=>{try{return this.engine.rejectSessionAuthenticate(e)}catch(t){throw this.logger.error(t.message),t}},this.formatAuthMessage=e=>{try{return this.engine.formatAuthMessage(e)}catch(t){throw this.logger.error(t.message),t}},this.metadata=i.metadata,this.name=i.name||ol,this.signConfig=i.signConfig,this.core=i.core,this.logger=this.core.logger,this.engine=new Mn(this)}static async init(i){let e=new cl(i);return await e.initialize(),e}async initialize(){this.logger.trace("Initialized");try{await this.engine.init(),this.logger.info("WalletKit Initialization Success")}catch(i){throw this.logger.info("WalletKit Initialization Failure"),this.logger.error(i.message),i}}},hl=cl;hl.notifications=Cm;var tb=hl;export{ol as CLIENT_CONTEXT,Zw as CLIENT_STORAGE_OPTIONS,Qw as CLIENT_STORAGE_PREFIX,kn as IWalletKit,jn as IWalletKitEngine,tl as IWalletKitEvents,Sm as PROTOCOL,Xw as PROTOCOL_VERSION,eb as REQUEST_CONTEXT,tb as WalletKit,hl as default};

window.inOKXExtension = true;
window.inMiniApp = false;
window.ASSETS_BUILD_TYPE = "publish";

//# sourceMappingURL=index.es-PI7LNE7A.js.map
